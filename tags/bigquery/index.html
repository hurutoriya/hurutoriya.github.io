<!doctype html><html lang=ja dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>bigquery | ğŸ¦… hurutoriya</title><meta name=keywords content><meta name=description content="Shunya Ueta's blog"><meta name=author content="Shunya Ueta"><link rel=canonical href=https://shunyaueta.com/tags/bigquery/><link crossorigin=anonymous href=/assets/css/stylesheet.abc7c82c3d415a6df50430738d1cbcc4c76fea558bc5a0c830d3babf78167a35.css integrity="sha256-q8fILD1BWm31BDBzjRy8xMdv6lWLxaDIMNO6v3gWejU=" rel="preload stylesheet" as=style><link rel=icon href=https://shunyaueta.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://shunyaueta.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://shunyaueta.com/favicon-32x32.png><link rel=apple-touch-icon href=https://shunyaueta.com/apple-touch-icon.png><link rel=mask-icon href=https://shunyaueta.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://shunyaueta.com/tags/bigquery/index.xml><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme: rgb(29, 30, 32);--entry: rgb(46, 46, 51);--primary: rgb(218, 218, 219);--secondary: rgb(155, 156, 157);--tertiary: rgb(65, 66, 68);--content: rgb(196, 196, 197);--hljs-bg: rgb(46, 46, 51);--code-bg: rgb(55, 56, 62);--border: rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-39994406-11','auto');ga('send','pageview');}</script><meta property="og:title" content="bigquery"><meta property="og:description" content="Shunya Ueta's blog"><meta property="og:type" content="website"><meta property="og:url" content="https://shunyaueta.com/tags/bigquery/"><meta property="og:image" content="https://shunyaueta.com/ogp.jpg"><meta property="og:site_name" content="Shunya Ueta"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://shunyaueta.com/ogp.jpg"><meta name=twitter:title content="bigquery"><meta name=twitter:description content="Shunya Ueta's blog"></head><body class=list id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><header class=header><nav class=nav><div class=logo><a href=https://shunyaueta.com/ accesskey=h title="ğŸ¦… hurutoriya (Alt + H)">ğŸ¦… hurutoriya</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://shunyaueta.com/archives title=Archive><span>Archive</span></a></li><li><a href=https://shunyaueta.com/about title=About><span>About</span></a></li><li><a href=https://shunyaueta.com/tags/newsletter/ title=Newsletter><span>Newsletter</span></a></li><li><a href=https://shunyaueta.com/index.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><header class=page-header><h1>bigquery</h1></header><article class="post-entry tag-entry"><figure class=entry-cover><img loading=lazy src=https://shunyaueta.com/posts/2022-01-20/images/1.png alt="bqutil.fn.typeof() ã®å®Ÿè¡Œçµæœ"></figure><header class=entry-header><h2>OSS ã® Google BigQuery UDF `bqutil.fn` ã‚’ä½¿ãˆã° UDF ã®ç‹¬è‡ªå®Ÿè£…ã‚’ç½®ãæ›ãˆã‚‰ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œãªã„</h2></header><div class=entry-content><p>TL;DR; UDF ã‚’ç‹¬è‡ªå®Ÿè£…ã™ã‚‹å‰ã«ã€bqutil.fnã‚’çœºã‚ã¦ãŠãã¨è»Šè¼ªã®å†ç™ºæ˜ãŒå›é¿ã§ãã‚‹ã‹ã‚‚
èƒŒæ™¯ SQL ã¯ã€ç‰¹å®šã®å‡¦ç†ã‚’è¡Œã†éš›ã«ãƒ‡ãƒ¼ã‚¿ã®å‹ãŒåŒä¸€ã§ãªã„ã¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ãŒã€ã‚‚ã¨ã®ã‚¹ã‚­ãƒ¼ãƒã‚’ç´¹ä»‹ã™ã‚‹ã‚ˆã‚Šã‚‚ã‚‚ã£ã¨ãŠæ‰‹è»½ã«ã‚«ãƒ©ãƒ ã®å‹ã‚’ç¢ºèªã—ãŸã„ã¨ããŒã‚ã‚Šã¾ã›ã‚“ã‹?
ä¾‹ãˆã°ã€å‡ºåŠ›çµæœã‚’è¦‹ãŸã ã‘ã§ã¯ã€12345 ãŒ STRING ãªã®ã‹ INT64 ãªã®ã‹åˆ¤åˆ¥ä¸å¯èƒ½ã§ã™ã‚ˆã­ã€‚(ã‚‚ã—åˆ¤åˆ¥å¯èƒ½ãªæ–¹æ³•çŸ¥ã£ã¦ã„ã‚‹äººã„ãŸã‚‰æ•™ãˆã¦ä¸‹ã•ã„â€¦)
GCP ã«ã‚ˆã‚‹ OSS UDF ã® bqutil.fn ãªã®ã§ãŠæ‰‹è»½ã« BigQuery ã®çµæœã®å‹ã‚’ç¢ºèªã—ãŸã„æ™‚ã«ãªã«ã‹è‰¯ã„æ–¹æ³•ãŒãªã„ã‹ãªã¨èª¿ã¹ã¦ã„ãŸã‚‰ã€OSS ã§bqutil.fnã¨ã„ã† UDF ãŒ GCP ã‹ã‚‰æä¾›ã•ã‚Œã¦ã„ãŸã€‚
ä¾‹ãˆã°å‹ã®ç¢ºèªã®å ´åˆã€ä»¥ä¸‹ã® ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•°ï¼ˆUDF) ã¯ã©ã® GCP ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰å®Ÿè¡Œã—ã¦ã‚‚å®Ÿè¡Œå¯èƒ½
1 bqutil.fn.typeof() ã“ã®bqutil.fn ã¯bigquery-utils/udfs/community/ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ UDF ãŒbqutil ã¨ã„ã† GCP ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®fn ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«åŒæœŸã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã©ã® GCP ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® Google BigQuery ã‹ã‚‰å®Ÿè¡Œã—ã¦ã‚‚ bqutil.fn.typeof()ã‚’å®Ÿè¡Œå¯èƒ½ã«ã—ã¦ã„ã‚‹ã‚‰ã—ã„ã€‚ é ­è‰¯ã„
This directory contains community contributed user-defined functions to extend BigQuery for more specialized usage patterns. Each UDF within this directory will be automatically synchronized to the bqutil project within the fn dataset for reference in queries....</p></div><footer class=entry-footer><span title="2022-01-20 00:03:07 +0900 +0900">January 20, 2022</span>&nbsp;Â·&nbsp;Shunya Ueta</footer><a class=entry-link aria-label="post link to OSS ã® Google BigQuery UDF `bqutil.fn` ã‚’ä½¿ãˆã° UDF ã®ç‹¬è‡ªå®Ÿè£…ã‚’ç½®ãæ›ãˆã‚‰ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œãªã„" href=https://shunyaueta.com/posts/2022-01-20/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Standard SQLã®COALESCEã§ã€æ™‚é–“çµŒéã«ã‚ˆã£ã¦ã‚«ãƒ©ãƒ åãŒå¤‰åŒ–ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’æŸ”è»Ÿã«æŠ½å‡ºã™ã‚‹</h2></header><div class=entry-content><p>ãƒ‡ãƒ¼ã‚¿ã®è“„ç©å¸°é‚„ãŒé•·ããªã£ã¦ãã‚‹ã¨ã€ä¾‹ãˆã° JSON å½¢å¼ã§ãƒ­ã‚°ã‚’å–ã£ã¦ã„ã‚‹ãŒã€åŒã˜ãƒ‡ãƒ¼ã‚¿ã§ã‚‚ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒ­ã‚®ãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã®æ›´æ–°ãªã©ã§key ã®åå‰ãŒå¤‰åŒ–ã—ãŸã‚Šã™ã‚‹å ´åˆãŒã‚ã‚‹ã€‚
ãã®å ´åˆå–ã‚Šæ‰±ã„ã«å›°ã‚‹ã®ãŒã€å¤ã„ key ã¨æ–°ã—ã„ key ã‚’ã©ã®ã‚ˆã†ã«ä½µåˆã™ã‚‹ã‹ã ã€‚ ä¾‹ãˆã°ç‰¹å®šã®æ—¥æ¬¡ã§ãã‚Œã„ã«ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã‚Œæ›¿ã‚ã£ã¦ã„ã‚‹ã®ãªã‚‰ã€è‰²ã€…ã‚„ã‚Šã‚ˆã†ãŒã‚ã‚‹ãŒã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãªã©ã®ãƒ­ã‚°ã®å ´åˆãƒ‡ãƒ¼ã‚¿ã®å¤‰åŒ–ã‚‚å‡ä¸€ã§ã¯ãªã„ã®ã§ã€å¾ã€…ã«å¤‰åŒ–ã—ã¦ã„ã‚‹ã“ã¨ãŒå¤§åŠãªã®ã§ã€æ—¥æ¬¡ã§åˆ¥ã€…ã®æŠ½å‡ºã‚’ã—ã¦çµåˆã™ã‚‹ã¨ã„ã†ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚‚é›£ã—ã„ã€‚
ãã®éš›ã«å½¹ç«‹ã¤ã®ãŒ Standard SQL æ¡ä»¶ä»˜ãæ§‹æ–‡ã® COALESCE ã ã€‚
COALECSCE ã¯ã€å¼•æ•°ã®æœ€åˆã®é NULL ã®å€¤ã‚’è¿”ã™é–¢æ•°ã§ã€
1 COALESCE(NULL, 'B', 'C') ã ã¨ BãŒè¿”ã•ã‚Œã‚‹ã€‚ã“ã®é–¢æ•°ã‚’ä½¿ã†ã“ã¨ã§ã€è¤‡æ•°ã‚«ãƒ©ãƒ ã‚’ä¸€ã¤ã«ä½µåˆã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
å…·ä½“ä¾‹ã‚’äº¤ãˆã¤ã¤å®Ÿè·µã—ã¦ã¿ã‚‹ ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ˜”ã®ã‚«ãƒ©ãƒ åãŒ title ã§ã€å…¨ãåŒã˜ãƒ‡ãƒ¼ã‚¿ãŒæ–°ã—ã„ã‚«ãƒ©ãƒ ã® title_v2 ã«å…¥ã£ã¦ãã¦ã„ã‚‹ã¨ã™ã‚‹ã€‚
NOTE: json ã‚’ä¾‹é¡Œã« key ã®æŠ½å‡ºã«ã—ãŸã»ã†ãŒå®Ÿéš›ã®çŠ¶æ³ã«æ²¿ã„ã¾ã™ãŒã€ã‚«ãƒ©ãƒ ã®ã¿ã§è¡¨ç¾ã—ãŸã»ã†ãŒèª¬æ˜ãŒç°¡å˜ãªã®ã§ä»Šå›ã¯ãã¡ã‚‰ã‚’æ¡ç”¨ã€‚
ç”¨æ„ã—ãŸãƒ‡ãƒ¼ã‚¿ 1 2 3 4 5 6 7 8 WITH menues AS (SELECT "ã†ã©ã‚“" as title, NULL as title_v2, "2021/10/06" as created UNION ALL SELECT "ãƒ©ãƒ¼ãƒ¡ãƒ³", NULL, "2021/10/07" UNION ALL SELECT NULL, "ãã°", "2021/10/08" UNION ALL SELECT "ã‚«ãƒ„ä¸¼", NULL, "2021/10/09" UNION ALL SELECT "ã‚«ãƒ„ä¸¼", "ã‚«ãƒ„ä¸¼", "2021/10/10" UNION ALL SELECT NULL, "ã‚«ãƒ¬ãƒ¼", "2021/10/11") SELECT * FROM menues title title_v2 created ã†ã©ã‚“ 2021/10/06 ãƒ©ãƒ¼ãƒ¡ãƒ³ 2021/10/07 ãã° 2021/10/08 ã‚«ãƒ„ä¸¼ 2021/10/09 ã‚«ãƒ„ä¸¼ ã‚«ãƒ„ä¸¼ 2021/10/10 ã‚«ãƒ¬ãƒ¼ 2021/10/11 2021/10/10 ã®ãƒ‡ãƒ¼ã‚¿ãªã©ã¯æ—§ã‚«ãƒ©ãƒ ã¨æ–°ã‚«ãƒ©ãƒ ã«ãƒ€ãƒ–ãƒ«ãƒ©ã‚¤ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚...</p></div><footer class=entry-footer><span title="2021-11-06 22:40:02 +0900 +0900">November 6, 2021</span>&nbsp;Â·&nbsp;Shunya Ueta</footer><a class=entry-link aria-label="post link to Standard SQLã®COALESCEã§ã€æ™‚é–“çµŒéã«ã‚ˆã£ã¦ã‚«ãƒ©ãƒ åãŒå¤‰åŒ–ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’æŸ”è»Ÿã«æŠ½å‡ºã™ã‚‹" href=https://shunyaueta.com/posts/2021-11-06/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>é…ã™ãã‚‹ `pandas.read_gbq` ã‚’ä½¿ã‚ãšã«ã€Google BigQueryã‹ã‚‰é«˜é€Ÿã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</h2></header><div class=entry-content><p>pandas.read_gbq ä¾¿åˆ©ã§ã™ã‚ˆã­ã€‚ ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èªè¨¼ç”»é¢ã‹ã‚‰ã‚³ãƒ”ãƒšã™ã‚Œã° Jupyter Notebook ä¸Šã§ç°¡å˜ã«èªè¨¼ã•ã‚Œã€Google BigQuery ãŒå®Ÿè¡Œã•ã‚Œã¦ãã®çµæœãŒãã®ã¾ã¾ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã¨ã—ã¦æ‰±ãˆã¾ã™ã€‚ Jupyter Notebook ã¨ Google BigQuery ã‚’é€£æºã•ã›ãŸã„ã¨ãã¯æ„›ç”¨ã—ã¦ã„ã¾ã—ãŸ(éå»å½¢)ã€‚
å•é¡Œç‚¹ ãã“ãã“å¤§ããªãƒ‡ãƒ¼ã‚¿ã‚’æŒã£ã¦ã“ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ã‚ã¡ã‚ƒãã¡ã‚ƒé…ãã¦ã‚¹ãƒˆãƒ¬ã‚¹ãŒå‡„ã„ è§£æ±ºæ–¹æ³•ã¨ã—ã¦ã€Google BigQuery ã§å·¨å¤§ãªãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚
å®Ÿã¯ Google ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã‚‚æ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://cloud.google.com/bigquery/docs/pandas-gbq-migration https://cloud.google.com/bigquery/docs/bigquery-storage-python-pandas æ–¹æ³•ã¯ä»¥ä¸‹ã®ï¼’ã¤ã€‚
google-cloud-bigquery ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€ãƒã‚¸ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰ã§ Google BQ ã‚’å®Ÿè¡Œ BQ å®Ÿè¡Œ â†’BigQuery table ã¨ã—ã¦ä¿å­˜ â†’GCS ã¸ä¿å­˜ â†’ gsutil ã§ãƒã‚·ãƒ³ã¸ã‚³ãƒ”ãƒ¼ 1 ç•ªç›®ã¯ã€Jupyter ä¸Šã§ãƒã‚¸ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰ã§ Google BQ ãŒå®Ÿè¡Œã§ãã¦ã€é€Ÿåº¦ã‚‚ pandas.rad_gbq ã‚ˆã‚Šã‚‚é«˜é€Ÿã§ã™ 2 ç•ªç›®ã¯ãã‚‚ãã‚‚å®Ÿè¡ŒçµæœãŒå·¨å¤§ãªå ´åˆã§ã€ç›®å®‰ã¨ã—ã¦ã¯1GBä»¥ä¸Šãªã‚‰ 2 ç•ªç›®ã®æ–¹æ³•ã‚’ä½¿ãˆã°æ¥½ã§ã™ã€‚
1, google-cloud-bigquery ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€Jupyter Notebook ã®ãƒã‚¸ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰ã§ Google BQ ã‚’å®Ÿè¡Œ 1 pip install --upgrade google-cloud-bigquery[bqstorage,pandas] magic command ã‚’å®Ÿè¡Œ...</p></div><footer class=entry-footer><span title="2019-10-03 23:52:54 +0900 +0900">October 3, 2019</span>&nbsp;Â·&nbsp;Shunya Ueta</footer><a class=entry-link aria-label="post link to é…ã™ãã‚‹ `pandas.read_gbq` ã‚’ä½¿ã‚ãšã«ã€Google BigQueryã‹ã‚‰é«˜é€Ÿã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€" href=https://shunyaueta.com/posts/2019-10-03/></a></article></main><footer class=footer><span>&copy; 2022 <a href=https://shunyaueta.com/>ğŸ¦… hurutoriya</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z" /></svg></a><script>let menu=document.getElementById('menu')
if(menu){menu.scrollLeft=localStorage.getItem("menu-scroll-position");menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft);}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.pushState(null,null,`#${id}`);}});});</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script></body></html>