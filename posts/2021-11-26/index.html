<!doctype html><html lang=ja dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Amazonがeコマース検索を Lucene により、どうスケールさせているか at Berlin Buzzwords 2019 | 🦅 hurutoriya</title><meta name=keywords content="search,amazon,lucene,translation"><meta name=description content="情報検索・検索技術 Advent Calendar 2021 1 日目の記事です。 早めに書き終えたので、カレンダー登録日の 2021/12/01 よりもはやめですが、記事を公開してしまいます。
Berlin Buzzwords はドイツで毎年開催されている OSS を利用した検索、データ処理、データベースに焦点をあてたカンファレンスです。
検索関係のシステムに携わっている場合、毎年面白い内容が目白押しなのでぜひとも見てほしい。
今回は Berlin Buzzwords 2019 で発表された「Amazon では Lucene をどう活用して e コマース検索をスケールさせているか」の講演動画を社内勉強会で紹介するために視聴したので、そのメモを公開する。
E-Commerce search at scale on Apache Lucene  YouTube Web page PDF  自分の所感などを切り分けるため、自分の意見は IMO ではじめた文にして、メモっています。
Overview  クエリの p999 latency に対して非常に厳しい制限を行っている  IMO  このクエリの p999 latency 定義は、Lucene+(おそらく内製で今も開発している、response を返すための Lucene server?)が返す検索のレスポンスを指していると思われる p99.9 latency を SLA として、監視しているのはたしかにとてもシビアな基準だと感じる。     Amazon の query rate はめちゃくちゃピーキー (daily, weekly, yearly) Why Lucene?"><meta name=author content="Shunya Ueta"><link rel=canonical href=https://shunyaueta.com/posts/2021-11-26/><link crossorigin=anonymous href=/assets/css/stylesheet.min.f00f189851525f5dc525fa12dfc10fa3656c6cc16f26285e5f7347522031587e.css integrity="sha256-8A8YmFFSX13FJfoS38EPo2VsbMFvJiheX3NHUiAxWH4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w=" onload=hljs.initHighlightingOnLoad();></script><link rel=icon href=https://shunyaueta.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://shunyaueta.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://shunyaueta.com/favicon-32x32.png><link rel=apple-touch-icon href=https://shunyaueta.com/apple-touch-icon.png><link rel=mask-icon href=https://shunyaueta.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme: rgb(29, 30, 32);--entry: rgb(46, 46, 51);--primary: rgb(218, 218, 219);--secondary: rgb(155, 156, 157);--tertiary: rgb(65, 66, 68);--content: rgb(196, 196, 197);--hljs-bg: rgb(46, 46, 51);--code-bg: rgb(55, 56, 62);--border: rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-39994406-11','auto');ga('send','pageview');}</script><meta property="og:title" content="Amazonがeコマース検索を Lucene により、どうスケールさせているか at Berlin Buzzwords 2019"><meta property="og:description" content="情報検索・検索技術 Advent Calendar 2021 1 日目の記事です。 早めに書き終えたので、カレンダー登録日の 2021/12/01 よりもはやめですが、記事を公開してしまいます。
Berlin Buzzwords はドイツで毎年開催されている OSS を利用した検索、データ処理、データベースに焦点をあてたカンファレンスです。
検索関係のシステムに携わっている場合、毎年面白い内容が目白押しなのでぜひとも見てほしい。
今回は Berlin Buzzwords 2019 で発表された「Amazon では Lucene をどう活用して e コマース検索をスケールさせているか」の講演動画を社内勉強会で紹介するために視聴したので、そのメモを公開する。
E-Commerce search at scale on Apache Lucene  YouTube Web page PDF  自分の所感などを切り分けるため、自分の意見は IMO ではじめた文にして、メモっています。
Overview  クエリの p999 latency に対して非常に厳しい制限を行っている  IMO  このクエリの p999 latency 定義は、Lucene+(おそらく内製で今も開発している、response を返すための Lucene server?)が返す検索のレスポンスを指していると思われる p99.9 latency を SLA として、監視しているのはたしかにとてもシビアな基準だと感じる。     Amazon の query rate はめちゃくちゃピーキー (daily, weekly, yearly) Why Lucene?"><meta property="og:type" content="article"><meta property="og:url" content="https://shunyaueta.com/posts/2021-11-26/"><meta property="og:image" content="https://shunyaueta.com/posts/2021-11-26/images/1.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-26T20:59:21+09:00"><meta property="article:modified_time" content="2022-06-03T20:54:37+09:00"><meta property="og:site_name" content="Shunya Ueta"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://shunyaueta.com/posts/2021-11-26/images/1.png"><meta name=twitter:title content="Amazonがeコマース検索を Lucene により、どうスケールさせているか at Berlin Buzzwords 2019"><meta name=twitter:description content="情報検索・検索技術 Advent Calendar 2021 1 日目の記事です。 早めに書き終えたので、カレンダー登録日の 2021/12/01 よりもはやめですが、記事を公開してしまいます。
Berlin Buzzwords はドイツで毎年開催されている OSS を利用した検索、データ処理、データベースに焦点をあてたカンファレンスです。
検索関係のシステムに携わっている場合、毎年面白い内容が目白押しなのでぜひとも見てほしい。
今回は Berlin Buzzwords 2019 で発表された「Amazon では Lucene をどう活用して e コマース検索をスケールさせているか」の講演動画を社内勉強会で紹介するために視聴したので、そのメモを公開する。
E-Commerce search at scale on Apache Lucene  YouTube Web page PDF  自分の所感などを切り分けるため、自分の意見は IMO ではじめた文にして、メモっています。
Overview  クエリの p999 latency に対して非常に厳しい制限を行っている  IMO  このクエリの p999 latency 定義は、Lucene+(おそらく内製で今も開発している、response を返すための Lucene server?)が返す検索のレスポンスを指していると思われる p99.9 latency を SLA として、監視しているのはたしかにとてもシビアな基準だと感じる。     Amazon の query rate はめちゃくちゃピーキー (daily, weekly, yearly) Why Lucene?"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Amazonがeコマース検索を Lucene により、どうスケールさせているか at Berlin Buzzwords 2019","item":"https://shunyaueta.com/posts/2021-11-26/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Amazonがeコマース検索を Lucene により、どうスケールさせているか at Berlin Buzzwords 2019","name":"Amazonがeコマース検索を Lucene により、どうスケールさせているか at Berlin Buzzwords 2019","description":"情報検索・検索技術 Advent Calendar 2021 1 日目の記事です。 早めに書き終えたので、カレンダー登録日の 2021/12/01 よりもはやめですが、記事を公開してしまいます。\nBerlin Buzzwords はドイツで毎年開催されている OSS を利用した検索、データ処理、データベースに焦点をあてたカンファレンスです。\n検索関係のシステムに携わっている場合、毎年面白い内容が目白押しなのでぜひとも見てほしい。\n今回は Berlin Buzzwords 2019 で発表された「Amazon では Lucene をどう活用して e コマース検索をスケールさせているか」の講演動画を社内勉強会で紹介するために視聴したので、そのメモを公開する。\nE-Commerce search at scale on Apache Lucene  YouTube Web page PDF  自分の所感などを切り分けるため、自分の意見は IMO ではじめた文にして、メモっています。\nOverview  クエリの p999 latency に対して非常に厳しい制限を行っている  IMO  このクエリの p999 latency 定義は、Lucene+(おそらく内製で今も開発している、response を返すための Lucene server?)が返す検索のレスポンスを指していると思われる p99.9 latency を SLA として、監視しているのはたしかにとてもシビアな基準だと感じる。     Amazon の query rate はめちゃくちゃピーキー (daily, weekly, yearly) Why Lucene?","keywords":["search","amazon","lucene","translation"],"articleBody":"情報検索・検索技術 Advent Calendar 2021 1 日目の記事です。 早めに書き終えたので、カレンダー登録日の 2021/12/01 よりもはやめですが、記事を公開してしまいます。\nBerlin Buzzwords はドイツで毎年開催されている OSS を利用した検索、データ処理、データベースに焦点をあてたカンファレンスです。\n検索関係のシステムに携わっている場合、毎年面白い内容が目白押しなのでぜひとも見てほしい。\n今回は Berlin Buzzwords 2019 で発表された「Amazon では Lucene をどう活用して e コマース検索をスケールさせているか」の講演動画を社内勉強会で紹介するために視聴したので、そのメモを公開する。\nE-Commerce search at scale on Apache Lucene  YouTube Web page PDF  自分の所感などを切り分けるため、自分の意見は IMO ではじめた文にして、メモっています。\nOverview  クエリの p999 latency に対して非常に厳しい制限を行っている  IMO  このクエリの p999 latency 定義は、Lucene+(おそらく内製で今も開発している、response を返すための Lucene server?)が返す検索のレスポンスを指していると思われる p99.9 latency を SLA として、監視しているのはたしかにとてもシビアな基準だと感じる。     Amazon の query rate はめちゃくちゃピーキー (daily, weekly, yearly) Why Lucene?  Lucene は成熟しており、豊富な検索エンジンの機能が揃っている 情熱を持ったコミュニティが存在している Uber, Airbnb, Linkedin 全部 Lucene を使っている maxscore scoring , Weak AND, Lucene 8.0 での Codec の衝撃   Lucene design  100% Java で書かれている on-disc search with small in-memory index 巨大な index を扱えるが、小さな RAM で実行可能 高い並列性を兼ね揃えたインデキシングと検索機能 ニアリアルタイムでの検索とインデキシング機能   Amazon での Lucene 利用例  ニアリアルタイムでのセグメントレプリケーション (Solr, Elastic Search とは別のレプリケーションの仕組み)  IMO: 登壇者の Mike さんが Lucene 6.0 をベースにした Near realtime replication が可能なlucene server を公開している。 yelp が 2021/09 に OSS として、上記の lucene server をベースにした OSS を公開。解説記事も公開してくれている。Nrtsearch: Yelp’s Fast, Scalable and Cost Effective Search Engine   並行検索 → 複数のスレッドでの並行検索処理が可能 (Lucene で利用可能だが、Solr, ElasticSearch では 2019 年時点では利用不可) query time ではなく、index time で join を行いデータの結合を行っている。Lucene 6.0 で追加された BKD-tree を利用した Dimensional points 機能は、多次元空間を効率的に検索することができ、プライムデーで重宝されている。 また拡張性の高いデザインのおかげでカスタマイズも容易。 Custom term frequency などもとても便利。当初 Lucene にこの機能は存在しなかったので、我々で機能開発を行い Lucene にこの機能が搭載された。 2019 年時点では、Solr, Elastic Search を使っていない。理由としては、Concurrent faceting, multi-phase ranking などの機能は Solr, Elastic Search は当時は利用できなかった。また、現時点で Lucene ベースでのモジュールを多数開発しているのも要因。   Open Source at Amazon  パフォーマンス課題や小さなバグなどを発見して、それらを解決していった。これはコミュニティみんなが嬉しい。(Solr, Elastic Search にも還元されるのでとても健全な流れだよね) 以下の Lucene の機能は Amazon が開発を行い、貢献した  Custom term frequencies Concurrent indexing updates Concurrent faceting FST direct arc addressing  該当チケット 日本語での解説記事: Lucene で使われてる FST を実装してみた（正規表現マッチ：VM アプローチへの招待）   Off-heaps FSTs      Service architecture  Near-real-time replicaiton  Black Friday や Prime day などの爆発的にアクセスが増加するイベントなどに対応するために作成 Solr, Elastic Search で提供される document level レプリケーションでは限界がある   Service architecture  AWS で構築 ECS コンテナでインデクサー、サーチャーが稼働している Kinesis, DynamoDB からカタログが更新される ニアリアルタイムで、S3 にインデックスは保存される インデックスはソフトウェアが更新されるたびに、全て再構築される 人為的なクエリでサービスを暖機運転   Service system design   リクエストが来た際に、Collators がリクエストをさばいて、適切な view に割り振る。 Index(i001, i002, …) は S3 にリアルタイムで保存され、service はその index を読み込んで検索を行って、レスポンスを返す。   Searching a segmented index  Lucene には検索インデックスが必要で、分割型のアーキテクチャとなっている merge して結果を返す   Searching a segmented index concurrently  index は統計的に商品品質によりソート済 この機能はシャードが巨大化している我々にとってレイテンシーを抑えるために非常に有用な機能   p999 latency figure  青色のグラフの挙動は、Lucene の分割型アーキテクチャによって発生しており、並行検索がどのように優位性をもっているのかを説明する。縦軸は latency 緑色のグラフは、どれくらいのサイズのセグメントがレプリカにコピーされているかを示している。縦軸は GB。  大きなセグメントがマージされたときにスパイクが発生する  通常は、小さなインデックスがマージされて大きなインデックスになることは良いことである、なぜならたくさんのファイルを開く必要がなくなるし、すべてのセグメントを探索しなくても良くなる。 だが、Amazon の場合は、並行検索を行っているので、大きなセグメントが存在すると逆にレイテンシー増加の要因となる。なぜならセグメントの数が減少すると、検索の並行性も失われるため。例えば、10 のセグメントがあった場合、10 スレッドで並行検索を行えるが、一つのセグメントになってしまった場合、1 スレッドでの検索しかできなくなる。 Mike さんは、例えば一つのセグメントに対して、複数スレッドで並行検索できるようになれば、この問題への改善が見込めると考えているらしい。     セグメントインデックスに対して、並行検索が可能になったことで、大きなセグメントを取り扱うことを避けれるようになった    Performance mesurement  Bemchmarking  Lucene nightly benchmarks  上記と同じような方法で、各種クエリのパフォーマンスを常に測定している。   perfoamance regression の検知は困難 performance だけではなく、検索性能も自動的に評価   Concurrent refresh  Lucene は、並行リフレッシュのために、インデックスサイドのアプリケーションのスレッドを借りるという問題があった  解決方法として、インデキシングが行われていないときのみ並行リフレッシュを行う機能を開発  Solution: use expert Lucene API to refresh concurrently        Gathering metrics using Lucene’s abstractions  Lucene の抽象化機能を使って、各指標を容易にモニタリング可能に   Garbate correction is too hard  IMO: ここらへんは知識が足りず理解できなかったので、後から勉強    Analysis challanges  Context sensitive analysis  plane は何を意味する? おもちゃの airplane? plane ←→ airplane の同義語 synonym 拡張をを index time のみで行う   Numbers a special  Toy for 3 year old というクエリには、 2-4 歳対象という文章は対象になる 1500ml は 1.5 litters とマッチするべき 1,100、1100、1.100 は一緒で、1/100、1:100 とは違う 標準的な tokenizer の後に上記のハンドリングをするのは難しい 句読点の取り扱いには注意   WordDelimiterGraphFiltter  Lucene docs  英語と数字の分割など細かい前処理が可能になる  e.g. “SD500” → “SD”, “500”     機械学習はこの問題は解決可能だが、検索ではこのような機能もやはりまだ必要である。  IMO: Lucene の機能を使って解決可能なら、たしかにできる限り機械学習を使いたくない気持ちは非常に共感できる。ここまでレイテンシーの制約が厳しいなら増加要因は可能な限り抑えたい…      Query optimization  Indexed Queries  多くのクエリは共通のフィルターを使っている。 大元のインデックスに対して、共通で使われているフィルターを適用した結果を、インデキシングしてる? (post-processing index)。 single term に置き換えて、パフォーマンスをチューニング   Factoring queries  Boolean query FP growth algorithm   Query 最適化のおかげで、 +30% redline QPS が増加。p99 latency は 81ms から 54ms へ。  IMO: P99 のレイテンシー公開して良いだろうか…??? (p99.9 は公開していなかったので気になる)   Indexing tuples  multi stage search を single stage に圧縮している IMO: ここらへんの最適化は、Lucene の検索の仕組みをもっと理解しないとどうやって実現しているかまだ深く理解できない   Lighting deals using dimensional points  当初は mike さんにより、地理検索などを目的として作られた機能。だが、地理検索には使用せず、Amazon での lighting deal に三次元データ(start time, end time, id) での三次元検索にこの dimensional points 機能を使ってる。 IMO: by @takuya-a さん - 社内で発表した際に、なぜ start-time, end-time の 2 次元ではなく、id を入れた 3 次元にした検索にしたのかという質問に対する完璧な @takuya-a さんの推測    ID も空間インデックスに含めることで、パフォーマンスを上げているのだとおもいます。ID が別フィールドだと、そっちのインデックスも検索して、空間インデックスの検索結果とマージして、って処理が後段で必要になるのですが、最初から ID も含めておくと BKD-tree の検索で全部処理できちゃうので。同じ期間で別の ID をもつセール対象商品がヒットしないので最初の段階でかなり絞り込めるようになるのだと思います\n    BKD tree の解説は @pon さんの記事がわかりやすいです  検索エンジンの数値インデックスを支える Bkd-Tree      Multi phase ranking  Ranking  Machine Leraning models Multi phase ranking Prorated early termination  IMO: スコアリングの知識が欠如しているのでメモだけ     Summary  Amazon で検索してるときには Lucene が使われているよ 100%ではないけども    Question  Q. indexing synonym を行っていると言っていたが、例えば query timing で synonym を扱えれば、検索者の文脈などを考慮した同義語を扱えるのではないのだろうか?  A. indexing synonym は主に効率性を重視した意思決定であり、基本的にトレードオフの関係となっている。Query rewrite なども行っているが、今回のトークは主に検索エンジンなので優先順的に Query Understanding 関係の話はしていません。    Reference  What Amazon gets by giving back to Apache Lucene  Lucene に詳しい同僚からは、Lucene に興味あるならこの本がおすすめと言われので読んでおきたい。 ちなみに著者は、この講演者のうちの一人である Mike McCandless さん… (14 年間 Lucene の開発をしている!!)\n Lucene in Action 2nd edition  余談ですが、この人のことを同僚が、\n Lucene 界隈では神として知られていますね\n と言っていて、笑った w\n 情報検索・検索技術 Advent Calendar 2021 の次の記事は @sz_dr さんで 4 日目を担当してくれます!\n","wordCount":"578","inLanguage":"ja","image":"https://shunyaueta.com/posts/2021-11-26/images/1.png","datePublished":"2021-11-26T20:59:21+09:00","dateModified":"2022-06-03T20:54:37+09:00","author":{"@type":"Person","name":"Shunya Ueta"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://shunyaueta.com/posts/2021-11-26/"},"publisher":{"@type":"Organization","name":"🦅 hurutoriya","logo":{"@type":"ImageObject","url":"https://shunyaueta.com/favicon.ico"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><header class=header><nav class=nav><div class=logo><a href=https://shunyaueta.com/ accesskey=h title="🦅 hurutoriya (Alt + H)">🦅 hurutoriya</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://shunyaueta.com/archives title=Archive><span>Archive</span></a></li><li><a href=https://shunyaueta.com/about title=About><span>About</span></a></li><li><a href=https://shunyaueta.com/tags/newsletter/ title=Newsletter><span>Newsletter</span></a></li><li><a href=https://shunyaueta.com/index.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Amazonがeコマース検索を Lucene により、どうスケールさせているか at Berlin Buzzwords 2019</h1><div class=post-meta><span title="2021-11-26 20:59:21 +0900 +0900">November 26, 2021</span>&nbsp;·&nbsp;Shunya Ueta&nbsp;|&nbsp;<a href=https://github.com/hurutoriya/hurutoriya.github.io/tree/source/content/posts/2021-11-26/index.md rel="noopener noreferrer" target=_blank>Edit this post (この記事を編集する)</a></div></header><figure class=entry-cover><img loading=lazy src=https://shunyaueta.com/posts/2021-11-26/images/1.png alt="Amazon search アーキテクチャ"><p>Amazon search アーキテクチャ</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目次</span></summary><div class=inner><ul><li><a href=#e-commerce-search-at-scale-on-apache-lucene aria-label="E-Commerce search at scale on Apache Lucene">E-Commerce search at scale on Apache Lucene</a></li><li><a href=#overview aria-label=Overview>Overview</a></li><li><a href=#service-architecture aria-label="Service architecture">Service architecture</a></li><li><a href=#performance-mesurement aria-label="Performance mesurement">Performance mesurement</a></li><li><a href=#analysis-challanges aria-label="Analysis challanges">Analysis challanges</a></li><li><a href=#query-optimization aria-label="Query optimization">Query optimization</a></li><li><a href=#multi-phase-ranking aria-label="Multi phase ranking">Multi phase ranking</a></li><li><a href=#question aria-label=Question>Question</a></li><li><a href=#reference aria-label=Reference>Reference</a></li></ul></div></details></div><div class=post-content><p><a href=https://adventar.org/calendars/6430>情報検索・検索技術 Advent Calendar 2021</a> 1 日目の記事です。
早めに書き終えたので、カレンダー登録日の 2021/12/01 よりもはやめですが、記事を公開してしまいます。</p><p><a href=https://2021.berlinbuzzwords.de/>Berlin Buzzwords</a> はドイツで毎年開催されている OSS を利用した検索、データ処理、データベースに焦点をあてたカンファレンスです。</p><p>検索関係のシステムに携わっている場合、毎年面白い内容が目白押しなのでぜひとも見てほしい。</p><p>今回は Berlin Buzzwords 2019 で発表された「Amazon では Lucene をどう活用して e コマース検索をスケールさせているか」の講演動画を社内勉強会で紹介するために視聴したので、そのメモを公開する。</p><h2 id=e-commerce-search-at-scale-on-apache-lucene>E-Commerce search at scale on Apache Lucene<a hidden class=anchor aria-hidden=true href=#e-commerce-search-at-scale-on-apache-lucene>#</a></h2><ul><li><a href="https://www.youtube.com/watch?v=EkkzSLstSAE">YouTube</a></li><li><a href=https://2019.berlinbuzzwords.de/19/session/e-commerce-search-scale-apache-lucene-tm.html>Web page</a></li><li><a href=https://2019.berlinbuzzwords.de/sites/2019.berlinbuzzwords.de/files/media/documents/bbuzzamazonlucene2019.pdf>PDF</a></li></ul><p>自分の所感などを切り分けるため、自分の意見は IMO ではじめた文にして、メモっています。</p><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><ul><li>クエリの p999 latency に対して非常に厳しい制限を行っている<ul><li>IMO<ul><li>このクエリの p999 latency 定義は、Lucene+(おそらく内製で今も開発している、response を返すための Lucene server?)が返す検索のレスポンスを指していると思われる</li><li>p99.9 latency を SLA として、監視しているのはたしかにとてもシビアな基準だと感じる。</li></ul></li></ul></li><li>Amazon の query rate はめちゃくちゃピーキー (daily, weekly, yearly)</li><li>Why Lucene?<ul><li>Lucene は成熟しており、豊富な検索エンジンの機能が揃っている</li><li>情熱を持ったコミュニティが存在している</li><li>Uber, Airbnb, Linkedin 全部 Lucene を使っている</li><li><a href=https://issues.apache.org/jira/browse/LUCENE-4100>maxscore scoring</a> , Weak AND, Lucene 8.0 での Codec の衝撃</li></ul></li><li>Lucene design<ul><li>100% Java で書かれている</li><li>on-disc search with small in-memory index</li><li>巨大な index を扱えるが、小さな RAM で実行可能</li><li>高い並列性を兼ね揃えたインデキシングと検索機能</li><li>ニアリアルタイムでの検索とインデキシング機能</li></ul></li><li>Amazon での Lucene 利用例<ul><li>ニアリアルタイムでのセグメントレプリケーション (Solr, Elastic Search とは別のレプリケーションの仕組み)<ul><li>IMO: 登壇者の Mike さんが Lucene 6.0 をベースにした Near realtime replication が可能な<a href=https://github.com/mikemccand/luceneserver>lucene server</a> を公開している。</li><li>yelp が 2021/09 に OSS として、上記の lucene server をベースにした OSS を公開。解説記事も公開してくれている。<a href=https://engineeringblog.yelp.com/2021/09/nrtsearch-yelps-fast-scalable-and-cost-effective-search-engine.html>Nrtsearch: Yelp’s Fast, Scalable and Cost Effective Search Engine</a></li></ul></li><li>並行検索 → 複数のスレッドでの並行検索処理が可能 (Lucene で利用可能だが、Solr, ElasticSearch では 2019 年時点では利用不可)</li><li>query time ではなく、index time で join を行いデータの結合を行っている。Lucene 6.0 で追加された BKD-tree を利用した Dimensional points 機能は、多次元空間を効率的に検索することができ、プライムデーで重宝されている。</li><li>また拡張性の高いデザインのおかげでカスタマイズも容易。</li><li>Custom term frequency などもとても便利。当初 Lucene にこの機能は存在しなかったので、我々で機能開発を行い Lucene にこの機能が搭載された。</li><li>2019 年時点では、Solr, Elastic Search を使っていない。理由としては、Concurrent faceting, multi-phase ranking などの機能は Solr, Elastic Search は当時は利用できなかった。また、現時点で Lucene ベースでのモジュールを多数開発しているのも要因。</li></ul></li><li>Open Source at Amazon<ul><li>パフォーマンス課題や小さなバグなどを発見して、それらを解決していった。これはコミュニティみんなが嬉しい。(Solr, Elastic Search にも還元されるのでとても健全な流れだよね)</li><li>以下の Lucene の機能は Amazon が開発を行い、貢献した<ul><li>Custom term frequencies</li><li>Concurrent indexing updates</li><li>Concurrent faceting</li><li>FST direct arc addressing<ul><li><a href=https://issues.apache.org/jira/browse/LUCENE-8781>該当チケット</a></li><li>日本語での解説記事: <a href=https://qiita.com/ikawaha/items/be95304a803020e1b2d1>Lucene で使われてる FST を実装してみた（正規表現マッチ：VM アプローチへの招待）</a></li></ul></li><li>Off-heaps FSTs</li></ul></li></ul></li></ul><h2 id=service-architecture>Service architecture<a hidden class=anchor aria-hidden=true href=#service-architecture>#</a></h2><ul><li>Near-real-time replicaiton<ul><li>Black Friday や Prime day などの爆発的にアクセスが増加するイベントなどに対応するために作成</li><li>Solr, Elastic Search で提供される document level レプリケーションでは限界がある</li></ul></li><li>Service architecture<ul><li>AWS で構築</li><li>ECS コンテナでインデクサー、サーチャーが稼働している</li><li>Kinesis, DynamoDB からカタログが更新される</li><li>ニアリアルタイムで、S3 にインデックスは保存される</li><li>インデックスはソフトウェアが更新されるたびに、全て再構築される</li><li>人為的なクエリでサービスを暖機運転</li></ul></li><li>Service system design<ul><li><img loading=lazy src=/posts/2021-11-26/images/1.png alt="Amazon serarch architecture"></li><li>リクエストが来た際に、Collators がリクエストをさばいて、適切な view に割り振る。</li><li>Index(i001, i002, &mldr;) は S3 にリアルタイムで保存され、service はその index を読み込んで検索を行って、レスポンスを返す。</li></ul></li><li>Searching a segmented index<ul><li>Lucene には検索インデックスが必要で、分割型のアーキテクチャとなっている</li><li>merge して結果を返す</li></ul></li><li>Searching a segmented index concurrently<ul><li>index は統計的に商品品質によりソート済</li><li>この機能はシャードが巨大化している我々にとってレイテンシーを抑えるために非常に有用な機能</li></ul></li><li>p999 latency figure<ul><li>青色のグラフの挙動は、Lucene の分割型アーキテクチャによって発生しており、並行検索がどのように優位性をもっているのかを説明する。縦軸は latency</li><li>緑色のグラフは、どれくらいのサイズのセグメントがレプリカにコピーされているかを示している。縦軸は GB。<ul><li>大きなセグメントがマージされたときにスパイクが発生する<ul><li>通常は、小さなインデックスがマージされて大きなインデックスになることは良いことである、なぜならたくさんのファイルを開く必要がなくなるし、すべてのセグメントを探索しなくても良くなる。</li><li>だが、Amazon の場合は、並行検索を行っているので、大きなセグメントが存在すると逆にレイテンシー増加の要因となる。なぜならセグメントの数が減少すると、検索の並行性も失われるため。例えば、10 のセグメントがあった場合、10 スレッドで並行検索を行えるが、一つのセグメントになってしまった場合、1 スレッドでの検索しかできなくなる。</li><li>Mike さんは、例えば一つのセグメントに対して、複数スレッドで並行検索できるようになれば、この問題への改善が見込めると考えているらしい。</li></ul></li></ul></li><li>セグメントインデックスに対して、並行検索が可能になったことで、大きなセグメントを取り扱うことを避けれるようになった</li></ul></li></ul><h2 id=performance-mesurement>Performance mesurement<a hidden class=anchor aria-hidden=true href=#performance-mesurement>#</a></h2><ul><li>Bemchmarking<ul><li><a href=https://home.apache.org/~mikemccand/lucenebench/>Lucene nightly benchmarks</a><ul><li>上記と同じような方法で、各種クエリのパフォーマンスを常に測定している。</li></ul></li><li>perfoamance regression の検知は困難</li><li>performance だけではなく、検索性能も自動的に評価</li></ul></li><li>Concurrent refresh<ul><li>Lucene は、並行リフレッシュのために、インデックスサイドのアプリケーションのスレッドを借りるという問題があった<ul><li>解決方法として、インデキシングが行われていないときのみ並行リフレッシュを行う機能を開発<ul><li><a href=https://issues.apache.org/jira/browse/LUCENE-8700>Solution: use expert Lucene API to refresh concurrently</a></li></ul></li></ul></li></ul></li><li>Gathering metrics using Lucene’s abstractions<ul><li>Lucene の抽象化機能を使って、各指標を容易にモニタリング可能に</li></ul></li><li>Garbate correction is too hard<ul><li>IMO: ここらへんは知識が足りず理解できなかったので、後から勉強</li></ul></li></ul><h2 id=analysis-challanges>Analysis challanges<a hidden class=anchor aria-hidden=true href=#analysis-challanges>#</a></h2><ul><li>Context sensitive analysis<ul><li>plane は何を意味する?</li><li>おもちゃの airplane? <code>plane ←→ airplane</code> の同義語</li><li>synonym 拡張をを index time のみで行う</li></ul></li><li>Numbers a special<ul><li>Toy for 3 year old というクエリには、 2-4 歳対象という文章は対象になる</li><li>1500ml は 1.5 litters とマッチするべき</li><li>1,100、1100、1.100 は一緒で、1/100、1:100 とは違う</li><li>標準的な tokenizer の後に上記のハンドリングをするのは難しい</li><li>句読点の取り扱いには注意</li></ul></li><li>WordDelimiterGraphFiltter<ul><li><a href=https://lucene.apache.org/core/7_4_0/analyzers-common/org/apache/lucene/analysis/miscellaneous/WordDelimiterGraphFilter.html>Lucene docs</a><ul><li>英語と数字の分割など細かい前処理が可能になる<ul><li>e.g. &ldquo;SD500&rdquo; → &ldquo;SD&rdquo;, &ldquo;500&rdquo;</li></ul></li></ul></li><li>機械学習はこの問題は解決可能だが、検索ではこのような機能もやはりまだ必要である。<ul><li>IMO: Lucene の機能を使って解決可能なら、たしかにできる限り機械学習を使いたくない気持ちは非常に共感できる。ここまでレイテンシーの制約が厳しいなら増加要因は可能な限り抑えたい&mldr;</li></ul></li></ul></li></ul><h2 id=query-optimization>Query optimization<a hidden class=anchor aria-hidden=true href=#query-optimization>#</a></h2><ul><li>Indexed Queries<ul><li>多くのクエリは共通のフィルターを使っている。</li><li>大元のインデックスに対して、共通で使われているフィルターを適用した結果を、インデキシングしてる? (post-processing index)。</li><li>single term に置き換えて、パフォーマンスをチューニング</li></ul></li><li>Factoring queries<ul><li>Boolean query</li><li><a href=https://towardsdatascience.com/the-fp-growth-algorithm-1ffa20e839b8>FP growth algorithm</a></li></ul></li><li>Query 最適化のおかげで、 +30% redline QPS が増加。p99 latency は 81ms から 54ms へ。<ul><li>IMO: P99 のレイテンシー公開して良いだろうか&mldr;??? (p99.9 は公開していなかったので気になる)</li></ul></li><li>Indexing tuples<ul><li>multi stage search を single stage に圧縮している</li><li>IMO: ここらへんの最適化は、Lucene の検索の仕組みをもっと理解しないとどうやって実現しているかまだ深く理解できない</li></ul></li><li>Lighting deals using dimensional points<ul><li>当初は mike さんにより、地理検索などを目的として作られた機能。だが、地理検索には使用せず、Amazon での lighting deal に三次元データ(start time, end time, id) での三次元検索にこの dimensional points 機能を使ってる。</li><li>IMO: by @takuya-a さん - 社内で発表した際に、なぜ start-time, end-time の 2 次元ではなく、id を入れた 3 次元にした検索にしたのかという質問に対する完璧な @takuya-a さんの推測<ul><li><blockquote><p>ID も空間インデックスに含めることで、パフォーマンスを上げているのだとおもいます。ID が別フィールドだと、そっちのインデックスも検索して、空間インデックスの検索結果とマージして、って処理が後段で必要になるのですが、最初から ID も含めておくと BKD-tree の検索で全部処理できちゃうので。同じ期間で別の ID をもつセール対象商品がヒットしないので最初の段階でかなり絞り込めるようになるのだと思います</p></blockquote></li></ul></li><li>BKD tree の解説は @pon さんの記事がわかりやすいです<ul><li><a href=https://po3rin.com/blog/bkdtree>検索エンジンの数値インデックスを支える Bkd-Tree</a></li></ul></li></ul></li></ul><h2 id=multi-phase-ranking>Multi phase ranking<a hidden class=anchor aria-hidden=true href=#multi-phase-ranking>#</a></h2><ul><li>Ranking<ul><li>Machine Leraning models</li><li>Multi phase ranking</li><li><a href=https://issues.apache.org/jira/browse/LUCENE-8681>Prorated early termination</a><ul><li>IMO: スコアリングの知識が欠如しているのでメモだけ</li></ul></li></ul></li><li>Summary<ul><li>Amazon で検索してるときには Lucene が使われているよ 100%ではないけども</li></ul></li></ul><h2 id=question>Question<a hidden class=anchor aria-hidden=true href=#question>#</a></h2><ul><li>Q. indexing synonym を行っていると言っていたが、例えば query timing で synonym を扱えれば、検索者の文脈などを考慮した同義語を扱えるのではないのだろうか?<ul><li>A. indexing synonym は主に効率性を重視した意思決定であり、基本的にトレードオフの関係となっている。Query rewrite なども行っているが、今回のトークは主に検索エンジンなので優先順的に Query Understanding 関係の話はしていません。</li></ul></li></ul><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><ul><li><a href=https://aws.amazon.com/jp/blogs/opensource/amazon-giving-back-apache-lucene/>What Amazon gets by giving back to Apache Lucene</a></li></ul><p>Lucene に詳しい同僚からは、Lucene に興味あるならこの本がおすすめと言われので読んでおきたい。
ちなみに著者は、この講演者のうちの一人である Mike McCandless さん&mldr; (14 年間 Lucene の開発をしている!!)</p><ul><li><a href=https://amzn.to/3FP8DWn>Lucene in Action 2nd edition</a></li></ul><p>余談ですが、この人のことを同僚が、</p><blockquote><p>Lucene 界隈では神として知られていますね</p></blockquote><p>と言っていて、笑った w</p><hr><p><a href=https://adventar.org/calendars/6430>情報検索・検索技術 Advent Calendar 2021</a> の次の記事は
@sz_dr さんで 4 日目を担当してくれます!</p><h2>See Also</h2><ul><li><a href=/posts/2021-07-10/>eコマースの検索と推薦についてのサーベイ論文である 'Challenges and research opportunities in eCommerce search and recommendations' を社内勉強会で発表した</a></li><li><a href=/posts/2021-05-12/>[抄訳] 検索エンジンの達成度と検索チームの成熟度モデル</a></li><li><a href=/posts/2021-10-09/>クエリ分類(Query Classification) について社内の勉強会で話してきた</a></li><li><a href=/posts/2021-01-17/>TFXの歴史を振り返りつつ機械学習エンジニアリングを提案する論文「Towards ML Engineering: A Brief History Of TensorFlow Extended (TFX)」</a></li><li><a href=/posts/2020-04-25/>機械学習システムの信頼性を数値化し、技術的負債を解消する論文「 The ML Test Score: A Rubric for ML Production Readiness and Technical Debt Reduction」</a></li></ul><h2>Support</h2>記事をお読みくださりありがとうございます。このウェブサイトの運営を支援していただける方を募集しています。
もしよろしければ、下のボタンからサポート(投げ銭)していただけると、ブログ執筆、情報発信のモチベーションに繋がります✨
<a href=https://www.buymeacoffee.com/hurutoriya><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&emoji=☕&slug=hurutoriya&button_colour=FFDD00&font_colour=000000&font_family=Inter&outline_colour=000000&coffee_colour=ffffff"></a></div><footer class=post-footer><ul class=post-tags><li><a href=https://shunyaueta.com/tags/search/>search</a></li><li><a href=https://shunyaueta.com/tags/amazon/>amazon</a></li><li><a href=https://shunyaueta.com/tags/translation/>translation</a></li><li><a href=https://shunyaueta.com/tags/lucene/>lucene</a></li></ul><nav class=paginav><a class=prev href=https://shunyaueta.com/posts/2021-12-02/><span class=title>« 前のページ</span><br><span>kubernetes デプロイ時に `MatchExpressions:[]v1.LabelSelectorRequirement(nil)}: field is immutable` エラーが出た際に対処方法</span></a>
<a class=next href=https://shunyaueta.com/posts/2021-11-06/><span class=title>次のページ »</span><br><span>Standard SQLのCOALESCEで、時間経過によってカラム名が変化したデータを柔軟に抽出する</span></a></nav></footer><script src=https://giscus.app/client.js data-repo=hurutoriya/hurutoriya.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk2MDgyNTY1Nw==" data-category=Comments data-category-id=DIC_kwDOA6AgOc4CAQTX data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-theme=dark data-lang=ja crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://shunyaueta.com/>🦅 hurutoriya</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z" /></svg></a><script>let menu=document.getElementById('menu')
if(menu){menu.scrollLeft=localStorage.getItem("menu-scroll-position");menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft);}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.pushState(null,null,`#${id}`);}});});</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script><script>document.querySelectorAll('pre > code').forEach((codeblock)=>{const container=codeblock.parentNode.parentNode;const copybutton=document.createElement('button');copybutton.classList.add('copy-code');copybutton.innerText='copy';function copyingDone(){copybutton.innerText='copied!';setTimeout(()=>{copybutton.innerText='copy';},2000);}
copybutton.addEventListener('click',(cb)=>{if('clipboard'in navigator){navigator.clipboard.writeText(codeblock.textContent);copyingDone();return;}
const range=document.createRange();range.selectNodeContents(codeblock);const selection=window.getSelection();selection.removeAllRanges();selection.addRange(range);try{document.execCommand('copy');copyingDone();}catch(e){};selection.removeRange(range);});if(container.classList.contains("highlight")){container.appendChild(copybutton);}else if(container.parentNode.firstChild==container){}else if(codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"){codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);}else{codeblock.parentNode.appendChild(copybutton);}});</script></body></html>