<!doctype html><html><head><script data-ad-client=ca-pub-8604812913439531 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Pythonの関数のデフォルト引数はmutable(上書きされる) - Shunya Ueta</title><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:image" content><meta property="og:title" content="Pythonの関数のデフォルト引数はmutable(上書きされる)"><meta property="og:description" content="例えば以下のように、デフォルト引数で初期化を行い、文字列を追加する関数があるとする。 def append_to(values=[]): values.append(&#34;Hoge&#34;) return values 期待する振る舞いとしては。 In [14]: def append_to(values=[]): ...: values.append(&#34;Hoge&#34;) ...: return values ...: In [17]: append_to() Out[17]: ['Hoge'] In [18]: append_to() Out[18]: ['Hoge'] と関数呼び出しごとに、values は空のリストに初期化されるので上記のように返っ"><meta property="og:type" content="article"><meta property="og:url" content="https://shunyaueta.com/posts/2020-04-26/"><meta property="article:published_time" content="2020-04-26T12:04:13+09:00"><meta property="article:modified_time" content="2020-04-26T12:04:13+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Pythonの関数のデフォルト引数はmutable(上書きされる)"><meta name=twitter:description content="例えば以下のように、デフォルト引数で初期化を行い、文字列を追加する関数があるとする。 def append_to(values=[]): values.append(&#34;Hoge&#34;) return values 期待する振る舞いとしては。 In [14]: def append_to(values=[]): ...: values.append(&#34;Hoge&#34;) ...: return values ...: In [17]: append_to() Out[17]: ['Hoge'] In [18]: append_to() Out[18]: ['Hoge'] と関数呼び出しごとに、values は空のリストに初期化されるので上記のように返っ"><script src=https://shunyaueta.com/js/feather.min.js></script><link href=https://shunyaueta.com/css/fonts.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://shunyaueta.com/css/main.css><link rel=stylesheet type=text/css href=https://shunyaueta.com/css/dark.css media="(prefers-color-scheme: dark)"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-39994406-11"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-39994406-11');</script></head><body><div class=content><header><div class=main><a href=https://shunyaueta.com/>Shunya Ueta</a></div><nav><a href=/posts>All posts</a>
<a href=/about>About</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>Pythonの関数のデフォルト引数はmutable(上書きされる)</h1><div class=meta>Posted on Apr 26, 2020</div></div><section class=body><p>例えば以下のように、デフォルト引数で初期化を行い、文字列を追加する関数があるとする。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>append_to</span>(values<span style=color:#f92672>=</span>[]):
    values<span style=color:#f92672>.</span>append(<span style=color:#e6db74>&#34;Hoge&#34;</span>)
    <span style=color:#66d9ef>return</span> values
</code></pre></div><p>期待する振る舞いとしては。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>In [<span style=color:#ae81ff>14</span>]: <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>append_to</span>(values<span style=color:#f92672>=</span>[]):
    <span style=color:#f92672>...</span>:     values<span style=color:#f92672>.</span>append(<span style=color:#e6db74>&#34;Hoge&#34;</span>)
    <span style=color:#f92672>...</span>:     <span style=color:#66d9ef>return</span> values
    <span style=color:#f92672>...</span>:

In [<span style=color:#ae81ff>17</span>]: append_to()
Out[<span style=color:#ae81ff>17</span>]: [<span style=color:#e6db74>&#39;Hoge&#39;</span>]

In [<span style=color:#ae81ff>18</span>]: append_to()
Out[<span style=color:#ae81ff>18</span>]: [<span style=color:#e6db74>&#39;Hoge&#39;</span>]
</code></pre></div><p>と関数呼び出しごとに、<code>values</code> は空のリストに初期化されるので上記のように返ってきてほしい</p><p>だが、実際に表示されるのは</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>In [<span style=color:#ae81ff>14</span>]: <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>append_to</span>(values<span style=color:#f92672>=</span>[]):
    <span style=color:#f92672>...</span>:     values<span style=color:#f92672>.</span>append(<span style=color:#e6db74>&#34;Hoge&#34;</span>)
    <span style=color:#f92672>...</span>:     <span style=color:#66d9ef>return</span> values
    <span style=color:#f92672>...</span>:

In [<span style=color:#ae81ff>17</span>]: append_to()
Out[<span style=color:#ae81ff>17</span>]: [<span style=color:#e6db74>&#39;Hoge&#39;</span>]

In [<span style=color:#ae81ff>18</span>]: append_to()
Out[<span style=color:#ae81ff>18</span>]: [<span style=color:#e6db74>&#39;Hoge&#39;</span>, <span style=color:#e6db74>&#39;Hoge&#39;</span>]
</code></pre></div><p>である。</p><p>実際に内部で何が起きているかというと</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>In [<span style=color:#ae81ff>23</span>]: <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>append_to</span>(values<span style=color:#f92672>=</span>[]):
    <span style=color:#f92672>...</span>:     values<span style=color:#f92672>.</span>append(<span style=color:#e6db74>&#34;Hoge&#34;</span>)
    <span style=color:#f92672>...</span>:     <span style=color:#66d9ef>return</span> values
    <span style=color:#f92672>...</span>:

In [<span style=color:#ae81ff>24</span>]: pinfo append_to
Signature: append_to(values<span style=color:#f92672>=</span>[])
Docstring: <span style=color:#f92672>&lt;</span>no docstring<span style=color:#f92672>&gt;</span>
File:      <span style=color:#f92672>~/&lt;</span>ipython<span style=color:#f92672>-</span>input<span style=color:#f92672>-</span><span style=color:#ae81ff>23</span><span style=color:#f92672>-</span><span style=color:#ae81ff>4530</span>a91351ab<span style=color:#f92672>&gt;</span>
Type:      function

In [<span style=color:#ae81ff>25</span>]: append_to()
Out[<span style=color:#ae81ff>25</span>]: [<span style=color:#e6db74>&#39;Hoge&#39;</span>]

In [<span style=color:#ae81ff>26</span>]: pinfo append_to
Signature: append_to(values<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;Hoge&#39;</span>])
Docstring: <span style=color:#f92672>&lt;</span>no docstring<span style=color:#f92672>&gt;</span>
File:      <span style=color:#f92672>~/&lt;</span>ipython<span style=color:#f92672>-</span>input<span style=color:#f92672>-</span><span style=color:#ae81ff>23</span><span style=color:#f92672>-</span><span style=color:#ae81ff>4530</span>a91351ab<span style=color:#f92672>&gt;</span>
Type:      function

In [<span style=color:#ae81ff>27</span>]: append_to()
Out[<span style=color:#ae81ff>27</span>]: [<span style=color:#e6db74>&#39;Hoge&#39;</span>, <span style=color:#e6db74>&#39;Hoge&#39;</span>]

In [<span style=color:#ae81ff>28</span>]: pinfo append_to
Signature: append_to(values<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;Hoge&#39;</span>, <span style=color:#e6db74>&#39;Hoge&#39;</span>])
Docstring: <span style=color:#f92672>&lt;</span>no docstring<span style=color:#f92672>&gt;</span>
File:      <span style=color:#f92672>~/&lt;</span>ipython<span style=color:#f92672>-</span>input<span style=color:#f92672>-</span><span style=color:#ae81ff>23</span><span style=color:#f92672>-</span><span style=color:#ae81ff>4530</span>a91351ab<span style=color:#f92672>&gt;</span>
Type:      function
</code></pre></div><p>が起きている。
<code>pinfo</code> は ipython上で、オブジェクトの情報が確認できる便利コマンドです。
関数呼び出しごとに、デフォルト引数のvalues が上書きされていっていることがわかります。
これは、Pythonのデフォルト引数が、関数が定義されたときのみ評価され、毎回毎回評価されるわけではない。(Ruby は評価される)
ここでわかるのは、mutable</p><h2 id=対処方法>対処方法</h2><p>関数が呼び出されるごとに新しいオブジェクトを作成する。
何も設定されていないときは、デフォルト引数を使うことで検知する</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>append_to</span>(values<span style=color:#f92672>=</span>None):
    <span style=color:#66d9ef>if</span> values <span style=color:#f92672>is</span> None:
        values <span style=color:#f92672>=</span> []
    values<span style=color:#f92672>.</span>append(<span style=color:#e6db74>&#34;Hoge&#34;</span>)
    <span style=color:#66d9ef>return</span> values
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>In [<span style=color:#ae81ff>34</span>]: <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>append_to</span>(values<span style=color:#f92672>=</span>None):
    <span style=color:#f92672>...</span>:     <span style=color:#66d9ef>if</span> values <span style=color:#f92672>is</span> None:
    <span style=color:#f92672>...</span>:         values <span style=color:#f92672>=</span> []
    <span style=color:#f92672>...</span>:     values<span style=color:#f92672>.</span>append(<span style=color:#e6db74>&#34;Hoge&#34;</span>)
    <span style=color:#f92672>...</span>:     <span style=color:#66d9ef>return</span> values
    <span style=color:#f92672>...</span>:

In [<span style=color:#ae81ff>35</span>]: append_to()
Out[<span style=color:#ae81ff>35</span>]: [<span style=color:#e6db74>&#39;Hoge&#39;</span>]

In [<span style=color:#ae81ff>36</span>]: pinfo append_to
Signature: append_to(values<span style=color:#f92672>=</span>None)
Docstring: <span style=color:#f92672>&lt;</span>no docstring<span style=color:#f92672>&gt;</span>
File:      <span style=color:#f92672>~/&lt;</span>ipython<span style=color:#f92672>-</span>input<span style=color:#f92672>-</span><span style=color:#ae81ff>34</span><span style=color:#f92672>-</span><span style=color:#ae81ff>8e047</span>f793784<span style=color:#f92672>&gt;</span>
Type:      function

In [<span style=color:#ae81ff>37</span>]: append_to()
Out[<span style=color:#ae81ff>37</span>]: [<span style=color:#e6db74>&#39;Hoge&#39;</span>]

In [<span style=color:#ae81ff>38</span>]: pinfo append_to
Signature: append_to(values<span style=color:#f92672>=</span>None)
Docstring: <span style=color:#f92672>&lt;</span>no docstring<span style=color:#f92672>&gt;</span>
File:      <span style=color:#f92672>~/&lt;</span>ipython<span style=color:#f92672>-</span>input<span style=color:#f92672>-</span><span style=color:#ae81ff>34</span><span style=color:#f92672>-</span><span style=color:#ae81ff>8e047</span>f793784<span style=color:#f92672>&gt;</span>
Type:      function
</code></pre></div><p>想定通りの動きになった</p><h2 id=ref>Ref</h2><ul><li><a href=https://docs.python-guide.org/writing/gotchas/>https://docs.python-guide.org/writing/gotchas/</a></li><li><a href=http://moqada.hatenablog.com/entry/20090206/1233935560>http://moqada.hatenablog.com/entry/20090206/1233935560</a></li></ul></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/python>Python</a></li></ul></nav></div></article></main><h3>See Also</h3><ul><li><a href=/posts/2019-10-03/>pandas.read_gbq を使わずに、Google BigQueryから高速にData ETL</a></li><li><a href=/posts/2019-09-25/>Tensorboard を わずか2行で Jupyter Notebook上で表示</a></li><li><a href=/posts/2019-06-17/>How to concat image using skimage</a></li><li><a href=/posts/2018-01-15/>Jupyter Notebookの差分を明瞭に確認する事ができるpackage : nbdime</a></li><li><a href=/posts/2018-01-13/>PythonでGaussian Kernelのアニメーションを作成</a></li></ul><footer><hr><a class=soc href=https://github.com/hurutoriya title=GitHub><i data-feather=github></i></a>|<a class=soc href=https://twitter.com/hurutoriya/ title=Twitter><i data-feather=twitter></i></a>|⚡️
2021 © Shunya Ueta | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></footer><script>feather.replace()</script></div></body></html>