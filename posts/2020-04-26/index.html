<!doctype html><html><head><script data-ad-client=ca-pub-8604812913439531 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Shunya Ueta (a.k.a hurutoriya) personal website"><link rel="shortcut icon" href=https://shunyaueta.com/favicon.ico><link rel=stylesheet href=/css/style.min.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-39994406-11"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-39994406-11');</script><title>Pythonの関数のデフォルト引数はmutable(上書きされる)</title></head><body><header id=banner><h2><a href=https://shunyaueta.com/>Software Engineer as Data Scientist</a></h2><nav><ul><li><a href=/ title=posts>posts</a></li><li><a href=/about/ title=about>about</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Pythonの関数のデフォルト引数はmutable(上書きされる)</h1><time>2020-04-26</time></header><p>例えば以下のように、デフォルト引数で初期化を行い、文字列を追加する関数があるとする。</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>append_to</span><span class=p>(</span><span class=n>values</span><span class=o>=</span><span class=p>[]):</span>
    <span class=n>values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;Hoge&#34;</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>values</span>
</code></pre></div><p>期待する振る舞いとしては。</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>In</span> <span class=p>[</span><span class=mi>14</span><span class=p>]:</span> <span class=k>def</span> <span class=nf>append_to</span><span class=p>(</span><span class=n>values</span><span class=o>=</span><span class=p>[]):</span>
    <span class=o>...</span><span class=p>:</span>     <span class=n>values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;Hoge&#34;</span><span class=p>)</span>
    <span class=o>...</span><span class=p>:</span>     <span class=k>return</span> <span class=n>values</span>
    <span class=o>...</span><span class=p>:</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>17</span><span class=p>]:</span> <span class=n>append_to</span><span class=p>()</span>
<span class=n>Out</span><span class=p>[</span><span class=mi>17</span><span class=p>]:</span> <span class=p>[</span><span class=s1>&#39;Hoge&#39;</span><span class=p>]</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>18</span><span class=p>]:</span> <span class=n>append_to</span><span class=p>()</span>
<span class=n>Out</span><span class=p>[</span><span class=mi>18</span><span class=p>]:</span> <span class=p>[</span><span class=s1>&#39;Hoge&#39;</span><span class=p>]</span>
</code></pre></div><p>と関数呼び出しごとに、<code>values</code> は空のリストに初期化されるので上記のように返ってきてほしい</p><p>だが、実際に表示されるのは</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>In</span> <span class=p>[</span><span class=mi>14</span><span class=p>]:</span> <span class=k>def</span> <span class=nf>append_to</span><span class=p>(</span><span class=n>values</span><span class=o>=</span><span class=p>[]):</span>
    <span class=o>...</span><span class=p>:</span>     <span class=n>values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;Hoge&#34;</span><span class=p>)</span>
    <span class=o>...</span><span class=p>:</span>     <span class=k>return</span> <span class=n>values</span>
    <span class=o>...</span><span class=p>:</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>17</span><span class=p>]:</span> <span class=n>append_to</span><span class=p>()</span>
<span class=n>Out</span><span class=p>[</span><span class=mi>17</span><span class=p>]:</span> <span class=p>[</span><span class=s1>&#39;Hoge&#39;</span><span class=p>]</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>18</span><span class=p>]:</span> <span class=n>append_to</span><span class=p>()</span>
<span class=n>Out</span><span class=p>[</span><span class=mi>18</span><span class=p>]:</span> <span class=p>[</span><span class=s1>&#39;Hoge&#39;</span><span class=p>,</span> <span class=s1>&#39;Hoge&#39;</span><span class=p>]</span>
</code></pre></div><p>である。</p><p>実際に内部で何が起きているかというと</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>In</span> <span class=p>[</span><span class=mi>23</span><span class=p>]:</span> <span class=k>def</span> <span class=nf>append_to</span><span class=p>(</span><span class=n>values</span><span class=o>=</span><span class=p>[]):</span>
    <span class=o>...</span><span class=p>:</span>     <span class=n>values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;Hoge&#34;</span><span class=p>)</span>
    <span class=o>...</span><span class=p>:</span>     <span class=k>return</span> <span class=n>values</span>
    <span class=o>...</span><span class=p>:</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>24</span><span class=p>]:</span> <span class=n>pinfo</span> <span class=n>append_to</span>
<span class=n>Signature</span><span class=p>:</span> <span class=n>append_to</span><span class=p>(</span><span class=n>values</span><span class=o>=</span><span class=p>[])</span>
<span class=n>Docstring</span><span class=p>:</span> <span class=o>&lt;</span><span class=n>no</span> <span class=n>docstring</span><span class=o>&gt;</span>
<span class=n>File</span><span class=p>:</span>      <span class=o>~/&lt;</span><span class=n>ipython</span><span class=o>-</span><span class=nb>input</span><span class=o>-</span><span class=mi>23</span><span class=o>-</span><span class=mi>4530</span><span class=n>a91351ab</span><span class=o>&gt;</span>
<span class=n>Type</span><span class=p>:</span>      <span class=n>function</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>25</span><span class=p>]:</span> <span class=n>append_to</span><span class=p>()</span>
<span class=n>Out</span><span class=p>[</span><span class=mi>25</span><span class=p>]:</span> <span class=p>[</span><span class=s1>&#39;Hoge&#39;</span><span class=p>]</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>26</span><span class=p>]:</span> <span class=n>pinfo</span> <span class=n>append_to</span>
<span class=n>Signature</span><span class=p>:</span> <span class=n>append_to</span><span class=p>(</span><span class=n>values</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;Hoge&#39;</span><span class=p>])</span>
<span class=n>Docstring</span><span class=p>:</span> <span class=o>&lt;</span><span class=n>no</span> <span class=n>docstring</span><span class=o>&gt;</span>
<span class=n>File</span><span class=p>:</span>      <span class=o>~/&lt;</span><span class=n>ipython</span><span class=o>-</span><span class=nb>input</span><span class=o>-</span><span class=mi>23</span><span class=o>-</span><span class=mi>4530</span><span class=n>a91351ab</span><span class=o>&gt;</span>
<span class=n>Type</span><span class=p>:</span>      <span class=n>function</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>27</span><span class=p>]:</span> <span class=n>append_to</span><span class=p>()</span>
<span class=n>Out</span><span class=p>[</span><span class=mi>27</span><span class=p>]:</span> <span class=p>[</span><span class=s1>&#39;Hoge&#39;</span><span class=p>,</span> <span class=s1>&#39;Hoge&#39;</span><span class=p>]</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>28</span><span class=p>]:</span> <span class=n>pinfo</span> <span class=n>append_to</span>
<span class=n>Signature</span><span class=p>:</span> <span class=n>append_to</span><span class=p>(</span><span class=n>values</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;Hoge&#39;</span><span class=p>,</span> <span class=s1>&#39;Hoge&#39;</span><span class=p>])</span>
<span class=n>Docstring</span><span class=p>:</span> <span class=o>&lt;</span><span class=n>no</span> <span class=n>docstring</span><span class=o>&gt;</span>
<span class=n>File</span><span class=p>:</span>      <span class=o>~/&lt;</span><span class=n>ipython</span><span class=o>-</span><span class=nb>input</span><span class=o>-</span><span class=mi>23</span><span class=o>-</span><span class=mi>4530</span><span class=n>a91351ab</span><span class=o>&gt;</span>
<span class=n>Type</span><span class=p>:</span>      <span class=n>function</span>
</code></pre></div><p>が起きている。
<code>pinfo</code> は ipython上で、オブジェクトの情報が確認できる便利コマンドです。
関数呼び出しごとに、デフォルト引数のvalues が上書きされていっていることがわかります。
これは、Pythonのデフォルト引数が、関数が定義されたときのみ評価され、毎回毎回評価されるわけではない。(Ruby は評価される)
ここでわかるのは、mutable</p><h2 id=対処方法>対処方法</h2><p>関数が呼び出されるごとに新しいオブジェクトを作成する。
何も設定されていないときは、デフォルト引数を使うことで検知する</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>append_to</span><span class=p>(</span><span class=n>values</span><span class=o>=</span><span class=bp>None</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>values</span> <span class=ow>is</span> <span class=bp>None</span><span class=p>:</span>
        <span class=n>values</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;Hoge&#34;</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>values</span>
</code></pre></div><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>In</span> <span class=p>[</span><span class=mi>34</span><span class=p>]:</span> <span class=k>def</span> <span class=nf>append_to</span><span class=p>(</span><span class=n>values</span><span class=o>=</span><span class=bp>None</span><span class=p>):</span>
    <span class=o>...</span><span class=p>:</span>     <span class=k>if</span> <span class=n>values</span> <span class=ow>is</span> <span class=bp>None</span><span class=p>:</span>
    <span class=o>...</span><span class=p>:</span>         <span class=n>values</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=o>...</span><span class=p>:</span>     <span class=n>values</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;Hoge&#34;</span><span class=p>)</span>
    <span class=o>...</span><span class=p>:</span>     <span class=k>return</span> <span class=n>values</span>
    <span class=o>...</span><span class=p>:</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>35</span><span class=p>]:</span> <span class=n>append_to</span><span class=p>()</span>
<span class=n>Out</span><span class=p>[</span><span class=mi>35</span><span class=p>]:</span> <span class=p>[</span><span class=s1>&#39;Hoge&#39;</span><span class=p>]</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>36</span><span class=p>]:</span> <span class=n>pinfo</span> <span class=n>append_to</span>
<span class=n>Signature</span><span class=p>:</span> <span class=n>append_to</span><span class=p>(</span><span class=n>values</span><span class=o>=</span><span class=bp>None</span><span class=p>)</span>
<span class=n>Docstring</span><span class=p>:</span> <span class=o>&lt;</span><span class=n>no</span> <span class=n>docstring</span><span class=o>&gt;</span>
<span class=n>File</span><span class=p>:</span>      <span class=o>~/&lt;</span><span class=n>ipython</span><span class=o>-</span><span class=nb>input</span><span class=o>-</span><span class=mi>34</span><span class=o>-</span><span class=mf>8e047</span><span class=n>f793784</span><span class=o>&gt;</span>
<span class=n>Type</span><span class=p>:</span>      <span class=n>function</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>37</span><span class=p>]:</span> <span class=n>append_to</span><span class=p>()</span>
<span class=n>Out</span><span class=p>[</span><span class=mi>37</span><span class=p>]:</span> <span class=p>[</span><span class=s1>&#39;Hoge&#39;</span><span class=p>]</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>38</span><span class=p>]:</span> <span class=n>pinfo</span> <span class=n>append_to</span>
<span class=n>Signature</span><span class=p>:</span> <span class=n>append_to</span><span class=p>(</span><span class=n>values</span><span class=o>=</span><span class=bp>None</span><span class=p>)</span>
<span class=n>Docstring</span><span class=p>:</span> <span class=o>&lt;</span><span class=n>no</span> <span class=n>docstring</span><span class=o>&gt;</span>
<span class=n>File</span><span class=p>:</span>      <span class=o>~/&lt;</span><span class=n>ipython</span><span class=o>-</span><span class=nb>input</span><span class=o>-</span><span class=mi>34</span><span class=o>-</span><span class=mf>8e047</span><span class=n>f793784</span><span class=o>&gt;</span>
<span class=n>Type</span><span class=p>:</span>      <span class=n>function</span>
</code></pre></div><p>想定通りの動きになった</p><h2 id=ref>Ref</h2><ul><li><a href=https://docs.python-guide.org/writing/gotchas/>https://docs.python-guide.org/writing/gotchas/</a></li><li><a href=http://moqada.hatenablog.com/entry/20090206/1233935560>http://moqada.hatenablog.com/entry/20090206/1233935560</a></li></ul></article></main><h3>See Also</h3><ul><li><a href=/posts/2019-10-03/>pandas.read_gbq を使わずに、Google BigQueryから高速にData ETL</a></li><li><a href=/posts/2019-09-25/>Tensorboard を わずか2行で Jupyter Notebook上で表示</a></li><li><a href=/posts/2019-06-17/>How to concat image using skimage</a></li><li><a href=/posts/2018-01-15/>Jupyter Notebookの差分を明瞭に確認する事ができるpackage : nbdime</a></li><li><a href=/posts/2018-01-13/>PythonでGaussian Kernelのアニメーションを作成</a></li></ul><footer id=footer>Copyright © 2013-2021 Shunya Ueta</footer></body></html>