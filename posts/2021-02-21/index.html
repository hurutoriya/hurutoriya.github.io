<!doctype html><html><head><script data-ad-client=ca-pub-8604812913439531 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Shunya Ueta (a.k.a hurutoriya) personal website"><link rel="shortcut icon" href=https://shunyaueta.com/favicon.ico><link rel=stylesheet href=/css/style.min.css><script data-ad-client=ca-pub-8604812913439531 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><title>GKE でローリングアップデート後、ローカルからポートフォワードでリクエストを投げるとcurl: (52) Empty reply from server と返ってくるときの対処方法</title></head><body><header id=banner><h2><a href=https://shunyaueta.com/>Software Engineer as Data Scientist</a></h2><nav><ul><li><a href=/ title=posts>posts</a></li><li><a href=/about/ title=about>about</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>GKE でローリングアップデート後、ローカルからポートフォワードでリクエストを投げるとcurl: (52) Empty reply from server と返ってくるときの対処方法</h1><time>2021-02-21</time></header><h2 id=前提>前提</h2><p>ローカルから<code>kubectl</code>でポートフォワードして、GKEにリクエストを投げて確認を行っている</p><h2 id=発生した問題>発生した問題</h2><p>deployment のローリングアップデート前は問題なくポートフォワードを通してリクエストが返っていた。コードに変更を加えてGKE上でも確認をしたかったので、まずローカルで確認をして問題がなかった変更が、ローリングアップデート後ポートフォワード でGKE にリクエストを投げると <code>curl: (52) Empty reply from server</code> と返ってくる。</p><h2 id=tl-dr>TL; DR;</h2><ul><li>ポートフォワードはrolling update が終わったら貼り直そう。なぜなら、ポートフォワードの接続先はローリングアップデート前後で変化するため。</li></ul><h2 id=エラーメッセージ>エラーメッセージ</h2><p>curl でリクエストした際のメッセージ</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>curl: <span class=o>(</span>52<span class=o>)</span> Empty reply from server
</code></pre></div><p>Port foward の出力</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>uid : Error: No such container: xxxxx
</code></pre></div><h2 id=まとめ>まとめ</h2><p>発生していた問題は、ローリングアップデートを行うと、ポートフォワードの接続先が変更され、その際にローリングアップデート前後でkubectl でのポートフォワードは固定されたままなのでリクエストはサーバーから返ってこないという説明するのも恥ずかしい問題でした。</p><p>理由は単純だけど、気づくのに時間がかかってしまった。k8s の動きを理解していないからこういうので時間を溶かしてしまった。反省</p><h2 id=appendix>Appendix</h2><ul><li><a href=https://kubernetes.io/docs/tutorials/kubernetes-basics/update/update-intro/>Performing a Rolling Update</a></li></ul></article></main><h3>See Also</h3><ul><li><a href=/posts/2020-04-12/>Getting Started with Google Kubernetes Engine の講義を修了した</a></li><li><a href=/posts/2018-04-23/>Google Colaboratory で Mecab-ipadic-Neologd を使うまで</a></li></ul><footer id=footer>Copyright © 2013-2021 Shunya Ueta</footer></body></html>