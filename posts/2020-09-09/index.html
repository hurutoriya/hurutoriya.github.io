<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Shunya Ueta (a.k.a hurutoriya) personal website"><link rel="shortcut icon" href=https://shunyaueta.com/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>pandas を使って特定のディレクトリのCSVファイルをすべて連結して一つのCSVファイルを作成</title></head><body><header id=banner><h2><a href=https://shunyaueta.com/>Software Engineer as Data Scientist</a></h2><nav><ul><li><a href=/ title=posts>posts</a></li><li><a href=/about/ title=about>about</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>pandas を使って特定のディレクトリのCSVファイルをすべて連結して一つのCSVファイルを作成</h1><time>September 9, 2020</time></header><h2 id=目的>目的</h2><p>複数の同じフォーマットのCSVファイルが特定のディレクトリに配置されており、そのCSVファイル群を一つのCSVファイルに連結したい</p><p>今回は、PythonのPandas とpathlibを使って上記の目的を実現します。</p><h3 id=実行環境>実行環境</h3><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>In</span> <span class=p>[</span><span class=mi>1</span><span class=p>]:</span> <span class=kn>import</span> <span class=nn>pandas</span> <span class=kn>as</span> <span class=nn>pd</span>
<span class=n>In</span> <span class=p>[</span><span class=mi>2</span><span class=p>]:</span> <span class=n>pd</span><span class=o>.</span><span class=n>__version__</span>
<span class=n>Out</span><span class=p>[</span><span class=mi>2</span><span class=p>]:</span> <span class=s1>&#39;1.1.2</span>
<span class=n>In</span> <span class=p>[</span><span class=mi>3</span><span class=p>]:</span> <span class=kn>import</span> <span class=nn>sys</span>
   <span class=o>...</span><span class=p>:</span> <span class=k>print</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>version</span><span class=p>)</span>
<span class=mf>3.8</span><span class=o>.</span><span class=mi>2</span> <span class=p>(</span><span class=n>default</span><span class=p>,</span> <span class=n>Jul</span> <span class=mi>19</span> <span class=mi>2020</span><span class=p>,</span> <span class=mo>07</span><span class=p>:</span><span class=mi>23</span><span class=p>:</span><span class=mi>27</span><span class=p>)</span>
<span class=p>[</span><span class=n>Clang</span> <span class=mf>11.0</span><span class=o>.</span><span class=mi>3</span> <span class=p>(</span><span class=n>clang</span><span class=o>-</span><span class=mf>1103.0</span><span class=o>.</span><span class=mf>32.62</span><span class=p>)]</span>
</code></pre></div><p>目的となるcsvファイルは <code>tmp</code> ディレクトリに以下のような形式で配置されているとする</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>tmp
├── 1.csv
├── 2.csv
└── 3.csv
</code></pre></div><p>各ファイルはこのような形式で保存されています。</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>id  name  created
1   John  2020/09/10
2   bob   2020/09/10
3   taro  2020/09/11
</code></pre></div><p>以下のPythonスクリプトを実行</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>pathlib</span>
<span class=kn>import</span> <span class=nn>pandas</span> <span class=kn>as</span> <span class=nn>pd</span>


<span class=k>def</span> <span class=nf>contcat_csv</span><span class=p>(</span><span class=n>f_path</span><span class=p>:</span><span class=nb>str</span><span class=p>):</span>
    <span class=c1># pathlibのitedir()で対象とするディレクトリのCSVファイル一覧をジェネレーターとして取得</span>
    <span class=n>csvs</span> <span class=o>=</span> <span class=p>[</span><span class=n>pd</span><span class=o>.</span><span class=n>read_csv</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>path</span><span class=p>))</span> <span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>pathlib</span><span class=o>.</span><span class=n>Path</span><span class=p>(</span><span class=n>f_path</span><span class=p>)</span><span class=o>.</span><span class=n>glob</span><span class=p>(</span><span class=s1>&#39;*.csv&#39;</span><span class=p>)]</span>
    <span class=c1># そのファイル一覧をPandasで読み込んで、pd.concat()で連結してDataFrameとして返す</span>
    <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>csvs</span><span class=p>,</span> <span class=n>sort</span><span class=o>=</span><span class=bp>False</span><span class=p>)</span>

<span class=n>df</span> <span class=o>=</span> <span class=n>contcat_csv</span><span class=p>(</span><span class=s1>&#39;tmp&#39;</span><span class=p>)</span>
<span class=c1># 連結されたDataFrameをCSVとして保存する</span>
<span class=n>df</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span><span class=s1>&#39;concat.csv&#39;</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=bp>False</span><span class=p>)</span>

</code></pre></div><p>concat.csvを確認してみると</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>id  name    created
1   John    2020/09/10
2   bob     2020/09/10
3   taro    2020/09/11
4   hanako  2020/09/12
1   John    2020/09/10
2   bob     2020/09/10
3   taro    2020/09/11
4   hanako  2020/09/12
1   John    2020/09/10
2   bob     2020/09/10
3   taro    2020/09/11
4   hanako  2020/09/12
</code></pre></div><p>無事連結されたCSVを取得することができました</p><h2 id=追記>追記</h2><ul><li>2020-09-12: @siumachi さんから<a href=https://twitter.com/shiumachi/status/1304325924377096192>ご指摘</a>を受け、CSVファイル以外がディレクトリに混入していても問題ないように変更しました</li></ul><blockquote><p>拝見しました。forでディレクトリを走査するときは pathlib.Path.glob("*.csv&rdquo;)を使った方が、csv以外のファイルが混入したときの対策になると思ったのですが、いかがでしょう <a href=https://docs.python.org/ja/3/library/pathlib.html#pathlib.Path.glob>https://docs.python.org/ja/3/library/pathlib.html#pathlib.Path.glob</a></p></blockquote></article></main><footer id=footer>Copyright © 2013-2021 Shunya Ueta</footer></body></html>