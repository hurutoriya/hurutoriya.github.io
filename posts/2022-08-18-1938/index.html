<!doctype html><html lang=ja dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Apache Beam 2.40 ã§å°å…¥ã•ã‚ŒãŸ scikit-lean, Pytorch ã®åŠ¹ç‡çš„ãªæ¨è«–ãŒå¯èƒ½ã«ãªã‚‹ RunInference API ã‚’è©¦ã—ã¦ã¿ã‚‹ | ğŸ¦… hurutoriya</title><meta name=keywords content="apachebeam,machinelearning,python"><meta name=description content="2022-07-21 ã« Google Cloud ãŒ Cloud DataFlow ã®æ–°æ©Ÿèƒ½ã¨ã—ã¦ã€DataFlow ML ã¨ã„ã†æ–°æ©Ÿèƒ½ã‚’ç™ºè¡¨ã—ãŸã€‚1
 Dataflow MLÂ - Speaking of ML transforms, Dataflow now has added out of the box support for running PyTorch and scikit-learn models directly within the pipeline. The new RunInference transform enables simplicity by allowing models to be used in production pipelines with very little code. These features are in addition to Dataflow&rsquo;s existing ML capabilities such asÂ GPU supportÂ and the pre and post processing system for ML training, either directly or via frameworks such asÂ Tensorflow Extended (TFX)."><meta name=author content="Shunya Ueta"><link rel=canonical href=https://shunyaueta.com/posts/2022-08-18-1938/><link crossorigin=anonymous href=/assets/css/stylesheet.abc7c82c3d415a6df50430738d1cbcc4c76fea558bc5a0c830d3babf78167a35.css integrity="sha256-q8fILD1BWm31BDBzjRy8xMdv6lWLxaDIMNO6v3gWejU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad();></script><link rel=icon href=https://shunyaueta.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://shunyaueta.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://shunyaueta.com/favicon-32x32.png><link rel=apple-touch-icon href=https://shunyaueta.com/apple-touch-icon.png><link rel=mask-icon href=https://shunyaueta.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme: rgb(29, 30, 32);--entry: rgb(46, 46, 51);--primary: rgb(218, 218, 219);--secondary: rgb(155, 156, 157);--tertiary: rgb(65, 66, 68);--content: rgb(196, 196, 197);--hljs-bg: rgb(46, 46, 51);--code-bg: rgb(55, 56, 62);--border: rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-JMJRQJT0Q3"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-JMJRQJT0Q3');</script><meta property="og:title" content="Apache Beam 2.40 ã§å°å…¥ã•ã‚ŒãŸ scikit-lean, Pytorch ã®åŠ¹ç‡çš„ãªæ¨è«–ãŒå¯èƒ½ã«ãªã‚‹ RunInference API ã‚’è©¦ã—ã¦ã¿ã‚‹"><meta property="og:description" content="2022-07-21 ã« Google Cloud ãŒ Cloud DataFlow ã®æ–°æ©Ÿèƒ½ã¨ã—ã¦ã€DataFlow ML ã¨ã„ã†æ–°æ©Ÿèƒ½ã‚’ç™ºè¡¨ã—ãŸã€‚1
 Dataflow MLÂ - Speaking of ML transforms, Dataflow now has added out of the box support for running PyTorch and scikit-learn models directly within the pipeline. The new RunInference transform enables simplicity by allowing models to be used in production pipelines with very little code. These features are in addition to Dataflow&rsquo;s existing ML capabilities such asÂ GPU supportÂ and the pre and post processing system for ML training, either directly or via frameworks such asÂ Tensorflow Extended (TFX)."><meta property="og:type" content="article"><meta property="og:url" content="https://shunyaueta.com/posts/2022-08-18-1938/"><meta property="og:image" content="https://shunyaueta.com/ogp.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-18T19:38:29+09:00"><meta property="article:modified_time" content="2022-10-15T20:16:18+09:00"><meta property="og:site_name" content="Shunya Ueta"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://shunyaueta.com/ogp.jpg"><meta name=twitter:title content="Apache Beam 2.40 ã§å°å…¥ã•ã‚ŒãŸ scikit-lean, Pytorch ã®åŠ¹ç‡çš„ãªæ¨è«–ãŒå¯èƒ½ã«ãªã‚‹ RunInference API ã‚’è©¦ã—ã¦ã¿ã‚‹"><meta name=twitter:description content="2022-07-21 ã« Google Cloud ãŒ Cloud DataFlow ã®æ–°æ©Ÿèƒ½ã¨ã—ã¦ã€DataFlow ML ã¨ã„ã†æ–°æ©Ÿèƒ½ã‚’ç™ºè¡¨ã—ãŸã€‚1
 Dataflow MLÂ - Speaking of ML transforms, Dataflow now has added out of the box support for running PyTorch and scikit-learn models directly within the pipeline. The new RunInference transform enables simplicity by allowing models to be used in production pipelines with very little code. These features are in addition to Dataflow&rsquo;s existing ML capabilities such asÂ GPU supportÂ and the pre and post processing system for ML training, either directly or via frameworks such asÂ Tensorflow Extended (TFX)."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Apache Beam 2.40 ã§å°å…¥ã•ã‚ŒãŸ scikit-lean, Pytorch ã®åŠ¹ç‡çš„ãªæ¨è«–ãŒå¯èƒ½ã«ãªã‚‹ RunInference API ã‚’è©¦ã—ã¦ã¿ã‚‹","item":"https://shunyaueta.com/posts/2022-08-18-1938/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Apache Beam 2.40 ã§å°å…¥ã•ã‚ŒãŸ scikit-lean, Pytorch ã®åŠ¹ç‡çš„ãªæ¨è«–ãŒå¯èƒ½ã«ãªã‚‹ RunInference API ã‚’è©¦ã—ã¦ã¿ã‚‹","name":"Apache Beam 2.40 ã§å°å…¥ã•ã‚ŒãŸ scikit-lean, Pytorch ã®åŠ¹ç‡çš„ãªæ¨è«–ãŒå¯èƒ½ã«ãªã‚‹ RunInference API ã‚’è©¦ã—ã¦ã¿ã‚‹","description":"2022-07-21 ã« Google Cloud ãŒ Cloud DataFlow ã®æ–°æ©Ÿèƒ½ã¨ã—ã¦ã€DataFlow ML ã¨ã„ã†æ–°æ©Ÿèƒ½ã‚’ç™ºè¡¨ã—ãŸã€‚1\n Dataflow MLÂ - Speaking of ML transforms, Dataflow now has added out of the box support for running PyTorch and scikit-learn models directly within the pipeline. The new RunInference transform enables simplicity by allowing models to be used in production pipelines with very little code. These features are in addition to Dataflow\u0026rsquo;s existing ML capabilities such asÂ GPU supportÂ and the pre and post processing system for ML training, either directly or via frameworks such asÂ Tensorflow Extended (TFX).","keywords":["apachebeam","machinelearning","python"],"articleBody":"2022-07-21 ã« Google Cloud ãŒ Cloud DataFlow ã®æ–°æ©Ÿèƒ½ã¨ã—ã¦ã€DataFlow ML ã¨ã„ã†æ–°æ©Ÿèƒ½ã‚’ç™ºè¡¨ã—ãŸã€‚1\n Dataflow MLÂ - Speaking of ML transforms, Dataflow now has added out of the box support for running PyTorch and scikit-learn models directly within the pipeline. The new RunInference transform enables simplicity by allowing models to be used in production pipelines with very little code. These features are in addition to Dataflowâ€™s existing ML capabilities such asÂ GPU supportÂ and the pre and post processing system for ML training, either directly or via frameworks such asÂ Tensorflow Extended (TFX).\n DataFlow ã¯ Apache Beam ã§è¨˜è¿°ã—ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè¡Œç’°å¢ƒã ã€‚ ä¸»ã«ã€ãƒãƒƒãƒå‡¦ç†ãƒ»ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã§ä½¿ã‚ã‚Œã¦ãŠã‚Šã€æ©Ÿæ¢°å­¦ç¿’ã«æ¬ ã‹ã›ãªã„ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®è¦³ç‚¹ã‹ã‚‰ã—ã¦éå¸¸ã«é¢ç™½ã„ã¨æ€ã£ã¦ã„ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãªã®ã§ã€ç©æ¥µçš„ã«å‹•å‘ã‚’è¿½ã£ã¦ã„ã‚‹ã€‚\nDataFlow ML ã¯ç°¡å˜ã«èª¬æ˜ã™ã‚‹ã¨ã€PyTorch ã¨ scikit-learn ãŒ Dataflow ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å†…éƒ¨ã§ç›´æ¥æ¨è«–å¯èƒ½ã«ãªã£ãŸã€‚ ç›´è¿‘ã§ã¯ Python SDK ã«é™ã‚‹ãŒ DataFlow ã§ GPU ã®åˆ©ç”¨ãŒå¯èƒ½ã«ãªã£ãŸã‚Šã¨ã€å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚„æ©Ÿæ¢°å­¦ç¿’ã‚’è¡Œã†éš›ã«é­…åŠ›çš„ãªæ©Ÿèƒ½ãŒç¶šã€…ã¨ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¯ã˜ã‚ãŸã€‚ DataFlow ML ã®å®Ÿæ…‹ã¯ Apache Beam 2.40.0ã§è¿½åŠ ã•ã‚ŒãŸ RunInference API ã ã€‚ RunInference API ã® DesignDocs 2ãŒå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚’è¦‹ã¦ã¿ã‚‹ã€‚ æ©Ÿæ¢°å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ã® DesignDocs ã¨ã—ã¦éå¸¸ã«é¢ç™½ã„ã®ã§èˆˆå‘³ãŒã‚ã‚‹äººã¯ã€è¦‹ã¦ã¿ã‚‹ã¨é¢ç™½ã„ã¨ãŠã‚‚ã†ã€‚\nDesignDocs: RunInference: ML Inference in Beam RunInference API ãŒä½œã‚‰ã‚ŒãŸèƒŒæ™¯ã¨ã—ã¦ã€TensorFlow ã ã‘ãŒ Beam å†…éƒ¨ã§ã€å‡¦ç†ã™ã‚‹ãƒ‡ãƒ¼ã‚¿( Apache beam ã§ã¯PCollection ã¨å‘¼ã°ã‚Œã‚‹) ã«å¯¾ã—ã¦ã€æ¨è«–ã‚’è¡Œã†ãŸã‚ã® RunInference transformer (Apache Beam ã§ã¯ PTransformã¨å‘¼ã°ã‚Œã€PCollection ã‚’å…¥åŠ›ã¨ã—ã¦å‡¦ç†ã‚’è¡Œã†) ãŒå­˜åœ¨ã—ã¦ãŠã‚Šã€å®Ÿè£…ä¸è¦ã ã£ãŸã€‚\n å•é¡Œç‚¹ã¨ã—ã¦ã¯  Beam ã®ãƒ¬ãƒã‚¸ãƒˆãƒªã«å­˜åœ¨ã›ãšã€tensorflow/tfx-bslã®ãƒªãƒã‚¸ãƒˆãƒªã«å­˜åœ¨ã—ã¦ã„ã‚‹ã€‚ TFX ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ç‰¹åŒ–ã—ãŸ API ã«ãªã£ã¦ã„ã‚‹ ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ãŒå……å®Ÿã—ã¦ãŠã‚‰ãšã€å­¦ç¿’ã‚³ã‚¹ãƒˆãŒé«˜ã„    ã“ã® DesignDocs ã®ç›®çš„ã¯ã€RunInference API ã‚’ä»¥ä¸‹ã® 2 ã¤ã®äººæ°—ã®ã‚ã‚‹æ©Ÿæ¢°å­¦ç¿’ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ä½¿ãˆã‚‹ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã“ã¨\n scikit-learn PyTorch  å®Ÿè£…æ–¹æ³•ã¨ã—ã¦ã¯ã€\n å†…éƒ¨ã®æœ€é©åŒ–ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã¹ã å˜ç´”ã‹ã¤çµ±åˆã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã§æä¾›ã•ã‚Œã‚‹ã¹ã å…¥åŠ›ã¨å‡ºåŠ›ãŒã€æ©Ÿæ¢°å­¦ç¿’ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«å¯¾ã—ã¦ã€ç›´æ„Ÿçš„ãªå‹ã«ãªã£ã¦ã„ã‚‹ã¹ã  scikit-learn ãªã‚‰ numpy PyTorch ãªã‚‰ Tensors    æœ€çµ‚çš„ãªã‚´ãƒ¼ãƒ«ã¨ã—ã¦ã¯ã€XGBoost ã‚„ JAX ãªã©ä»–ã®æ©Ÿæ¢°å­¦ç¿’ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ã‚‚é©åˆã—ãŸã‚Šã€Vertex AI ãªã©å¤–éƒ¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ãŸã„ã€‚\nå†…éƒ¨ã®å®Ÿè£…æ–¹é‡ã¯ DesignDocs ã§è©³ç´°ã«è­°è«–ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã“ã¯å‰²æ„›ã—ã¦ã€ã¾ãšã¯ RunInference API ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å‹•ã‹ã—ã¦ã¿ã‚‹ã€‚\nã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’é€šã˜ã¦å­¦ã¶ Example RunInference API pipelinesã«ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¦ã„ãŸã®ã§ã€å‹•ã‹ã—ã¦ã¿ã‚‹ã€‚ ã¾ãšã¯ä¸€ç•ªç°¡å˜ãã†ãªã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã‚ã‚‹ scikit-learn ã«ã‚ˆã‚‹ MNIST åˆ†é¡ã‚’å‹•ã‹ã—ã¦ã¿ã‚‹ã€‚ æœ€åˆã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã˜ã£ãã‚Šèª­ã‚€ã‚ˆã‚Šã‚‚å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ãŸã»ã†ãŒç†è§£ãŒæ·±ã¾ã‚‹ã®ã§å®Ÿéš›ã«å‹•ã‹ã—ã¦ã¿ã‚‹ã®ãŒè¿‘é“ã€‚ ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰beam/sdks/python/apache_beam/examples/inference/sklearn_mnist_classification.py å…¬å¼ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã ã¨ã€æ¨è«–å¯¾è±¡ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¨å­¦ç¿’æ¸ˆã¿ã® scikit-learn ã®ãƒ¢ãƒ‡ãƒ«ã‚’è‡ªå‰ã§ç”¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã‚³ãƒãƒ³ãƒ‰ä¸€ç™ºã§ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å‹•ã‹ã›ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã®ãƒ¬ãƒã‚¸ãƒˆãƒªã«å…¬é–‹ã—ã¾ã—ãŸã€‚ å°†æ¥çš„ã«ã¯ scikit-learn ã ã‘ã§ãªãã€PyTorch ã«ã‚‚å¯¾å¿œã—ãŸã„ã€‚\nhttps://github.com/hurutoriya/beam-runinferenceapi-sample\nå®Ÿéš›ã«ä½•ã‚’ã‚„ã£ã¦ã„ã‚‹ã‹ã®è§£èª¬ã¯ã€æ—¥æœ¬èªã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ·»ãˆã¦è§£èª¬ã—ã¦ã¿ã¾ã™ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91  \"\"\"ã“ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯ã€RunInference APIã‚’ä½¿ã£ã¦ã€MNISTãƒ‡ãƒ¼ã‚¿ã®åˆ†é¡ã‚’è¡Œã†ã€‚ ã“ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯ã€int å½¢å¼ã§CSVå½¢å¼ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã€‚CSVã®ï¼‘ã¤ç›®ã®åˆ—ã¯ãƒ©ãƒ™ãƒ«ã€ãã®ã»ã‹ã®åˆ—ã¯MNISTã®ãƒ”ã‚¯ã‚»ãƒ«ã®å€¤ã‚’æ ¼ç´ã—ã¦ã„ã‚‹ã€‚ãƒ‡ãƒ¼ã‚¿ã¯å­¦ç¿’æ¸ˆã¿ã®ãƒ¢ãƒ‡ãƒ«ã§æ¨è«–ã•ã‚Œã‚‹ã€‚ã“ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯ output ãƒ•ã‚¡ã‚¤ãƒ«ã«æ¨è«–çµæœã®æ›¸ãè¾¼ã¿ã‚’è¡Œã„ã€ãƒ©ãƒ™ãƒ«ã¨æ¨è«–çµæœã®æ¯”è¼ƒã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã€‚ \"\"\" import argparse from typing import Iterable from typing import List from typing import Tuple import apache_beam as beam from apache_beam.ml.inference.base import KeyedModelHandler from apache_beam.ml.inference.base import PredictionResult from apache_beam.ml.inference.base import RunInference from apache_beam.ml.inference.sklearn_inference import ModelFileType from apache_beam.ml.inference.sklearn_inference import SklearnModelHandlerNumpy from apache_beam.options.pipeline_options import PipelineOptions from apache_beam.options.pipeline_options import SetupOptions def process_input(row: str) - Tuple[int, List[int: \"\"\"å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ©ãƒ™ãƒ«ã¨ãƒ”ã‚¯ã‚»ãƒ«ã«åˆ†ã‘ã¦ã€è¿”ã™ \"\"\" data = row.split(',') label, pixels = int(data[0]), data[1:] pixels = [int(pixel) for pixel in pixels] return label, pixels class PostProcessor(beam.DoFn): \"\"\"äºˆæ¸¬ãƒ©ãƒ™ãƒ«ã‚’å¾—ã‚‹ãŸã‚ã«äºˆæ¸¬çµæœã‚’å‡¦ç†ã™ã‚‹ã€‚CSVå½¢å¼ã§ã€çœŸå€¤ã¨äºˆæ¸¬ãƒ©ãƒ™ãƒ«ã‚’è¿”ã™ã€‚ \"\"\" def process(self, element: Tuple[int, PredictionResult]) - Iterable[str]: label, prediction_result = element prediction = prediction_result.inference yield '{},{}'.format(label, prediction) def parse_known_args(argv): \"\"\"å¼•æ•°ã‚’å®šç¾©\"\"\" parser = argparse.ArgumentParser() parser.add_argument( '--input_file', dest='input', required=True, help='text file with comma separated int values.') parser.add_argument( '--output', dest='output', required=True, help='Path to save output predictions.') parser.add_argument( '--model_path', dest='model_path', required=True, help='Path to load the Sklearn model for Inference.') return parser.parse_known_args(argv) def run(argv=None, save_main_session=True): \"\"\"ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å®šç¾©\"\"\" known_args, pipeline_args = parse_known_args(argv) pipeline_options = PipelineOptions(pipeline_args) pipeline_options.view_as(SetupOptions).save_main_session = save_main_session # ã“ã®ä¾‹ã§ã¯ã€RunInference ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚­ãƒ¼ã¨ãªã‚‹å…¥åŠ›ã‚’æ¸¡ã—ã¦ã„ã‚‹ã€‚ãã‚Œã«ã‚ˆã£ã¦ã€SklearnModelHandlerNumpy ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã§ã‚ã‚‹ KeyedModelHandler ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã€‚ model_loader = KeyedModelHandler( SklearnModelHandlerNumpy( model_file_type=ModelFileType.PICKLE, model_uri=known_args.model_path)) with beam.Pipeline(options=pipeline_options) as p: # å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ label_pixel_tuple = ( p | \"ReadFromInput\"  beam.io.ReadFromText( known_args.input, skip_header_lines=1) | \"PreProcessInputs\"  beam.Map(process_input)) # æ¨è«–ã—ã¦å¾Œå‡¦ç†ã‚’è¡Œã† predictions = ( label_pixel_tuple | \"RunInference\"  RunInference(model_loader) | \"PostProcessOutputs\"  beam.ParDo(PostProcessor())) # å¾Œå‡¦ç†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã™ã‚‹ _ = predictions | \"WriteOutput\"  beam.io.WriteToText( known_args.output, shard_name_template='', append_trailing_newlines=True) if __name__ == '__main__': run()   RunInference API ã«ã¤ã„ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰å­¦ã¶ RunInference API ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ3ãŒæ—¢ã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€èª­ã¿è¾¼ã‚€ã“ã¨ã§å®Ÿéš›ã«ã©ã‚“ãªæ¦‚å¿µã§ä½œæˆã•ã‚Œã¦ã„ã‚‹ã®ã‹ç†è§£ã§ãã‚‹ã€‚ Apache Beam ã®åŸºç¤çš„ãªæ¦‚å¿µã‚„ç”¨èªã«ã¤ã„ã¦ã¯ã€ã“ã®è¨˜äº‹ã‚’èª­ã‚€å‰ã«éå»ã«æ›¸ã„ãŸ Apache beam Python å…¥é–€ã‚’èª­ã‚“ã§ã„ãŸã ã‘ã‚‹ã¨ã€ã“ã®è¨˜äº‹ãŒåˆ†ã‹ã‚Šã‚„ã™ãèª­ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚\nãªãœ RunInferenceAPI ã‚’ä½¿ã†ã®ã‹? ãã‚‚ãã‚‚åƒ•ã®ç–‘å•ã¯ã€Œä»Šã¾ã§ã€Beam ã§ PyTorch ã‚„ scikit-learn ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ã¦æ¨è«–ã¯å¯èƒ½ã ã£ãŸãŒã€ RunInferenceAPI ã¯ä½•ãŒå¬‰ã—ã„ã®ã‹?ã€ã¸ã®ç­”ãˆãŒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã„ã¦ã‚ã‚Šã¾ã—ãŸã€‚\n BatchElementsãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã‚„Sharedã‚¯ãƒ©ã‚¹ãªã©æ—¢å­˜ã® Apache Beam ã®æ¦‚å¿µã«æ²¿ã£ã¦ã€æ©Ÿæ¢°å­¦ç¿’ã®æ¨è«–å‡¦ç†ã‚’æœ€é©åŒ–ãŒå¯èƒ½ã«ãªã‚‹ã€‚ã¾ãŸãƒãƒ«ãƒãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãªã©ã€è¤‡é›‘ãªãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ§‹ç¯‰ã‚‚æ¯”è¼ƒçš„ç°¡å˜ã«æ§‹ç¯‰ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚  BatchElements PTransform ã¨ã¯ å¤šãã®ãƒ¢ãƒ‡ãƒ«ãŒå®Ÿè£…ã—ã¦ã„ã‚‹ãƒ™ã‚¯ãƒˆãƒ«åŒ–æ¨è«–ã®æœ€é©åŒ–ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã€ãƒ¢ãƒ‡ãƒ«ã®äºˆæ¸¬ã‚’è¡Œã†å‰ã®ä¸­é–“æ®µéšã¨ã—ã¦ã€BatchElements ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã®è¿½åŠ ã—ãŸã€‚ã“ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã¯ã€è¦ç´ ã‚’ãƒãƒƒãƒå‡¦ç†ã™ã‚‹ã€‚ãã—ã¦ã€ãƒãƒƒãƒã•ã‚ŒãŸè¦ç´ ã¯ã€RunInference ã®ç‰¹å®šã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ãŸã‚ã®å¤‰æ›ã§é©ç”¨ã•ã‚Œã‚‹ã€‚ä¾‹ãˆã°ã€numpy ã® ndarrays ã®å ´åˆã¯ numpy.stack()ã‚’ã€torch ã® Tensor è¦ç´ ã®å ´åˆã¯ torch.stack()ã‚’å‘¼ã³å‡ºã™ã€‚\nbeam.BatchElements ã®è¨­å®šã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã«ã¯ã€ModelHandler ã®ä¸­ã§ã€batch_elements_kwargs é–¢æ•°ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ä¾‹ãˆã°ã€min_batch_size ã§ãƒãƒƒãƒã‚ãŸã‚Šã®è¦ç´ æ•°ã®æœ€å°å€¤ã‚’è¨­å®šã—ã€max_batch_size ã§ãƒãƒƒãƒã‚ãŸã‚Šã®è¦ç´ æ•°ã®æœ€å¤§å€¤ã‚’è¨­å®šã™ã‚‹ã€‚ è©³ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã“ã¡ã‚‰\nShared helper class RunInference API ã§Shared ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ãƒ—ãƒ­ã‚»ã‚¹ã”ã¨ã«ä¸€åº¦ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã å¾Œã«å„ãƒ—ãƒ­ã‚»ã‚¹å†…éƒ¨ã§ãã®èª­ã¿è¾¼ã‚“ã ãƒ¢ãƒ‡ãƒ«ã‚’DoFn(å…¨ã¦ã®PCollectionã«é©ç”¨ã•ã‚Œã‚‹å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿æŒã™ã‚‹)å†…ã§å…±æœ‰ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ã“ã®ã‚¯ãƒ©ã‚¹ã‚’ä½¿ãˆã°ã€ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿æ™‚é–“ã¨ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ã‚’å‰Šæ¸›ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚\nè©³ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ(ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰)ã¯ã“ã¡ã‚‰ã€‚å†…éƒ¨ã®å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯è‡ªä½“ 100 è¡Œæœªæº€ã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€èª­ã‚“ã§è¦‹ã‚‹ã®ã‚‚ã‚ã‚Šã€‚\næ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†ãŸã‚ã«ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ Apache Beam ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«è¿½åŠ ã™ã‚Œã°ã€RunInference ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½¿ç”¨ã§ãã‚‹ã€‚\n1 2 3 4  from apache_beam.ml.inference.base import RunInference with pipeline as p: predictions = ( p | 'Read'  beam.ReadFromSource('a_source') | 'RunInference'  RunInference(model_handler)   model_handler ã¯ã€ãƒ¢ãƒ‡ãƒ«ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ãŸã‚ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã§ã€ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒã§ãã‚‹ã€‚ ä»¥ä¸‹ã®ã‚ˆã†ãªModelHandlerã®ä¾‹ãŒã‚ã‚‹\n1 2 3 4  from apache_beam.ml.inference.sklearn_inference import SklearnModelHandlerNumpy from apache_beam.ml.inference.sklearn_inference import SklearnModelHandlerPandas from apache_beam.ml.inference.pytorch_inference import PytorchModelHandlerTensor from apache_beam.ml.inference.pytorch_inference import PytorchModelHandlerKeyedTensor   ãƒ¢ãƒ‡ãƒ« A ã¨ ãƒ¢ãƒ‡ãƒ« B ã®æ¨è«–çµæœã‚’ä¸¦åˆ—ã—ã¦è¡Œã£ãŸã‚Šã€\n1 2 3 4  with pipeline as p: data = p | 'Read'  beam.ReadFromSource('a_source') model_a_predictions = data | RunInference(model_handler_A) model_b_predictions = data | RunInference(model_handler_B)   ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«ã‚‚æŸ”è»Ÿã«è¨˜è¿°ã§ãã‚‹ã€‚\n1 2 3 4 5  with pipeline as p: data = p | 'Read'  beam.ReadFromSource('a_source') model_a_predictions = data | RunInference(model_handler_A) model_b_predictions = model_a_predictions | beam.Map(some_post_processing) | RunInference(model_handler_B)   ã¾ãŸé©šããªã®ãŒã€Apache Beam 2.41.0 ç§»è¡Œã¯ Multi Language SDKã«ã‚ˆã£ã¦ã€ Java ã‹ã‚‰ã‚‚ RunInference API ã‚’ä½¿ã†ã“ã¨ãŒã§ãã‚‹ã‚‰ã—ã„ã€‚ ã“ã‚Œã£ã¦ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰ã¯ Python ã§è¡Œã£ã¦ã€é‹ç”¨ã¯å®‰å®šã—ãŸ Java ã§å®Ÿè¡Œå¯èƒ½ã¨ã„ã†ã“ã¨ãªã®ã§å‡„ã„æ©Ÿèƒ½ã§ã™ã­ã€‚\nhttps://github.com/apache/beam/blob/master/sdks/java/extensions/python/src/main/java/org/apache/beam/sdk/extensions/python/transforms/RunInference.java\nMulti Language SDK ã‚‚éå¸¸ã«é¢ç™½ãã†ã ãŒã€ã¾ã ä½¿ã£ãŸã“ã¨ã¯ãªã„ã®ã§ã€å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’ã‹ãã¤ã¤ç†è§£ã‚’æ·±ã‚ãŸã„ã€‚\nã¾ã¨ã‚ Apache Beam 2.40.0 ã‹ã‚‰åˆ©ç”¨å¯èƒ½ã«ãªã£ãŸ RunInference API ã«ã¤ã„ã¦ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¨å…±ã«ä½•ã‚’ã‚„ã£ã¦ã„ã‚‹ã‹ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚\nApache Beam ã¯ã¨ã¦ã‚‚æœªæ¥ã‚’æ„Ÿã˜ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãªã®ã§ã€ã“ã® OSS ã«ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã§ãã‚‹ä½™åœ°ãŒã‚ã‚Œã°ç©æ¥µçš„ã«ã‚„ã£ã¦ã„ããŸã„ã€‚ ãã®ãŸã‚ã€ã“ã‚Œã‹ã‚‰ã¯ã¡ã‚‡ã£ã¨ã—ãŸ Beam ã®å‹‰å¼·ãƒ¡ãƒ¢ãªã©ã‚‚ç©æ¥µçš„ã«å…¬é–‹ã•ã‚Œã¦ã„ãã¨æ€ã„ã¾ã™ã€‚\n  Latest Dataflow innovations for real-time streaming and AI/ML | Google Cloud Blog â†©ï¸\n RunInference: ML Inference in Beam â†©ï¸\n Apache Beam Python Machine Learning â†©ï¸\n   ","wordCount":"756","inLanguage":"ja","datePublished":"2022-08-18T19:38:29+09:00","dateModified":"2022-10-15T20:16:18+09:00","author":{"@type":"Person","name":"Shunya Ueta"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://shunyaueta.com/posts/2022-08-18-1938/"},"publisher":{"@type":"Organization","name":"ğŸ¦… hurutoriya","logo":{"@type":"ImageObject","url":"https://shunyaueta.com/favicon.ico"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><header class=header><nav class=nav><div class=logo><a href=https://shunyaueta.com/ accesskey=h title="ğŸ¦… hurutoriya (Alt + H)">ğŸ¦… hurutoriya</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://shunyaueta.com/archives title=Archive><span>Archive</span></a></li><li><a href=https://shunyaueta.com/about title=About><span>About</span></a></li><li><a href=https://shunyaueta.com/tags/newsletter/ title=Newsletter><span>Newsletter</span></a></li><li><a href=https://shunyaueta.com/index.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Apache Beam 2.40 ã§å°å…¥ã•ã‚ŒãŸ scikit-lean, Pytorch ã®åŠ¹ç‡çš„ãªæ¨è«–ãŒå¯èƒ½ã«ãªã‚‹ RunInference API ã‚’è©¦ã—ã¦ã¿ã‚‹</h1><div class=post-meta><span title="2022-08-18 19:38:29 +0900 +0900">August 18, 2022</span>&nbsp;Â·&nbsp;Shunya Ueta</div></header><div class=post-content><p><code>2022-07-21</code> ã« Google Cloud ãŒ Cloud DataFlow ã®æ–°æ©Ÿèƒ½ã¨ã—ã¦ã€DataFlow ML ã¨ã„ã†æ–°æ©Ÿèƒ½ã‚’ç™ºè¡¨ã—ãŸã€‚<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><blockquote><p><strong>Dataflow ML</strong>Â - Speaking of ML transforms, Dataflow now has added out of the box support for running PyTorch and scikit-learn models directly within the pipeline. The new RunInference transform enables simplicity by allowing models to be used in production pipelines with very little code. These features are in addition to Dataflow&rsquo;s existing ML capabilities such asÂ <a href=https://cloud.google.com/dataflow/docs/guides/using-gpus>GPU support</a>Â and the pre and post processing system for ML training, either directly or via frameworks such asÂ <a href=https://www.tensorflow.org/tfx>Tensorflow Extended (TFX)</a>.</p></blockquote><p>DataFlow ã¯ Apache Beam ã§è¨˜è¿°ã—ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè¡Œç’°å¢ƒã ã€‚
ä¸»ã«ã€ãƒãƒƒãƒå‡¦ç†ãƒ»ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã§ä½¿ã‚ã‚Œã¦ãŠã‚Šã€æ©Ÿæ¢°å­¦ç¿’ã«æ¬ ã‹ã›ãªã„ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®è¦³ç‚¹ã‹ã‚‰ã—ã¦éå¸¸ã«é¢ç™½ã„ã¨æ€ã£ã¦ã„ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãªã®ã§ã€ç©æ¥µçš„ã«å‹•å‘ã‚’è¿½ã£ã¦ã„ã‚‹ã€‚</p><p>DataFlow ML ã¯ç°¡å˜ã«èª¬æ˜ã™ã‚‹ã¨ã€PyTorch ã¨ scikit-learn ãŒ Dataflow ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å†…éƒ¨ã§ç›´æ¥æ¨è«–å¯èƒ½ã«ãªã£ãŸã€‚
ç›´è¿‘ã§ã¯ Python SDK ã«é™ã‚‹ãŒ DataFlow ã§ GPU ã®åˆ©ç”¨ãŒå¯èƒ½ã«ãªã£ãŸã‚Šã¨ã€å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚„æ©Ÿæ¢°å­¦ç¿’ã‚’è¡Œã†éš›ã«é­…åŠ›çš„ãªæ©Ÿèƒ½ãŒç¶šã€…ã¨ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¯ã˜ã‚ãŸã€‚
DataFlow ML ã®å®Ÿæ…‹ã¯ <a href=https://beam.apache.org/blog/beam-2.40.0>Apache Beam 2.40.0</a>ã§è¿½åŠ ã•ã‚ŒãŸ RunInference API ã ã€‚
RunInference API ã® DesignDocs <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>ãŒå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚’è¦‹ã¦ã¿ã‚‹ã€‚
æ©Ÿæ¢°å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ã® DesignDocs ã¨ã—ã¦éå¸¸ã«é¢ç™½ã„ã®ã§èˆˆå‘³ãŒã‚ã‚‹äººã¯ã€è¦‹ã¦ã¿ã‚‹ã¨é¢ç™½ã„ã¨ãŠã‚‚ã†ã€‚</p><h2 id=designdocs-runinference-ml-inference-in-beam>DesignDocs: RunInference: ML Inference in Beam<a hidden class=anchor aria-hidden=true href=#designdocs-runinference-ml-inference-in-beam>#</a></h2><p>RunInference API ãŒä½œã‚‰ã‚ŒãŸèƒŒæ™¯ã¨ã—ã¦ã€TensorFlow ã ã‘ãŒ Beam å†…éƒ¨ã§ã€å‡¦ç†ã™ã‚‹ãƒ‡ãƒ¼ã‚¿( Apache beam ã§ã¯<code>PCollection</code> ã¨å‘¼ã°ã‚Œã‚‹) ã«å¯¾ã—ã¦ã€æ¨è«–ã‚’è¡Œã†ãŸã‚ã® <a href=https://github.com/tensorflow/tfx-bsl/blob/master/tfx_bsl/beam/run_inference.py>RunInference transformer</a> (Apache Beam ã§ã¯ <code>PTransform</code>ã¨å‘¼ã°ã‚Œã€<code>PCollection</code> ã‚’å…¥åŠ›ã¨ã—ã¦å‡¦ç†ã‚’è¡Œã†) ãŒå­˜åœ¨ã—ã¦ãŠã‚Šã€å®Ÿè£…ä¸è¦ã ã£ãŸã€‚</p><ul><li>å•é¡Œç‚¹ã¨ã—ã¦ã¯<ul><li>Beam ã®ãƒ¬ãƒã‚¸ãƒˆãƒªã«å­˜åœ¨ã›ãšã€<a href=https://github.com/tensorflow/tfx-bsl>tensorflow/tfx-bsl</a>ã®ãƒªãƒã‚¸ãƒˆãƒªã«å­˜åœ¨ã—ã¦ã„ã‚‹ã€‚</li><li>TFX ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ç‰¹åŒ–ã—ãŸ API ã«ãªã£ã¦ã„ã‚‹</li><li>ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ãŒå……å®Ÿã—ã¦ãŠã‚‰ãšã€å­¦ç¿’ã‚³ã‚¹ãƒˆãŒé«˜ã„</li></ul></li></ul><p>ã“ã® DesignDocs ã®ç›®çš„ã¯ã€RunInference API ã‚’ä»¥ä¸‹ã® 2 ã¤ã®äººæ°—ã®ã‚ã‚‹æ©Ÿæ¢°å­¦ç¿’ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ä½¿ãˆã‚‹ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã“ã¨</p><ul><li>scikit-learn</li><li>PyTorch</li></ul><p>å®Ÿè£…æ–¹æ³•ã¨ã—ã¦ã¯ã€</p><ul><li>å†…éƒ¨ã®æœ€é©åŒ–ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã¹ã</li><li>å˜ç´”ã‹ã¤çµ±åˆã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã§æä¾›ã•ã‚Œã‚‹ã¹ã</li><li>å…¥åŠ›ã¨å‡ºåŠ›ãŒã€æ©Ÿæ¢°å­¦ç¿’ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«å¯¾ã—ã¦ã€ç›´æ„Ÿçš„ãªå‹ã«ãªã£ã¦ã„ã‚‹ã¹ã<ul><li>scikit-learn ãªã‚‰ numpy</li><li>PyTorch ãªã‚‰ Tensors</li></ul></li></ul><p>æœ€çµ‚çš„ãªã‚´ãƒ¼ãƒ«ã¨ã—ã¦ã¯ã€XGBoost ã‚„ JAX ãªã©ä»–ã®æ©Ÿæ¢°å­¦ç¿’ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ã‚‚é©åˆã—ãŸã‚Šã€Vertex AI ãªã©å¤–éƒ¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ãŸã„ã€‚</p><p>å†…éƒ¨ã®å®Ÿè£…æ–¹é‡ã¯ DesignDocs ã§è©³ç´°ã«è­°è«–ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã“ã¯å‰²æ„›ã—ã¦ã€ã¾ãšã¯ RunInference API ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å‹•ã‹ã—ã¦ã¿ã‚‹ã€‚</p><h2 id=ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’é€šã˜ã¦å­¦ã¶>ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’é€šã˜ã¦å­¦ã¶<a hidden class=anchor aria-hidden=true href=#ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’é€šã˜ã¦å­¦ã¶>#</a></h2><p><a href=https://github.com/apache/beam/tree/master/sdks/python/apache_beam/examples/inference>Example RunInference API pipelines</a>ã«ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¦ã„ãŸã®ã§ã€å‹•ã‹ã—ã¦ã¿ã‚‹ã€‚
ã¾ãšã¯ä¸€ç•ªç°¡å˜ãã†ãªã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã‚ã‚‹ scikit-learn ã«ã‚ˆã‚‹ MNIST åˆ†é¡ã‚’å‹•ã‹ã—ã¦ã¿ã‚‹ã€‚
æœ€åˆã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã˜ã£ãã‚Šèª­ã‚€ã‚ˆã‚Šã‚‚å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ãŸã»ã†ãŒç†è§£ãŒæ·±ã¾ã‚‹ã®ã§å®Ÿéš›ã«å‹•ã‹ã—ã¦ã¿ã‚‹ã®ãŒè¿‘é“ã€‚
ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰<a href=https://github.com/apache/beam/blob/master/sdks/python/apache_beam/examples/inference/sklearn_mnist_classification.py>beam/sdks/python/apache_beam/examples/inference/sklearn_mnist_classification.py</a>
å…¬å¼ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã ã¨ã€æ¨è«–å¯¾è±¡ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¨å­¦ç¿’æ¸ˆã¿ã® scikit-learn ã®ãƒ¢ãƒ‡ãƒ«ã‚’è‡ªå‰ã§ç”¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã‚³ãƒãƒ³ãƒ‰ä¸€ç™ºã§ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å‹•ã‹ã›ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã®ãƒ¬ãƒã‚¸ãƒˆãƒªã«å…¬é–‹ã—ã¾ã—ãŸã€‚
å°†æ¥çš„ã«ã¯ scikit-learn ã ã‘ã§ãªãã€PyTorch ã«ã‚‚å¯¾å¿œã—ãŸã„ã€‚</p><p><a href=https://github.com/hurutoriya/beam-runinferenceapi-sample>https://github.com/hurutoriya/beam-runinferenceapi-sample</a></p><p>å®Ÿéš›ã«ä½•ã‚’ã‚„ã£ã¦ã„ã‚‹ã‹ã®è§£èª¬ã¯ã€æ—¥æœ¬èªã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ·»ãˆã¦è§£èª¬ã—ã¦ã¿ã¾ã™ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=s2>&#34;&#34;&#34;ã“ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯ã€RunInference APIã‚’ä½¿ã£ã¦ã€MNISTãƒ‡ãƒ¼ã‚¿ã®åˆ†é¡ã‚’è¡Œã†ã€‚
</span><span class=s2>
</span><span class=s2>ã“ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯ã€int å½¢å¼ã§CSVå½¢å¼ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã€‚CSVã®ï¼‘ã¤ç›®ã®åˆ—ã¯ãƒ©ãƒ™ãƒ«ã€ãã®ã»ã‹ã®åˆ—ã¯MNISTã®ãƒ”ã‚¯ã‚»ãƒ«ã®å€¤ã‚’æ ¼ç´ã—ã¦ã„ã‚‹ã€‚ãƒ‡ãƒ¼ã‚¿ã¯å­¦ç¿’æ¸ˆã¿ã®ãƒ¢ãƒ‡ãƒ«ã§æ¨è«–ã•ã‚Œã‚‹ã€‚ã“ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯ output ãƒ•ã‚¡ã‚¤ãƒ«ã«æ¨è«–çµæœã®æ›¸ãè¾¼ã¿ã‚’è¡Œã„ã€ãƒ©ãƒ™ãƒ«ã¨æ¨è«–çµæœã®æ¯”è¼ƒã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã€‚
</span><span class=s2>&#34;&#34;&#34;</span>

<span class=kn>import</span> <span class=nn>argparse</span>
<span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Iterable</span>
<span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
<span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Tuple</span>

<span class=kn>import</span> <span class=nn>apache_beam</span> <span class=kn>as</span> <span class=nn>beam</span>
<span class=kn>from</span> <span class=nn>apache_beam.ml.inference.base</span> <span class=kn>import</span> <span class=n>KeyedModelHandler</span>
<span class=kn>from</span> <span class=nn>apache_beam.ml.inference.base</span> <span class=kn>import</span> <span class=n>PredictionResult</span>
<span class=kn>from</span> <span class=nn>apache_beam.ml.inference.base</span> <span class=kn>import</span> <span class=n>RunInference</span>
<span class=kn>from</span> <span class=nn>apache_beam.ml.inference.sklearn_inference</span> <span class=kn>import</span> <span class=n>ModelFileType</span>
<span class=kn>from</span> <span class=nn>apache_beam.ml.inference.sklearn_inference</span> <span class=kn>import</span> <span class=n>SklearnModelHandlerNumpy</span>
<span class=kn>from</span> <span class=nn>apache_beam.options.pipeline_options</span> <span class=kn>import</span> <span class=n>PipelineOptions</span>
<span class=kn>from</span> <span class=nn>apache_beam.options.pipeline_options</span> <span class=kn>import</span> <span class=n>SetupOptions</span>

<span class=k>def</span> <span class=nf>process_input</span><span class=p>(</span><span class=n>row</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>:</span>
  <span class=s2>&#34;&#34;&#34;å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ©ãƒ™ãƒ«ã¨ãƒ”ã‚¯ã‚»ãƒ«ã«åˆ†ã‘ã¦ã€è¿”ã™
</span><span class=s2>  &#34;&#34;&#34;</span>
  <span class=n>data</span> <span class=o>=</span> <span class=n>row</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>)</span>
  <span class=n>label</span><span class=p>,</span> <span class=n>pixels</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=n>data</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span>
  <span class=n>pixels</span> <span class=o>=</span> <span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>pixel</span><span class=p>)</span> <span class=k>for</span> <span class=n>pixel</span> <span class=ow>in</span> <span class=n>pixels</span><span class=p>]</span>
  <span class=k>return</span> <span class=n>label</span><span class=p>,</span> <span class=n>pixels</span>


<span class=k>class</span> <span class=nc>PostProcessor</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>DoFn</span><span class=p>):</span>
  <span class=s2>&#34;&#34;&#34;äºˆæ¸¬ãƒ©ãƒ™ãƒ«ã‚’å¾—ã‚‹ãŸã‚ã«äºˆæ¸¬çµæœã‚’å‡¦ç†ã™ã‚‹ã€‚CSVå½¢å¼ã§ã€çœŸå€¤ã¨äºˆæ¸¬ãƒ©ãƒ™ãƒ«ã‚’è¿”ã™ã€‚
</span><span class=s2>  &#34;&#34;&#34;</span>
  <span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>element</span><span class=p>:</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=n>PredictionResult</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Iterable</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
    <span class=n>label</span><span class=p>,</span> <span class=n>prediction_result</span> <span class=o>=</span> <span class=n>element</span>
    <span class=n>prediction</span> <span class=o>=</span> <span class=n>prediction_result</span><span class=o>.</span><span class=n>inference</span>
    <span class=k>yield</span> <span class=s1>&#39;{},{}&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>label</span><span class=p>,</span> <span class=n>prediction</span><span class=p>)</span>


<span class=k>def</span> <span class=nf>parse_known_args</span><span class=p>(</span><span class=n>argv</span><span class=p>):</span>
  <span class=s2>&#34;&#34;&#34;å¼•æ•°ã‚’å®šç¾©&#34;&#34;&#34;</span>
  <span class=n>parser</span> <span class=o>=</span> <span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>()</span>
  <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
      <span class=s1>&#39;--input_file&#39;</span><span class=p>,</span>
      <span class=n>dest</span><span class=o>=</span><span class=s1>&#39;input&#39;</span><span class=p>,</span>
      <span class=n>required</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span>
      <span class=n>help</span><span class=o>=</span><span class=s1>&#39;text file with comma separated int values.&#39;</span><span class=p>)</span>
  <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
      <span class=s1>&#39;--output&#39;</span><span class=p>,</span>
      <span class=n>dest</span><span class=o>=</span><span class=s1>&#39;output&#39;</span><span class=p>,</span>
      <span class=n>required</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span>
      <span class=n>help</span><span class=o>=</span><span class=s1>&#39;Path to save output predictions.&#39;</span><span class=p>)</span>
  <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
      <span class=s1>&#39;--model_path&#39;</span><span class=p>,</span>
      <span class=n>dest</span><span class=o>=</span><span class=s1>&#39;model_path&#39;</span><span class=p>,</span>
      <span class=n>required</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span>
      <span class=n>help</span><span class=o>=</span><span class=s1>&#39;Path to load the Sklearn model for Inference.&#39;</span><span class=p>)</span>
  <span class=k>return</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_known_args</span><span class=p>(</span><span class=n>argv</span><span class=p>)</span>


<span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>argv</span><span class=o>=</span><span class=bp>None</span><span class=p>,</span> <span class=n>save_main_session</span><span class=o>=</span><span class=bp>True</span><span class=p>):</span>
  <span class=s2>&#34;&#34;&#34;ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å®šç¾©&#34;&#34;&#34;</span>
  <span class=n>known_args</span><span class=p>,</span> <span class=n>pipeline_args</span> <span class=o>=</span> <span class=n>parse_known_args</span><span class=p>(</span><span class=n>argv</span><span class=p>)</span>
  <span class=n>pipeline_options</span> <span class=o>=</span> <span class=n>PipelineOptions</span><span class=p>(</span><span class=n>pipeline_args</span><span class=p>)</span>
  <span class=n>pipeline_options</span><span class=o>.</span><span class=n>view_as</span><span class=p>(</span><span class=n>SetupOptions</span><span class=p>)</span><span class=o>.</span><span class=n>save_main_session</span> <span class=o>=</span> <span class=n>save_main_session</span>

  <span class=c1># ã“ã®ä¾‹ã§ã¯ã€RunInference ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚­ãƒ¼ã¨ãªã‚‹å…¥åŠ›ã‚’æ¸¡ã—ã¦ã„ã‚‹ã€‚ãã‚Œã«ã‚ˆã£ã¦ã€SklearnModelHandlerNumpy ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã§ã‚ã‚‹ KeyedModelHandler ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã€‚</span>
  <span class=n>model_loader</span> <span class=o>=</span> <span class=n>KeyedModelHandler</span><span class=p>(</span>
      <span class=n>SklearnModelHandlerNumpy</span><span class=p>(</span>
          <span class=n>model_file_type</span><span class=o>=</span><span class=n>ModelFileType</span><span class=o>.</span><span class=n>PICKLE</span><span class=p>,</span>
          <span class=n>model_uri</span><span class=o>=</span><span class=n>known_args</span><span class=o>.</span><span class=n>model_path</span><span class=p>))</span>

  <span class=k>with</span> <span class=n>beam</span><span class=o>.</span><span class=n>Pipeline</span><span class=p>(</span><span class=n>options</span><span class=o>=</span><span class=n>pipeline_options</span><span class=p>)</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
	<span class=c1># å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</span>
    <span class=n>label_pixel_tuple</span> <span class=o>=</span> <span class=p>(</span>
        <span class=n>p</span>
        <span class=o>|</span> <span class=s2>&#34;ReadFromInput&#34;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>ReadFromText</span><span class=p>(</span>
            <span class=n>known_args</span><span class=o>.</span><span class=n>input</span><span class=p>,</span> <span class=n>skip_header_lines</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
        <span class=o>|</span> <span class=s2>&#34;PreProcessInputs&#34;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>Map</span><span class=p>(</span><span class=n>process_input</span><span class=p>))</span>
	<span class=c1># æ¨è«–ã—ã¦å¾Œå‡¦ç†ã‚’è¡Œã†</span>
    <span class=n>predictions</span> <span class=o>=</span> <span class=p>(</span>
        <span class=n>label_pixel_tuple</span>
        <span class=o>|</span> <span class=s2>&#34;RunInference&#34;</span> <span class=o>&gt;&gt;</span> <span class=n>RunInference</span><span class=p>(</span><span class=n>model_loader</span><span class=p>)</span>
        <span class=o>|</span> <span class=s2>&#34;PostProcessOutputs&#34;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span><span class=n>PostProcessor</span><span class=p>()))</span>
	<span class=c1># å¾Œå‡¦ç†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã™ã‚‹</span>
    <span class=n>_</span> <span class=o>=</span> <span class=n>predictions</span> <span class=o>|</span> <span class=s2>&#34;WriteOutput&#34;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>WriteToText</span><span class=p>(</span>
        <span class=n>known_args</span><span class=o>.</span><span class=n>output</span><span class=p>,</span>
        <span class=n>shard_name_template</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=n>append_trailing_newlines</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>


<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
  <span class=n>run</span><span class=p>()</span>
</code></pre></td></tr></table></div></div><h2 id=runinference-api-ã«ã¤ã„ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰å­¦ã¶>RunInference API ã«ã¤ã„ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰å­¦ã¶<a hidden class=anchor aria-hidden=true href=#runinference-api-ã«ã¤ã„ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰å­¦ã¶>#</a></h2><p>RunInference API ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>ãŒæ—¢ã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€èª­ã¿è¾¼ã‚€ã“ã¨ã§å®Ÿéš›ã«ã©ã‚“ãªæ¦‚å¿µã§ä½œæˆã•ã‚Œã¦ã„ã‚‹ã®ã‹ç†è§£ã§ãã‚‹ã€‚
Apache Beam ã®åŸºç¤çš„ãªæ¦‚å¿µã‚„ç”¨èªã«ã¤ã„ã¦ã¯ã€ã“ã®è¨˜äº‹ã‚’èª­ã‚€å‰ã«éå»ã«æ›¸ã„ãŸ Apache beam Python å…¥é–€ã‚’èª­ã‚“ã§ã„ãŸã ã‘ã‚‹ã¨ã€ã“ã®è¨˜äº‹ãŒåˆ†ã‹ã‚Šã‚„ã™ãèª­ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚</p><h3 id=ãªãœ-runinferenceapi-ã‚’ä½¿ã†ã®ã‹>ãªãœ RunInferenceAPI ã‚’ä½¿ã†ã®ã‹?<a hidden class=anchor aria-hidden=true href=#ãªãœ-runinferenceapi-ã‚’ä½¿ã†ã®ã‹>#</a></h3><p>ãã‚‚ãã‚‚åƒ•ã®ç–‘å•ã¯ã€Œä»Šã¾ã§ã€Beam ã§ PyTorch ã‚„ scikit-learn ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ã¦æ¨è«–ã¯å¯èƒ½ã ã£ãŸãŒã€ RunInferenceAPI ã¯ä½•ãŒå¬‰ã—ã„ã®ã‹?ã€ã¸ã®ç­”ãˆãŒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã„ã¦ã‚ã‚Šã¾ã—ãŸã€‚</p><ul><li><code>BatchElements</code>ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã‚„<code>Shared</code>ã‚¯ãƒ©ã‚¹ãªã©æ—¢å­˜ã® Apache Beam ã®æ¦‚å¿µã«æ²¿ã£ã¦ã€æ©Ÿæ¢°å­¦ç¿’ã®æ¨è«–å‡¦ç†ã‚’æœ€é©åŒ–ãŒå¯èƒ½ã«ãªã‚‹ã€‚ã¾ãŸãƒãƒ«ãƒãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãªã©ã€è¤‡é›‘ãªãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ§‹ç¯‰ã‚‚æ¯”è¼ƒçš„ç°¡å˜ã«æ§‹ç¯‰ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚</li></ul><h3 id=batchelements-ptransform-ã¨ã¯>BatchElements PTransform ã¨ã¯<a hidden class=anchor aria-hidden=true href=#batchelements-ptransform-ã¨ã¯>#</a></h3><p>å¤šãã®ãƒ¢ãƒ‡ãƒ«ãŒå®Ÿè£…ã—ã¦ã„ã‚‹ãƒ™ã‚¯ãƒˆãƒ«åŒ–æ¨è«–ã®æœ€é©åŒ–ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã€ãƒ¢ãƒ‡ãƒ«ã®äºˆæ¸¬ã‚’è¡Œã†å‰ã®ä¸­é–“æ®µéšã¨ã—ã¦ã€BatchElements ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã®è¿½åŠ ã—ãŸã€‚ã“ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã¯ã€è¦ç´ ã‚’ãƒãƒƒãƒå‡¦ç†ã™ã‚‹ã€‚ãã—ã¦ã€ãƒãƒƒãƒã•ã‚ŒãŸè¦ç´ ã¯ã€RunInference ã®ç‰¹å®šã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ãŸã‚ã®å¤‰æ›ã§é©ç”¨ã•ã‚Œã‚‹ã€‚ä¾‹ãˆã°ã€numpy ã® ndarrays ã®å ´åˆã¯ numpy.stack()ã‚’ã€torch ã® Tensor è¦ç´ ã®å ´åˆã¯ torch.stack()ã‚’å‘¼ã³å‡ºã™ã€‚</p><p>beam.BatchElements ã®è¨­å®šã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã«ã¯ã€ModelHandler ã®ä¸­ã§ã€batch_elements_kwargs é–¢æ•°ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ä¾‹ãˆã°ã€<code>min_batch_size</code> ã§ãƒãƒƒãƒã‚ãŸã‚Šã®è¦ç´ æ•°ã®æœ€å°å€¤ã‚’è¨­å®šã—ã€<code>max_batch_size</code> ã§ãƒãƒƒãƒã‚ãŸã‚Šã®è¦ç´ æ•°ã®æœ€å¤§å€¤ã‚’è¨­å®šã™ã‚‹ã€‚
è©³ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯<a href=https://beam.apache.org/releases/pydoc/current/apache_beam.transforms.util.html#apache_beam.transforms.util.BatchElements>ã“ã¡ã‚‰</a></p><h3 id=shared-helper-class>Shared helper class<a hidden class=anchor aria-hidden=true href=#shared-helper-class>#</a></h3><p>RunInference API ã§<code>Shared</code> ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ãƒ—ãƒ­ã‚»ã‚¹ã”ã¨ã«ä¸€åº¦ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã å¾Œã«å„ãƒ—ãƒ­ã‚»ã‚¹å†…éƒ¨ã§ãã®èª­ã¿è¾¼ã‚“ã ãƒ¢ãƒ‡ãƒ«ã‚’<code>DoFn</code>(å…¨ã¦ã®<code>PCollection</code>ã«é©ç”¨ã•ã‚Œã‚‹å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿æŒã™ã‚‹)å†…ã§å…±æœ‰ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ã“ã®ã‚¯ãƒ©ã‚¹ã‚’ä½¿ãˆã°ã€ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿æ™‚é–“ã¨ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ã‚’å‰Šæ¸›ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚</p><p>è©³ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ(ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰)ã¯<a href=https://github.com/apache/beam/blob/master/sdks/python/apache_beam/utils/shared.py#L20>ã“ã¡ã‚‰</a>ã€‚å†…éƒ¨ã®å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯è‡ªä½“ 100 è¡Œæœªæº€ã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€èª­ã‚“ã§è¦‹ã‚‹ã®ã‚‚ã‚ã‚Šã€‚</p><h3 id=æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†ãŸã‚ã«ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹>æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†ãŸã‚ã«ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹<a hidden class=anchor aria-hidden=true href=#æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†ãŸã‚ã«ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹>#</a></h3><p>ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ Apache Beam ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«è¿½åŠ ã™ã‚Œã°ã€RunInference ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½¿ç”¨ã§ãã‚‹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>apache_beam.ml.inference.base</span> <span class=kn>import</span> <span class=n>RunInference</span>
<span class=k>with</span> <span class=n>pipeline</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
   <span class=n>predictions</span> <span class=o>=</span> <span class=p>(</span> <span class=n>p</span> <span class=o>|</span>  <span class=s1>&#39;Read&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ReadFromSource</span><span class=p>(</span><span class=s1>&#39;a_source&#39;</span><span class=p>)</span>
                     <span class=o>|</span> <span class=s1>&#39;RunInference&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>RunInference</span><span class=p>(</span><span class=o>&lt;</span><span class=n>model_handler</span><span class=o>&gt;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p><code>model_handler</code> ã¯ã€ãƒ¢ãƒ‡ãƒ«ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ãŸã‚ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã§ã€ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒã§ãã‚‹ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ãª<code>ModelHandler</code>ã®ä¾‹ãŒã‚ã‚‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>apache_beam.ml.inference.sklearn_inference</span> <span class=kn>import</span> <span class=n>SklearnModelHandlerNumpy</span>
<span class=kn>from</span> <span class=nn>apache_beam.ml.inference.sklearn_inference</span> <span class=kn>import</span> <span class=n>SklearnModelHandlerPandas</span>
<span class=kn>from</span> <span class=nn>apache_beam.ml.inference.pytorch_inference</span> <span class=kn>import</span> <span class=n>PytorchModelHandlerTensor</span>
<span class=kn>from</span> <span class=nn>apache_beam.ml.inference.pytorch_inference</span> <span class=kn>import</span> <span class=n>PytorchModelHandlerKeyedTensor</span>
</code></pre></td></tr></table></div></div><p>ãƒ¢ãƒ‡ãƒ« A ã¨ ãƒ¢ãƒ‡ãƒ« B ã®æ¨è«–çµæœã‚’ä¸¦åˆ—ã—ã¦è¡Œã£ãŸã‚Šã€</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>with</span> <span class=n>pipeline</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
   <span class=n>data</span> <span class=o>=</span> <span class=n>p</span> <span class=o>|</span> <span class=s1>&#39;Read&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ReadFromSource</span><span class=p>(</span><span class=s1>&#39;a_source&#39;</span><span class=p>)</span>
   <span class=n>model_a_predictions</span> <span class=o>=</span> <span class=n>data</span> <span class=o>|</span> <span class=n>RunInference</span><span class=p>(</span><span class=o>&lt;</span><span class=n>model_handler_A</span><span class=o>&gt;</span><span class=p>)</span>
   <span class=n>model_b_predictions</span> <span class=o>=</span> <span class=n>data</span> <span class=o>|</span> <span class=n>RunInference</span><span class=p>(</span><span class=o>&lt;</span><span class=n>model_handler_B</span><span class=o>&gt;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«ã‚‚æŸ”è»Ÿã«è¨˜è¿°ã§ãã‚‹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>with</span> <span class=n>pipeline</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
   <span class=n>data</span> <span class=o>=</span> <span class=n>p</span> <span class=o>|</span> <span class=s1>&#39;Read&#39;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ReadFromSource</span><span class=p>(</span><span class=s1>&#39;a_source&#39;</span><span class=p>)</span>
   <span class=n>model_a_predictions</span> <span class=o>=</span> <span class=n>data</span> <span class=o>|</span> <span class=n>RunInference</span><span class=p>(</span><span class=o>&lt;</span><span class=n>model_handler_A</span><span class=o>&gt;</span><span class=p>)</span>
   <span class=n>model_b_predictions</span> <span class=o>=</span> <span class=n>model_a_predictions</span> <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>Map</span><span class=p>(</span><span class=n>some_post_processing</span><span class=p>)</span> <span class=o>|</span> <span class=n>RunInference</span><span class=p>(</span><span class=o>&lt;</span><span class=n>model_handler_B</span><span class=o>&gt;</span><span class=p>)</span>

</code></pre></td></tr></table></div></div><p>ã¾ãŸé©šããªã®ãŒã€Apache Beam 2.41.0 ç§»è¡Œã¯ <a href=https://beam.apache.org/documentation/programming-guide/#multi-language-pipelines>Multi Language SDK</a>ã«ã‚ˆã£ã¦ã€ Java ã‹ã‚‰ã‚‚ RunInference API ã‚’ä½¿ã†ã“ã¨ãŒã§ãã‚‹ã‚‰ã—ã„ã€‚
ã“ã‚Œã£ã¦ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰ã¯ Python ã§è¡Œã£ã¦ã€é‹ç”¨ã¯å®‰å®šã—ãŸ Java ã§å®Ÿè¡Œå¯èƒ½ã¨ã„ã†ã“ã¨ãªã®ã§å‡„ã„æ©Ÿèƒ½ã§ã™ã­ã€‚</p><p><a href=https://github.com/apache/beam/blob/master/sdks/java/extensions/python/src/main/java/org/apache/beam/sdk/extensions/python/transforms/RunInference.java>https://github.com/apache/beam/blob/master/sdks/java/extensions/python/src/main/java/org/apache/beam/sdk/extensions/python/transforms/RunInference.java</a></p><p>Multi Language SDK ã‚‚éå¸¸ã«é¢ç™½ãã†ã ãŒã€ã¾ã ä½¿ã£ãŸã“ã¨ã¯ãªã„ã®ã§ã€å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’ã‹ãã¤ã¤ç†è§£ã‚’æ·±ã‚ãŸã„ã€‚</p><h2 id=ã¾ã¨ã‚>ã¾ã¨ã‚<a hidden class=anchor aria-hidden=true href=#ã¾ã¨ã‚>#</a></h2><p>Apache Beam 2.40.0 ã‹ã‚‰åˆ©ç”¨å¯èƒ½ã«ãªã£ãŸ RunInference API ã«ã¤ã„ã¦ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¨å…±ã«ä½•ã‚’ã‚„ã£ã¦ã„ã‚‹ã‹ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚</p><p>Apache Beam ã¯ã¨ã¦ã‚‚æœªæ¥ã‚’æ„Ÿã˜ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãªã®ã§ã€ã“ã® OSS ã«ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã§ãã‚‹ä½™åœ°ãŒã‚ã‚Œã°ç©æ¥µçš„ã«ã‚„ã£ã¦ã„ããŸã„ã€‚
ãã®ãŸã‚ã€ã“ã‚Œã‹ã‚‰ã¯ã¡ã‚‡ã£ã¨ã—ãŸ Beam ã®å‹‰å¼·ãƒ¡ãƒ¢ãªã©ã‚‚ç©æ¥µçš„ã«å…¬é–‹ã•ã‚Œã¦ã„ãã¨æ€ã„ã¾ã™ã€‚</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://cloud.google.com/blog/products/data-analytics/latest-dataflow-innovations-for-real-time-streaming-and-aiml>Latest Dataflow innovations for real-time streaming and AI/ML | Google Cloud Blog</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href="https://docs.google.com/document/d/1bVMU7Uo9Nzuu6aXR702j74nhQK4j6J1lkRVVBRySI0g/edit#heading=h.cqivojrr7lme">RunInference: ML Inference in Beam</a> <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p><a href=https://beam.apache.org/documentation/sdks/python-machine-learning/>Apache Beam Python Machine Learning</a> <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section><h2>See Also</h2><ul><li><a href=/posts/2020-12-26/>Pythonã§Apache beam å…¥é–€</a></li><li><a href=/posts/2017-11-14/>OpenCV 3.3ã‹ã‚‰ä½¿ãˆã‚‹DNNãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ç‰©ä½“æ¤œå‡º</a></li><li><a href=/posts/2022-08-15-2335/>KDD2022 ã§æ°—ã«ãªã£ãŸç ”ç©¶</a></li><li><a href=/posts/2022-08-10-1717/>poetry show ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã« (!) ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹æ„å‘³</a></li><li><a href=/posts/2022-05-10-2200/>ç¤¾å†…ã§ãƒ‡ãƒ¼ã‚¿åˆ†æçµæœã‚’å¯è¦–åŒ–ãƒ»å…±æœ‰ã™ã‚‹éš›ã« Google Colab ãŒä¾¿åˆ©</a></li></ul><h2>Support</h2>è¨˜äº‹ã‚’ãŠèª­ã¿ãã ã•ã‚Šã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã“ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®é‹å–¶ã‚’æ”¯æ´ã—ã¦ã„ãŸã ã‘ã‚‹æ–¹ã‚’å‹Ÿé›†ã—ã¦ã„ã¾ã™ã€‚
ã‚‚ã—ã‚ˆã‚ã—ã‘ã‚Œã°ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚µãƒãƒ¼ãƒˆ(æŠ•ã’éŠ­)ã—ã¦ã„ãŸã ã‘ã‚‹ã¨ã€ãƒ–ãƒ­ã‚°åŸ·ç­†ã€æƒ…å ±ç™ºä¿¡ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã«ç¹‹ãŒã‚Šã¾ã™âœ¨
<a href=https://www.buymeacoffee.com/hurutoriya><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&emoji=â˜•&slug=hurutoriya&button_colour=FFDD00&font_colour=000000&font_family=Inter&outline_colour=000000&coffee_colour=ffffff"></a></div><footer class=post-footer><ul class=post-tags><li><a href=https://shunyaueta.com/tags/apachebeam/>apachebeam</a></li><li><a href=https://shunyaueta.com/tags/machinelearning/>machinelearning</a></li><li><a href=https://shunyaueta.com/tags/python/>python</a></li></ul><nav class=paginav><a class=prev href=https://shunyaueta.com/posts/2022-08-22-1300/><span class=title>Â« å‰ã®ãƒšãƒ¼ã‚¸</span><br><span>Java ã® memory map ã‚’ç†è§£ã™ã‚‹</span></a>
<a class=next href=https://shunyaueta.com/posts/2022-08-15-2335/><span class=title>æ¬¡ã®ãƒšãƒ¼ã‚¸ Â»</span><br><span>KDD2022 ã§æ°—ã«ãªã£ãŸç ”ç©¶</span></a></nav></footer><script src=https://giscus.app/client.js data-repo=hurutoriya/hurutoriya.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk2MDgyNTY1Nw==" data-category=Comments data-category-id=DIC_kwDOA6AgOc4CAQTX data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-theme=dark data-lang=ja crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://shunyaueta.com/>ğŸ¦… hurutoriya</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z" /></svg></a><script>let menu=document.getElementById('menu')
if(menu){menu.scrollLeft=localStorage.getItem("menu-scroll-position");menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft);}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.pushState(null,null,`#${id}`);}});});</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script><script>document.querySelectorAll('pre > code').forEach((codeblock)=>{const container=codeblock.parentNode.parentNode;const copybutton=document.createElement('button');copybutton.classList.add('copy-code');copybutton.innerHTML='ã‚³ãƒ”ãƒ¼';function copyingDone(){copybutton.innerHTML='ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸ!';setTimeout(()=>{copybutton.innerHTML='ã‚³ãƒ”ãƒ¼';},2000);}
copybutton.addEventListener('click',(cb)=>{if('clipboard'in navigator){navigator.clipboard.writeText(codeblock.textContent);copyingDone();return;}
const range=document.createRange();range.selectNodeContents(codeblock);const selection=window.getSelection();selection.removeAllRanges();selection.addRange(range);try{document.execCommand('copy');copyingDone();}catch(e){};selection.removeRange(range);});if(container.classList.contains("highlight")){container.appendChild(copybutton);}else if(container.parentNode.firstChild==container){}else if(codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"){codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);}else{codeblock.parentNode.appendChild(copybutton);}});</script></body></html>