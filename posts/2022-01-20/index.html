<!doctype html><html lang=ja><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>OSS の Google BigQuery UDF `bqutil.fn` を使えば UDF の独自実装を置き換えられるかもしれない | Shunya Ueta</title><meta name=title content="OSS の Google BigQuery UDF `bqutil.fn` を使えば UDF の独自実装を置き換えられるかもしれない"><meta name=description content="TL;DR; UDF を独自実装する前に、bqutil.fnを眺めておくと車輪の再発明が回避できるかも
背景 SQL は、特定の処理を行う際にデータの型が同一でないとエラーが発生しますが、もとのスキーマを紹介するよりももっとお手軽にカラムの型を確認したいときがありませんか?
例えば、出力結果を見ただけでは、12345 が STRING なのか INT64 なのか判別不可能ですよね。(もし判別可能な方法知っている人いたら教えて下さい&mldr;)
GCP による OSS UDF の bqutil.fn なのでお手軽に BigQuery の結果の型を確認したい時になにか良い方法がないかなと調べていたら、OSS でbqutil.fnという UDF が GCP から提供されていた。
例えば型の確認の場合、以下の ユーザー定義関数（UDF) はどの GCP プロジェクトから実行しても実行可能
bqutil.fn.typeof() このbqutil.fn はbigquery-utils/udfs/community/のディレクトリに格納されている UDF がbqutil という GCP プロジェクトのfn データセットに同期されているので、どの GCP プロジェクトの Google BigQuery から実行しても bqutil.fn.typeof()を実行可能にしているらしい。 頭良い
This directory contains community contributed user-defined functions to extend BigQuery for more specialized usage patterns. Each UDF within this directory will be automatically synchronized to the bqutil project within the fn dataset for reference in queries."><meta name=keywords content="bigquery,gcp,"><meta property="og:title" content="OSS の Google BigQuery UDF `bqutil.fn` を使えば UDF の独自実装を置き換えられるかもしれない"><meta property="og:description" content="TL;DR; UDF を独自実装する前に、bqutil.fnを眺めておくと車輪の再発明が回避できるかも
背景 SQL は、特定の処理を行う際にデータの型が同一でないとエラーが発生しますが、もとのスキーマを紹介するよりももっとお手軽にカラムの型を確認したいときがありませんか?
例えば、出力結果を見ただけでは、12345 が STRING なのか INT64 なのか判別不可能ですよね。(もし判別可能な方法知っている人いたら教えて下さい&mldr;)
GCP による OSS UDF の bqutil.fn なのでお手軽に BigQuery の結果の型を確認したい時になにか良い方法がないかなと調べていたら、OSS でbqutil.fnという UDF が GCP から提供されていた。
例えば型の確認の場合、以下の ユーザー定義関数（UDF) はどの GCP プロジェクトから実行しても実行可能
bqutil.fn.typeof() このbqutil.fn はbigquery-utils/udfs/community/のディレクトリに格納されている UDF がbqutil という GCP プロジェクトのfn データセットに同期されているので、どの GCP プロジェクトの Google BigQuery から実行しても bqutil.fn.typeof()を実行可能にしているらしい。 頭良い
This directory contains community contributed user-defined functions to extend BigQuery for more specialized usage patterns. Each UDF within this directory will be automatically synchronized to the bqutil project within the fn dataset for reference in queries."><meta property="og:type" content="article"><meta property="og:url" content="https://shunyaueta.com/posts/2022-01-20/"><meta property="og:image" content="https://shunyaueta.com/ogp.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-20T00:03:07+09:00"><meta property="article:modified_time" content="2022-01-20T00:03:07+09:00"><meta property="og:site_name" content="Shunya Ueta"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://shunyaueta.com/ogp.jpg"><meta name=twitter:title content="OSS の Google BigQuery UDF `bqutil.fn` を使えば UDF の独自実装を置き換えられるかもしれない"><meta name=twitter:description content="TL;DR; UDF を独自実装する前に、bqutil.fnを眺めておくと車輪の再発明が回避できるかも
背景 SQL は、特定の処理を行う際にデータの型が同一でないとエラーが発生しますが、もとのスキーマを紹介するよりももっとお手軽にカラムの型を確認したいときがありませんか?
例えば、出力結果を見ただけでは、12345 が STRING なのか INT64 なのか判別不可能ですよね。(もし判別可能な方法知っている人いたら教えて下さい&mldr;)
GCP による OSS UDF の bqutil.fn なのでお手軽に BigQuery の結果の型を確認したい時になにか良い方法がないかなと調べていたら、OSS でbqutil.fnという UDF が GCP から提供されていた。
例えば型の確認の場合、以下の ユーザー定義関数（UDF) はどの GCP プロジェクトから実行しても実行可能
bqutil.fn.typeof() このbqutil.fn はbigquery-utils/udfs/community/のディレクトリに格納されている UDF がbqutil という GCP プロジェクトのfn データセットに同期されているので、どの GCP プロジェクトの Google BigQuery から実行しても bqutil.fn.typeof()を実行可能にしているらしい。 頭良い
This directory contains community contributed user-defined functions to extend BigQuery for more specialized usage patterns. Each UDF within this directory will be automatically synchronized to the bqutil project within the fn dataset for reference in queries."><meta itemprop=name content="OSS の Google BigQuery UDF `bqutil.fn` を使えば UDF の独自実装を置き換えられるかもしれない"><meta itemprop=description content="TL;DR; UDF を独自実装する前に、bqutil.fnを眺めておくと車輪の再発明が回避できるかも
背景 SQL は、特定の処理を行う際にデータの型が同一でないとエラーが発生しますが、もとのスキーマを紹介するよりももっとお手軽にカラムの型を確認したいときがありませんか?
例えば、出力結果を見ただけでは、12345 が STRING なのか INT64 なのか判別不可能ですよね。(もし判別可能な方法知っている人いたら教えて下さい&mldr;)
GCP による OSS UDF の bqutil.fn なのでお手軽に BigQuery の結果の型を確認したい時になにか良い方法がないかなと調べていたら、OSS でbqutil.fnという UDF が GCP から提供されていた。
例えば型の確認の場合、以下の ユーザー定義関数（UDF) はどの GCP プロジェクトから実行しても実行可能
bqutil.fn.typeof() このbqutil.fn はbigquery-utils/udfs/community/のディレクトリに格納されている UDF がbqutil という GCP プロジェクトのfn データセットに同期されているので、どの GCP プロジェクトの Google BigQuery から実行しても bqutil.fn.typeof()を実行可能にしているらしい。 頭良い
This directory contains community contributed user-defined functions to extend BigQuery for more specialized usage patterns. Each UDF within this directory will be automatically synchronized to the bqutil project within the fn dataset for reference in queries."><meta itemprop=datePublished content="2022-01-20T00:03:07+09:00"><meta itemprop=dateModified content="2022-01-20T00:03:07+09:00"><meta itemprop=wordCount content="146"><meta itemprop=image content="https://shunyaueta.com/ogp.jpg"><meta itemprop=keywords content="bigquery,gcp,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px;overflow-x:auto}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-JMJRQJT0Q3"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JMJRQJT0Q3")</script></head><body><header><a href=/ class=title><h2>Shunya Ueta</h2></a><nav><a href=/about/>著者について</a>
<a href=/index.xml>RSS</a></nav></header><main><h1>OSS の Google BigQuery UDF `bqutil.fn` を使えば UDF の独自実装を置き換えられるかもしれない</h1><p><i><time datetime=2022-01-20 pubdate>2022-01-20</time></i></p><content><h2 id=tldr>TL;DR;</h2><p>UDF を独自実装する前に、<code>bqutil.fn</code>を眺めておくと車輪の再発明が回避できるかも</p><h2 id=背景>背景</h2><p>SQL は、特定の処理を行う際にデータの型が同一でないとエラーが発生しますが、もとのスキーマを紹介するよりももっとお手軽にカラムの型を確認したいときがありませんか?</p><p>例えば、出力結果を見ただけでは、<code>12345</code> が STRING なのか INT64 なのか判別不可能ですよね。(もし判別可能な方法知っている人いたら教えて下さい&mldr;)</p><h2 id=gcp-による-oss-udf-の-bqutilfn>GCP による OSS UDF の bqutil.fn</h2><p>なのでお手軽に BigQuery の結果の型を確認したい時になにか良い方法がないかなと調べていたら、OSS で<code>bqutil.fn</code>という UDF が GCP から提供されていた。</p><p>例えば型の確認の場合、以下の ユーザー定義関数（UDF) はどの GCP プロジェクトから実行しても実行可能</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>bqutil.fn.typeof()
</span></span></code></pre></div><p>この<code>bqutil.fn</code> は<a href=https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/udfs/community#typeofinput-any-type>bigquery-utils/udfs/community/</a>のディレクトリに格納されている UDF が<code>bqutil</code> という GCP プロジェクトの<code>fn</code> データセットに同期されているので、どの GCP プロジェクトの Google BigQuery から実行しても <code>bqutil.fn.typeof()</code>を実行可能にしているらしい。
頭良い</p><blockquote><p>This directory contains community contributed user-defined functions to extend BigQuery for more specialized usage patterns. Each UDF within this directory will be automatically synchronized to the bqutil project within the fn dataset for reference in queries.</p></blockquote><p>実際に以下のクエリを Google BigQuery で実行すると</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>  bqutil.fn.typeof(<span style=color:#e6db74>&#34;&#34;</span>),
</span></span><span style=display:flex><span>  bqutil.fn.typeof(b<span style=color:#e6db74>&#34;&#34;</span>),
</span></span><span style=display:flex><span>  bqutil.fn.typeof(<span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>  bqutil.fn.typeof(STRUCT()),
</span></span></code></pre></div><pre tabindex=0><code>STRING
BYTES
FLOAT64
STRUCT
</code></pre><p>の結果が出力され、各カラムのデータの型を確認できる。</p><p><img src=/posts/2022-01-20/images/1.png alt=result></p><p>便利!</p><p>これで置き換え可能な UDF は置き換えればメンテンスしないといけない UDF が削減されて嬉しいですね</p><p><code>bqutil.fn.typeof()</code> の UDF の実態としては
<a href=https://github.com/GoogleCloudPlatform/bigquery-utils/blob/master/udfs/community/typeof.sqlx>bigquery-utils/udfs/community/typeof.sqlx</a>が参照されて実行されている。</p><p>他にも</p><ul><li>URL の key を抽出できる<a href=https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/udfs/community#url_keysquery-string>bqutil.fn.url_keys()</a></li><li>ランダムな値を出力できる<a href=https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/udfs/community#random_valuearr-any-type>bqutil.fn.url_keys()</a></li></ul><p>など、自前で正規表現で頑張って書いているけど実際は OSS の UDF として公開されているケースも多々ありそうなかゆいところに手が届く UDF が多数公開されていた。</p><p>変わり種としては、
<a href=https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/udfs/community#statslib-statistical-udfs>StatsLib: Statistical UDFs</a>という統計的な処理を行う UDF も公開されていた。</p><p>線形回帰や p 値の計算ができる UDF も公開されており、面白い</p><h2 id=references>References</h2><ul><li><a href=https://stackoverflow.com/questions/43730045/bigquery-type-check-operator-like-typeof-in-javascript-or-workaround>bigquery type check operator? like typeof in Javascript; or workaround</a></li><li><a href=https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/udfs/community#typeofinput-any-type>typeof(input ANY TYPE)</a></li></ul></content><p><a href=https://shunyaueta.com/tags/bigquery/>#bigquery</a>
<a href=https://shunyaueta.com/tags/gcp/>#gcp</a></p><h2>関連しているかもしれない記事</h2><ul><li><a href=/posts/2019-10-03/>遅すぎる `pandas.read_gbq` を使わずに、Google BigQueryから高速にデータを読み込む</a></li><li><a href=/posts/2021-11-06/>Standard SQLのCOALESCEで、時間経過によってカラム名が変化したデータを柔軟に抽出する</a></li><li><a href=/posts/2021-11-05/>Dataflow template を使って Google Cloud Pub/Sub の中身を簡単に確認する</a></li><li><a href=/posts/2021-10-04/>CloudComposer のDAGをCircleCIで更新する</a></li><li><a href=/posts/2021-09-29/>GCPのCloud Composer のDAGを素早く・簡単にデバッグする</a></li></ul>---<br>このサイトの更新情報を<a href=/index.xml>RSS</a>で配信しています。お好きなフィードリーダーで購読してみてください。<br>👏このウェブサイトの運営を支援していただける方を募集しています。<br>もしよろしければ、<a href=https://www.buymeacoffee.com/hurutoriya>Buy Me a Coffee</a> からサポート(投げ銭)していただけると、著者の活動のモチベーションに繋がります✨<br>📮おたより<br>記事への感想の<a href="https://docs.google.com/forms/d/e/1FAIpQLScgZVDrjQiKLbQRovfs88oweCITzjtvt1PlgwL14JfWPOrpPQ/viewform?usp=pp_url&entry.838298670=https%3a%2f%2fshunyaueta.com%2fposts%2f2022-01-20%2f">おたより</a>をおまちしてます。
お気軽にお送りください。
お返事はメールアドレス入力があればメールでさせていただきます。
もちろんお返事を希望せずに単なる感想だけでも大歓迎です。</main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>