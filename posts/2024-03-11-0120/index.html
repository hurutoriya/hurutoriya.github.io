<!doctype html><html lang=ja><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Apache Lucene ã® PR #12962 Speedup concurrent multi-segment HNSW graph search 2 ã‚’ç†è§£ã—ãŸã„ æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³OSSå‹‰å¼·ä¼š | Shunya Ueta</title>
<meta name=title content="Apache Lucene ã® PR #12962 Speedup concurrent multi-segment HNSW graph search 2 ã‚’ç†è§£ã—ãŸã„ æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³OSSå‹‰å¼·ä¼š"><meta name=description content="æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ OSS å‹‰å¼·ä¼š ç¬¬ä¸€å›ã®ç™ºè¡¨è³‡æ–™ã§ã™ã€‚ ç™ºè¡¨ã§ã®è­°è«–ã‚’åŸºã«ã“ã®è³‡æ–™ã¯æ”¹ä¿®äºˆå®šã§ã™ã€‚
https://home.apache.org/~mikemccand/lucenebench/VectorSearch.html
768 æ¬¡å…ƒã® word embedding ã®ãƒ™ã‚¯ãƒˆãƒ«ã«å¯¾ã—ã¦ã€è¿‘ä¼¼è¿‘å‚æ¢ç´¢ã®çµæœã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚­ãƒ³ã‚°ã€‚
Lucene Nightly Benchmarking ã§ã®å¤§ããªæ”¹å–„
GE: 104QPS â†’ 219QPS
GE: è¿‘ä¼¼è¿‘å‚æ¢ç´¢ã§è¤‡æ•°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã¦ä¸¦è¡Œã«æ¤œç´¢ Speedup concurrent multi-segment HNSW graph search 2 by mayya-sharipova Â· Pull Request #12962 Â· apache/lucene
Elasticsearch ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®äººãŒä½œæˆã—ã¦ã„ã‚‹
Lucene ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æ¦‚å¿µ
docsâ†’fileâ†’segmentâ†’index
+- Index 5 ------------------------------------------+ | | | +- Segment _0 ---------------------------------+ | | | | | | | +- file 1 -------------------------------+ | | | | | | | | | | | +- L."><meta name=keywords content="lucene,æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³OSSå‹‰å¼·ä¼š,"><meta property="og:title" content="Apache Lucene ã® PR #12962 Speedup concurrent multi-segment HNSW graph search 2 ã‚’ç†è§£ã—ãŸã„ æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³OSSå‹‰å¼·ä¼š"><meta property="og:description" content="æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ OSS å‹‰å¼·ä¼š ç¬¬ä¸€å›ã®ç™ºè¡¨è³‡æ–™ã§ã™ã€‚ ç™ºè¡¨ã§ã®è­°è«–ã‚’åŸºã«ã“ã®è³‡æ–™ã¯æ”¹ä¿®äºˆå®šã§ã™ã€‚
https://home.apache.org/~mikemccand/lucenebench/VectorSearch.html
768 æ¬¡å…ƒã® word embedding ã®ãƒ™ã‚¯ãƒˆãƒ«ã«å¯¾ã—ã¦ã€è¿‘ä¼¼è¿‘å‚æ¢ç´¢ã®çµæœã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚­ãƒ³ã‚°ã€‚
Lucene Nightly Benchmarking ã§ã®å¤§ããªæ”¹å–„
GE: 104QPS â†’ 219QPS
GE: è¿‘ä¼¼è¿‘å‚æ¢ç´¢ã§è¤‡æ•°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã¦ä¸¦è¡Œã«æ¤œç´¢ Speedup concurrent multi-segment HNSW graph search 2 by mayya-sharipova Â· Pull Request #12962 Â· apache/lucene
Elasticsearch ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®äººãŒä½œæˆã—ã¦ã„ã‚‹
Lucene ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æ¦‚å¿µ
docsâ†’fileâ†’segmentâ†’index
+- Index 5 ------------------------------------------+ | | | +- Segment _0 ---------------------------------+ | | | | | | | +- file 1 -------------------------------+ | | | | | | | | | | | +- L."><meta property="og:type" content="article"><meta property="og:url" content="https://shunyaueta.com/posts/2024-03-11-0120/"><meta property="og:image" content="https://shunyaueta.com/ogp.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-11T01:20:34+09:00"><meta property="article:modified_time" content="2024-03-11T01:20:34+09:00"><meta property="og:site_name" content="Shunya Ueta"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://shunyaueta.com/ogp.jpg"><meta name=twitter:title content="Apache Lucene ã® PR #12962 Speedup concurrent multi-segment HNSW graph search 2 ã‚’ç†è§£ã—ãŸã„ æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³OSSå‹‰å¼·ä¼š"><meta name=twitter:description content="æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ OSS å‹‰å¼·ä¼š ç¬¬ä¸€å›ã®ç™ºè¡¨è³‡æ–™ã§ã™ã€‚ ç™ºè¡¨ã§ã®è­°è«–ã‚’åŸºã«ã“ã®è³‡æ–™ã¯æ”¹ä¿®äºˆå®šã§ã™ã€‚
https://home.apache.org/~mikemccand/lucenebench/VectorSearch.html
768 æ¬¡å…ƒã® word embedding ã®ãƒ™ã‚¯ãƒˆãƒ«ã«å¯¾ã—ã¦ã€è¿‘ä¼¼è¿‘å‚æ¢ç´¢ã®çµæœã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚­ãƒ³ã‚°ã€‚
Lucene Nightly Benchmarking ã§ã®å¤§ããªæ”¹å–„
GE: 104QPS â†’ 219QPS
GE: è¿‘ä¼¼è¿‘å‚æ¢ç´¢ã§è¤‡æ•°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã¦ä¸¦è¡Œã«æ¤œç´¢ Speedup concurrent multi-segment HNSW graph search 2 by mayya-sharipova Â· Pull Request #12962 Â· apache/lucene
Elasticsearch ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®äººãŒä½œæˆã—ã¦ã„ã‚‹
Lucene ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æ¦‚å¿µ
docsâ†’fileâ†’segmentâ†’index
+- Index 5 ------------------------------------------+ | | | +- Segment _0 ---------------------------------+ | | | | | | | +- file 1 -------------------------------+ | | | | | | | | | | | +- L."><meta itemprop=name content="Apache Lucene ã® PR #12962 Speedup concurrent multi-segment HNSW graph search 2 ã‚’ç†è§£ã—ãŸã„ æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³OSSå‹‰å¼·ä¼š"><meta itemprop=description content="æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ OSS å‹‰å¼·ä¼š ç¬¬ä¸€å›ã®ç™ºè¡¨è³‡æ–™ã§ã™ã€‚ ç™ºè¡¨ã§ã®è­°è«–ã‚’åŸºã«ã“ã®è³‡æ–™ã¯æ”¹ä¿®äºˆå®šã§ã™ã€‚
https://home.apache.org/~mikemccand/lucenebench/VectorSearch.html
768 æ¬¡å…ƒã® word embedding ã®ãƒ™ã‚¯ãƒˆãƒ«ã«å¯¾ã—ã¦ã€è¿‘ä¼¼è¿‘å‚æ¢ç´¢ã®çµæœã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚­ãƒ³ã‚°ã€‚
Lucene Nightly Benchmarking ã§ã®å¤§ããªæ”¹å–„
GE: 104QPS â†’ 219QPS
GE: è¿‘ä¼¼è¿‘å‚æ¢ç´¢ã§è¤‡æ•°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã¦ä¸¦è¡Œã«æ¤œç´¢ Speedup concurrent multi-segment HNSW graph search 2 by mayya-sharipova Â· Pull Request #12962 Â· apache/lucene
Elasticsearch ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®äººãŒä½œæˆã—ã¦ã„ã‚‹
Lucene ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æ¦‚å¿µ
docsâ†’fileâ†’segmentâ†’index
+- Index 5 ------------------------------------------+ | | | +- Segment _0 ---------------------------------+ | | | | | | | +- file 1 -------------------------------+ | | | | | | | | | | | +- L."><meta itemprop=datePublished content="2024-03-11T01:20:34+09:00"><meta itemprop=dateModified content="2024-03-11T01:20:34+09:00"><meta itemprop=wordCount content="953"><meta itemprop=image content="https://shunyaueta.com/ogp.jpg"><meta itemprop=keywords content="lucene,æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³OSSå‹‰å¼·ä¼š,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px;overflow-x:auto}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-JMJRQJT0Q3"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JMJRQJT0Q3")</script></head><body><header><a href=/ class=title><h2>Shunya Ueta</h2></a><nav><a href=/about/>è‘—è€…ã«ã¤ã„ã¦</a>
<a href=/index.xml>RSS</a></nav></header><main><h1>Apache Lucene ã® PR #12962 Speedup concurrent multi-segment HNSW graph search 2 ã‚’ç†è§£ã—ãŸã„ æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³OSSå‹‰å¼·ä¼š</h1><p><i><time datetime=2024-03-11 pubdate>2024-03-11</time></i></p><content><p>æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ OSS å‹‰å¼·ä¼š ç¬¬ä¸€å›ã®ç™ºè¡¨è³‡æ–™ã§ã™ã€‚
ç™ºè¡¨ã§ã®è­°è«–ã‚’åŸºã«ã“ã®è³‡æ–™ã¯æ”¹ä¿®äºˆå®šã§ã™ã€‚</p><p><a href=https://home.apache.org/~mikemccand/lucenebench/VectorSearch.html>https://home.apache.org/~mikemccand/lucenebench/VectorSearch.html</a></p><p><img src=/posts/2024-03-11-0120/images/knn-benchmarking.png alt></p><p>768 æ¬¡å…ƒã® word embedding ã®ãƒ™ã‚¯ãƒˆãƒ«ã«å¯¾ã—ã¦ã€è¿‘ä¼¼è¿‘å‚æ¢ç´¢ã®çµæœã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚­ãƒ³ã‚°ã€‚</p><p>Lucene Nightly Benchmarking ã§ã®å¤§ããªæ”¹å–„</p><p>GE: 104QPS â†’ 219QPS</p><h2 id=ge-è¿‘ä¼¼è¿‘å‚æ¢ç´¢ã§è¤‡æ•°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã¦ä¸¦è¡Œã«æ¤œç´¢>GE: è¿‘ä¼¼è¿‘å‚æ¢ç´¢ã§è¤‡æ•°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã¦ä¸¦è¡Œã«æ¤œç´¢</h2><p><a href=https://github.com/apache/lucene/pull/12962>Speedup concurrent multi-segment HNSW graph search 2 by mayya-sharipova Â· Pull Request #12962 Â· apache/lucene</a></p><p>Elasticsearch ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®äººãŒä½œæˆã—ã¦ã„ã‚‹</p><p>Lucene ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æ¦‚å¿µ</p><p>docsâ†’fileâ†’segmentâ†’index</p><pre tabindex=0><code>+- Index 5 ------------------------------------------+
|                                                    |
|  +- Segment _0 ---------------------------------+  |
|  |                                              |  |
|  |  +- file 1 -------------------------------+  |  |
|  |  |                                        |  |  |
|  |  | +- L.Doc1-+  +- L.Doc2-+  +- L.Doc3-+  |  |  |
|  |  | |         |  |         |  |         |  |  |  |
|  |  | | field 1 |  | field 1 |  | field 1 |  |  |  |
|  |  | | field 2 |  | field 2 |  | field 2 |  |  |  |
|  |  | | field 3 |  | field 3 |  | field 3 |  |  |  |
|  |  | |         |  |         |  |         |  |  |  |
|  |  | +---------+  +---------+  +---------+  |  |  |
|  |  |                                        |  |  |
|  |  +----------------------------------------+  |  |
|  |                                              |  |
|  |                                              |  |
|  |  +- file 2 -------------------------------+  |  |
|  |  |                                        |  |  |
|  |  | +- L.Doc4-+  +- L.Doc5-+  +- L.Doc6-+  |  |  |
|  |  | |         |  |         |  |         |  |  |  |
|  |  | | field 1 |  | field 1 |  | field 1 |  |  |  |
|  |  | | field 2 |  | field 2 |  | field 2 |  |  |  |
|  |  | | field 3 |  | field 3 |  | field 3 |  |  |  |
|  |  | |         |  |         |  |         |  |  |  |
|  |  | +---------+  +---------+  +---------+  |  |  |
|  |  |                                        |  |  |
|  |  +----------------------------------------+  |  |
|  |                                              |  |
|  +----------------------------------------------+  |
|                                                    |
|  +- Segment _1 (optional) ----------------------+  |
|  |                                              |  |
|  +----------------------------------------------+  |
+----------------------------------------------------+
</code></pre><blockquote><p>Ref: <a href=https://stackoverflow.com/questions/2703432/what-are-segments-in-lucene>What are segments in Lucene? - Stack Overflow</a></p></blockquote><p>ã“ã® StackOverflow ã§å…±æœ‰ã•ã‚Œã¦ã„ã‚‹ã“ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ç†è§£ã—ã‚„ã™ã‹ã£ãŸ</p><p><a href=https://lucene.apache.org/core/2_9_4/fileformats.html>Apache Lucene - Index File Formats</a></p><ul><li><input disabled type=checkbox> 2.9.4 ã®ã‚„ã¤ãªã®ã§æœ€æ–°ç‰ˆã® page ã‚’æ¢ã—ã ã›ã‚Œã°å·®ã—æ›¿ãˆã‚‹</li></ul><h3 id=lucene-ã®-knn-ã®è§£èª¬>Lucene ã® KNN ã®è§£èª¬</h3><p>Lucene comitter ã® Mike Sokolov ã•ã‚“ã®ç™ºè¡¨ãŒã‚ã‹ã‚Šã‚„ã™ã„</p><ul><li><a href=https://www.apachecon.com/acna2022/slides/04_lucene_vector_search_sokolov.pdf>The making of Apache Lucene vector search</a><ul><li><a href=https://issues.apache.org/jira/browse/LUCENE-9004>https://issues.apache.org/jira/browse/LUCENE-9004</a></li><li>ANN ã®æ©Ÿèƒ½é–‹ç™ºãƒã‚±ãƒƒãƒˆ</li><li><a href=https://github.com/apache/lucene-solr/pull/2022>LUCENE-9004: KNN vector search using NSW graphs by msokolov Â· Pull Request #2022 Â· apache/lucene-solr</a></li></ul></li></ul><h1 id=å®Ÿéš›ã«ä½œæˆã•ã‚ŒãŸ-pr-ã‚’èª­ã‚“ã§ã¿ã‚‹>å®Ÿéš›ã«ä½œæˆã•ã‚ŒãŸ PR ã‚’èª­ã‚“ã§ã¿ã‚‹</h1><h2 id=å®Ÿéš›ã®è¤‡æ•°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä¸¦è¡Œæ¤œç´¢ã™ã‚‹å‡¦ç†ã®ä¾‹-refhttpsgithubcomapachelucenepull12962filesdiff-0a10fed5fe4af3bba13deab713dea47f98a298d3962361a88d5c2a073c4892a7>å®Ÿéš›ã®è¤‡æ•°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä¸¦è¡Œæ¤œç´¢ã™ã‚‹å‡¦ç†ã®ä¾‹ <a href=https://github.com/apache/lucene/pull/12962/files#diff-0a10fed5fe4af3bba13deab713dea47f98a298d3962361a88d5c2a073c4892a7>ref</a></h2><p><code>AbstractKnnVectorQuery.java</code> å†…ã§ KNN ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®ä¸¦è¡Œæ¤œç´¢ãŒã‚µãƒãƒ¼ãƒˆã•ã‚ŒãŸ
ã“ã®ã‚¯ãƒ©ã‚¹ã¯åå‰ã®é€šã‚Šã€è¿‘ä¼¼è¿‘å‚æ¢ç´¢(kNN)ã‚’æ‰±ã†ã‚¯ãƒ©ã‚¹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// k ã¯ kNNã® k, IndexSearcher ã¯åå‰ã®ã¾ã‚“ã¾</span>
</span></span><span style=display:flex><span>KnnCollectorManager knnCollectorManager <span style=color:#f92672>=</span> getKnnCollectorManager(k, indexSearcher);
</span></span><span style=display:flex><span><span style=color:#75715e>// TaskExecutor ã¯å¹³è¡Œå®Ÿè¡Œã‚’æ‹…å½“ã™ã‚‹</span>
</span></span><span style=display:flex><span>TaskExecutor taskExecutor <span style=color:#f92672>=</span> indexSearcher.<span style=color:#a6e22e>getTaskExecutor</span>();
</span></span><span style=display:flex><span><span style=color:#75715e>// LeafReaderContext ã¯ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã§æ¤œç´¢ã‚’åŠ¹ç‡çš„ã«å®Ÿè¡Œå¯èƒ½ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ</span>
</span></span><span style=display:flex><span>List<span style=color:#f92672>&lt;</span>LeafReaderContext<span style=color:#f92672>&gt;</span> leafReaderContexts <span style=color:#f92672>=</span> reader.<span style=color:#a6e22e>leaves</span>();
</span></span><span style=display:flex><span>List<span style=color:#f92672>&lt;</span>Callable<span style=color:#f92672>&lt;</span>TopDocs<span style=color:#f92672>&gt;&gt;</span> tasks <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>(leafReaderContexts.<span style=color:#a6e22e>size</span>());
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (LeafReaderContext context : leafReaderContexts) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tasks.<span style=color:#a6e22e>add</span>(() <span style=color:#f92672>-&gt;</span> searchLeaf(context, filterWeight, knnCollectorManager));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=leafreadercontext-ã®è§£èª¬>LeafReaderContext ã®è§£èª¬</h3><p>Lucene ã§ã®æ¤œç´¢å‡¦ç†ã«ãŠã‘ã‚‹ Â  <a href=https://github.com/apache/lucene/blob/main/lucene/core/src/java/org/apache/lucene/index/LeafReaderContext.java>LeafReaderContext</a> Â  ã®å½¹å‰²ã¨ãã®é‡è¦æ€§ã‚’ã€ã‚ˆã‚Šå…·ä½“çš„ãªä¾‹ã‚’äº¤ãˆã¦è§£èª¬ã€‚ Leaf ã¯ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’æ„å‘³ã—ã¦ã„ã‚‹ã¨è§£é‡ˆ</p><p>Lucene ã«ãŠã‘ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ã€è¤‡æ•°ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«åˆ†ã‘ã‚‰ã‚Œã¦ãŠã‚Šã€å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¯ç‹¬ç«‹ã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã€‚ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã‚„æ¤œç´¢ã®åŠ¹ç‡åŒ–ãŒå›³ã‚‰ã‚Œã¦ã„ã‚‹ã€‚
ãŸã¨ãˆã°ã€å¤§è¦æ¨¡ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé›†åˆã«å¯¾ã™ã‚‹æ›´æ–°ã‚„è¿½åŠ ãŒç™ºç”Ÿã—ãŸã¨ãã€å…¨ä½“ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¸€ã‹ã‚‰å†æ§‹ç¯‰ã™ã‚‹ã®ã§ã¯ãªãã€æ–°ã—ã„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã€æœ€çµ‚çš„ã«ã¯æ—¢å­˜ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¨ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã“ã¨ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ›´æ–°ã•ã‚Œã‚‹ã€‚</p><h4 id=å…·ä½“ä¾‹-æ¤œç´¢å‡¦ç†>å…·ä½“ä¾‹: æ¤œç´¢å‡¦ç†</h4><p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ &ldquo;Lucene&rdquo; ã¨ã„ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢ã™ã‚‹å ´é¢ã‚’æƒ³å®š
Lucene ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯è¤‡æ•°ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€æ¤œç´¢å‡¦ç†ã¯ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã§è¡Œã‚ã‚Œã‚‹</p><ol><li><strong>ã‚¯ã‚¨ãƒªè§£æ</strong>: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‹ã‚‰æ¤œç´¢ã‚¯ã‚¨ãƒªãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã“ã®ä¾‹ã§ã¯ã€&ldquo;Lucene&rdquo; ã¨ã„ã†å˜èªã‚’æ¤œç´¢ã™ã‚‹ã‚¯ã‚¨ãƒªã§ã™ã€‚</li><li><strong>ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã”ã¨ã®æ¤œç´¢</strong>: Lucene ã¯ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å†…ã®å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã¦ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã“ãŒ Â <code>LeafReaderContext</code>Â  ã®å‡ºç•ªã€‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å…¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«å¯¾å¿œã™ã‚‹ Â <code>LeafReaderContext</code>Â  ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªã‚¹ãƒˆã‚’é€šã˜ã¦ã€ãã‚Œãã‚Œã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã¦ç‹¬ç«‹ã—ã¦ã‚¯ã‚¨ãƒªãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚</li></ol><p>ä¾‹ãˆã°ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã« 3 ã¤ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒã‚ã£ãŸå ´åˆã€</p><ul><li><code>LeafReaderContext1</code>Â  ã‚’ä½¿ã£ã¦ segment 1 ã‚’æ¤œç´¢</li><li><code>LeafReaderContext2</code>Â  ã‚’ä½¿ã£ã¦ segment 2 ã‚’æ¤œç´¢</li><li><code>LeafReaderContext3</code>Â  ã‚’ä½¿ã£ã¦ segment 3 ã‚’æ¤œç´¢</li></ul><p>å„ Â <code>LeafReaderContext</code>Â  ã‹ã‚‰ã¯ã€ãã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå›ºæœ‰ã®æƒ…å ±ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ IDã€é »åº¦ãªã©ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒæä¾›ã•ã‚Œã¾ã™ã€‚ã“ã®æ‰‹é †ã«ã‚ˆã‚Šã€å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‹ã‚‰ &ldquo;Lucene&rdquo; ãŒå«ã¾ã‚Œã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ¤œç´¢ã•ã‚Œã¾ã™ã€‚</p><ol><li><strong>çµæœã®é›†ç´„</strong>: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã”ã¨ã®æ¤œç´¢çµæœã‚’é›†ç´„ã—ã¦ã€æœ€çµ‚çš„ãªæ¤œç´¢çµæœã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã—ã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã§ã¯ã€å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‹ã‚‰å¾—ã‚‰ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ ID ã‚’ã€å…¨ä½“ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ãŠã‘ã‚‹ä¸€æ„ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ ID ã«å‰²ã‚Šå½“ã¦ç›´ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®å‰²ã‚Šå½“ã¦ã‚‚ã€<code>LeafReaderContext</code>Â  ã‚’é€šã˜ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚</li></ol><p>ã“ã®ä¾‹ã§ã¯ã€<code>LeafReaderContext</code>Â  ã®å½¹å‰²ãŒã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã§ã®æ¤œç´¢å‡¦ç†ã®å®Ÿè¡Œã¨ãã®çµæœã®å–ã‚Šæ‰±ã„ã«ã©ã®ã‚ˆã†ã«å½±éŸ¿ã™ã‚‹ã‹ã‚’ç¤ºã—ã¦ã„ã‚‹ã€‚å…·ä½“çš„ã«ã¯ã€<code>LeafReaderContext</code>Â  ã¯æ¤œç´¢ã‚¯ã‚¨ãƒªã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã”ã¨ã®å®Ÿè¡Œã‚’åŠ©ã‘ã€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†…ã®æƒ…å ±ã«å¯¾ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã—ã€ã•ã‚‰ã«å…¨ä½“ã®æ¤œç´¢çµæœã‚’é›†ç´„ã™ã‚‹éš›ã®æ©‹æ¸¡ã—ã‚’ã—ã¾ã™ã€‚ã¾ãŸã€æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«è¿½åŠ ã•ã‚ŒãŸå ´åˆã‚„ã€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸå ´åˆã«ã‚‚ã€<code>LeafReaderContext</code>Â  ãŒæ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã§ã€æ¤œç´¢ã‚¯ã‚¨ãƒªã®æ­£ç¢ºã•ã¨è¿…é€Ÿã•ã‚’ä¿è¨¼ã—ã¦ã„ã‚‹ã€‚</p><h3 id=ã“ã®-pr-ã§å°å…¥ã•ã‚ŒãŸ-knncollectormanager-ã«ã¤ã„ã¦>ã“ã® PR ã§å°å…¥ã•ã‚ŒãŸ KnnCollectorManager ã«ã¤ã„ã¦</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> KnnCollectorManager <span style=color:#a6e22e>getKnnCollectorManager</span>(<span style=color:#66d9ef>int</span> k, IndexSearcher searcher) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> TopKnnCollectorManager(k, searcher);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><a href=https://github.com/apache/lucene/blob/d095ed02a2a7742235e73320fa992eabfeecbecc/lucene/core/src/java/org/apache/lucene/search/knn/KnnCollectorManager.java>KNNCollectorManager</a> ã¯ <a href=https://github.com/apache/lucene/blob/6445bc0a14ee22d107c072f4ef7b133faf780fe1/lucene/core/src/java/org/apache/lucene/search/KnnCollector.java>KnnCollector</a>ã‚’ç®¡ç†<ul><li><ul><li><a href=https://github.com/apache/lucene/blob/6445bc0a14ee22d107c072f4ef7b133faf780fe1/lucene/core/src/java/org/apache/lucene/search/KnnCollector.java>KnnCollector</a> ã¯ã€è¿‘å‚çµæœã‹ã‚‰ kNN çµæœã‚’åé›†ã™ã‚‹</li></ul></li></ul></li><li><a href=https://github.com/apache/lucene/blob/main/lucene/core/src/java/org/apache/lucene/search/knn/TopKnnCollectorManager.java>TopKNNCollectormanager</a> ã¯ KNNCollectorManager ã®ã‚µãƒ–ã‚¯ãƒ©ã‚¹(ã®ã‚ˆã†ãªã‚‚ã®)<ul><li><code>concurrency</code> ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆã€BlockingFloatHeap å†…ã«ã€ã™ã¹ã¦ã®è‘‰ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒˆãƒƒãƒ—ã‚¹ã‚³ã‚¢ãŒåé›†ã•ã‚Œã‚‹ (æ—¢å­˜ã® CollectorManager ã‚’åŸºã«ä½œæˆã—ãŸã‚‰ã—ã„)</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TopKnnCollectorManager</span> <span style=color:#66d9ef>implements</span> KnnCollectorManager {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ä½•å€‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’åé›†ã™ã‚‹ã‹</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> k;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ã™ã¹ã¦ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è·¨ã„ã§åé›†ã•ã‚ŒãŸãƒˆãƒƒãƒ—ã‚¹ã‚³ã‚¢ã‚’è¿½è·¡ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ã‚¢ã‚­ãƒ¥ãƒ¼</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> BlockingFloatHeap globalScoreQueue;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>TopKnnCollectorManager</span>(<span style=color:#66d9ef>int</span> k, IndexSearcher indexSearcher) {
</span></span><span style=display:flex><span>	  <span style=color:#75715e>// è¤‡æ•°ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ã‚’ç¢ºèª</span>
</span></span><span style=display:flex><span>	  <span style=color:#75715e>// ã“ã“ã§ã‚„ã£ã¨ç†è§£ã—ãŸãŒã€ leaves ã£ã¦ segment ã‚’æŒ‡ã—ã¦ã„ã‚‹æ¨¡æ§˜... (segment ã¯ index ã® leaves ã¨è€ƒãˆã‚‰ã‚Œã‚‹ã‹ã‚‰? )</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> isMultiSegments <span style=color:#f92672>=</span> indexSearcher.<span style=color:#a6e22e>getIndexReader</span>().<span style=color:#a6e22e>leaves</span>().<span style=color:#a6e22e>size</span>() <span style=color:#f92672>&gt;</span> 1;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>k</span> <span style=color:#f92672>=</span> k;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¤‡æ•°ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒã‚ã£ãŸå ´åˆã«ã€kè¦ç´ ã‚’æŒã¤BlockingFloatHeapã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆæœŸåŒ–ã—ã¦globalScoreQueueã«å‰²ã‚Šå½“ã¦ã‚‹ã€‚ãã†ã§ãªã‘ã‚Œã°ã€globalScoreQueueã‚’nullã«è¨­å®š</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>globalScoreQueue</span> <span style=color:#f92672>=</span> isMultiSegments <span style=color:#f92672>?</span> <span style=color:#66d9ef>new</span> BlockingFloatHeap(k) : <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> KnnCollector <span style=color:#a6e22e>newCollector</span>(<span style=color:#66d9ef>int</span> visitedLimit, LeafReaderContext context) <span style=color:#66d9ef>throws</span> IOException {
</span></span><span style=display:flex><span>	 <span style=color:#75715e>// å˜ä¸€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å ´åˆ</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (globalScoreQueue <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> TopKnnCollector(k, visitedLimit);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¤‡æ•°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å ´åˆ</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>	   <span style=color:#75715e>// è¤‡æ•°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä¸¦è¡Œæ¤œç´¢ã™ã‚‹ MultiLeafKnnCollector ã‚’åˆ©ç”¨ã™ã‚‹</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MultiLeafKnnCollector(k, globalScoreQueue, <span style=color:#66d9ef>new</span> TopKnnCollector(k, visitedLimit));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=æ¤œç´¢å¯¾è±¡ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒè¤‡æ•°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å ´åˆã«ä¸¦è¡Œæ¤œç´¢ã‚’å®Ÿè¡Œã™ã‚‹-multileafknncollector>æ¤œç´¢å¯¾è±¡ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒè¤‡æ•°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å ´åˆã«ã€ä¸¦è¡Œæ¤œç´¢ã‚’å®Ÿè¡Œã™ã‚‹ MultiLeafKnnCollector</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MultiLeafKnnCollector</span> <span style=color:#66d9ef>implements</span> KnnCollector {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//  [0,1] ã®ç¯„å›²ã§æ¢ç´¢ã®è²ªæ¬²åº¦ã‚’åˆ¶å¾¡ã™ã‚‹å®šæ•°ã€‚å€¤ãŒ1ã«è¿‘ã¥ãã»ã©ã€ã‚ˆã‚Šå¤šãã®æœ€é«˜é¡ä¼¼åº¦ã‚’å±€æ‰€çš„ã«ä¿æŒã—ã‚ˆã†ã¨ã™ã‚‹ã€‚</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> DEFAULT_GREEDINESS <span style=color:#f92672>=</span> 0.<span style=color:#a6e22e>9f</span>;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å…¨ã¦ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’é€šã˜ã¦åé›†ã•ã‚ŒãŸæœ€é«˜ã®é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªã‚­ãƒ¥ãƒ¼ã€‚</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> BlockingFloatHeap globalSimilarityQueue;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ãã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¬ãƒ™ãƒ«ã§ç«¶äº‰åŠ›ã‚’æŒãŸãªã„å ´åˆã«ã€æœ€é«˜ã®é¡ä¼¼åº¦ï¼ˆé¡ä¼¼æ€§ã‚¹ã‚³ã‚¢ï¼‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«è“„ç©ã™ã‚‹ãŸã‚ã®ã‚­ãƒ¥ãƒ¼</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> FloatHeap nonCompetitiveQueue;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åˆæœŸå€¤DEFAULT_GREEDINESSã‚’ä½¿ç”¨ã™ã‚‹æ¢ç´¢ã®è²ªæ¬²åº¦</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>float</span> greediness;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å®šæœŸçš„ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ¥ãƒ¼ã«æ›´æ–°ã‚‹å±€æ‰€çš„ãªé¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ã‚’ä¿æŒã™ã‚‹ã‚­ãƒ¥ãƒ¼</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> FloatHeap updatesQueue;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å±€æ‰€çš„ãªã‚­ãƒ¥ãƒ¼ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªã‚­ãƒ¥ãƒ¼ã‚’åŒæœŸã™ã‚‹ãŸã‚ã®è¨ªå•ã•ã‚ŒãŸãƒ™ã‚¯ã‚¿ãƒ¼ã®æ•°ã®é–“éš”</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> interval <span style=color:#f92672>=</span> 0xff; <span style=color:#75715e>// 255</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> kResultsCollected <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>float</span> cachedGlobalMinSim <span style=color:#f92672>=</span> Float.<span style=color:#a6e22e>NEGATIVE_INFINITY</span>;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ã€ã¤ã¾ã‚Šå±€æ‰€çš„ãªåé›†ã‚’è¡Œã†æŠ½è±¡çš„ãªã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼å®Ÿè£…</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> AbstractKnnCollector subCollector;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Create a new MultiLeafKnnCollector.   *   * @param k åé›†ã™ã‚‹è¿‘ä¼¼è¿‘å‚æ¢ç´¢ã®çµæœæ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * @param globalSimilarityQueue å…¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã§åé›†ã•ã‚ŒãŸæœ€é«˜é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ¥ãƒ¼
</span></span></span><span style=display:flex><span><span style=color:#75715e>  * @param subCollector å±€æ‰€çš„ãªåé›†ã‚’è¡Œã†ãŸã‚ã®ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MultiLeafKnnCollector</span>(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>int</span> k, BlockingFloatHeap globalSimilarityQueue, AbstractKnnCollector subCollector) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>greediness</span> <span style=color:#f92672>=</span> DEFAULT_GREEDINESS;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>subCollector</span> <span style=color:#f92672>=</span> subCollector;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>globalSimilarityQueue</span> <span style=color:#f92672>=</span> globalSimilarityQueue;
</span></span><span style=display:flex><span>	 <span style=color:#75715e>// ä¾‹ãˆã°ã€`k`ãŒ10ã§ã€`greediness`ãŒ0.9ï¼ˆ90%ã®è²ªæ¬²åº¦ï¼‰ã®å ´åˆã€`(1 - 0.9) * 10`Â ã«åŸºã¥ã„ã¦ã“ã®ã‚­ãƒ¥ãƒ¼ã®ã‚µã‚¤ã‚ºã¯Â `1`ï¼ˆæœ€å°ã§ã‚‚1ï¼‰ã¨ãªã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ç«¶äº‰åŠ›ãŒãªã„å ´åˆã«ã‚‚ã€å°‘ãªãã¨ã‚‚1ã¤ã®æœ€é«˜é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿æŒã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>nonCompetitiveQueue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FloatHeap(Math.<span style=color:#a6e22e>max</span>(1, Math.<span style=color:#a6e22e>round</span>((1 <span style=color:#f92672>-</span> greediness) <span style=color:#f92672>*</span> k)));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>updatesQueue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FloatHeap(k);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>earlyTerminated</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> subCollector.<span style=color:#a6e22e>earlyTerminated</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>incVisitedCount</span>(<span style=color:#66d9ef>int</span> count) {
</span></span><span style=display:flex><span>    subCollector.<span style=color:#a6e22e>incVisitedCount</span>(count);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>visitedCount</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> subCollector.<span style=color:#a6e22e>visitedCount</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>visitLimit</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> subCollector.<span style=color:#a6e22e>visitLimit</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>k</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> subCollector.<span style=color:#a6e22e>k</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ä¸ãˆã‚‰ã‚ŒãŸ document id ã¨é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ã‹ã‚‰ã€ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ¥ãƒ¼ã«ãã‚Œã‚’è¿½åŠ ã™ã‚‹</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>collect</span>(<span style=color:#66d9ef>int</span> docId, <span style=color:#66d9ef>float</span> similarity) {
</span></span><span style=display:flex><span>	 <span style=color:#75715e>// localSimUpdated ã¯ ãƒ­ãƒ¼ã‚«ãƒ«ã§é¡ä¼¼åº¦ã®æ›´æ–°ãŒã‚ã£ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> localSimUpdated <span style=color:#f92672>=</span> subCollector.<span style=color:#a6e22e>collect</span>(docId, similarity);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æœ€åˆã«kçµæœãŒå…¨éƒ¨é›†ã¾ã£ãŸç¬é–“ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã™ã‚‹ã€‚</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> firstKResultsCollected <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        (kResultsCollected <span style=color:#f92672>==</span> <span style=color:#66d9ef>false</span> <span style=color:#f92672>&amp;&amp;</span> subCollector.<span style=color:#a6e22e>numCollected</span>() <span style=color:#f92672>==</span> k());
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ã“ã®ç¬é–“ã«ä¸€åº¦ã ã‘kResultsCollectedã‚’trueã«è¨­å®šã™ã‚‹ã€‚</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (firstKResultsCollected) {
</span></span><span style=display:flex><span>      kResultsCollected <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    updatesQueue.<span style=color:#a6e22e>offer</span>(similarity);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¬ãƒ™ãƒ«ã§æ›´æ–°ãŒç”Ÿã˜ãŸã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹ãƒ•ãƒ©ã‚°</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> globalSimUpdated <span style=color:#f92672>=</span> nonCompetitiveQueue.<span style=color:#a6e22e>offer</span>(similarity);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (kResultsCollected) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ã‚‚ã—kä»¶ã®çµæœãŒæ—¢ã«é›†ã¾ã£ã¦ã„ã‚Œã°ã€ä¸ãˆã‚‰ã‚ŒãŸé–“éš”ï¼ˆintervalï¼‰ã”ã¨ã«ã€updatesQueueã®å†…å®¹ã‚’globalSimilarityQueueã«é€ã‚Šã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã‚°ãƒ­ãƒ¼ãƒãƒ«æœ€å°é¡ä¼¼åº¦(cachedGlobalMinSim)ã‚’æ›´æ–°ã—ã€updatesQueueã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã€‚</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (firstKResultsCollected <span style=color:#f92672>||</span> (subCollector.<span style=color:#a6e22e>visitedCount</span>() <span style=color:#f92672>&amp;</span> interval) <span style=color:#f92672>==</span> 0) {
</span></span><span style=display:flex><span>        cachedGlobalMinSim <span style=color:#f92672>=</span> globalSimilarityQueue.<span style=color:#a6e22e>offer</span>(updatesQueue.<span style=color:#a6e22e>getHeap</span>());
</span></span><span style=display:flex><span>        updatesQueue.<span style=color:#a6e22e>clear</span>();
</span></span><span style=display:flex><span>        globalSimUpdated <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ãƒ­ãƒ¼ã‚«ãƒ«ã¾ãŸã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ¥ã®ã©ã¡ã‚‰ã‹ãŒæ›´æ–°ã•ã‚ŒãŸå ´åˆã«trueã‚’è¿”ã™ã€‚ã¤ã¾ã‚Šã€å‘¼ã³å‡ºã—å…ƒã¯ã•ã‚‰ãªã‚‹æ¢ç´¢ã‚’é©åˆ‡ã«èª¿æ•´ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> localSimUpdated <span style=color:#f92672>||</span> globalSimUpdated;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ç«¶äº‰åŠ›ã®ã‚ã‚‹æœ€å°é¡ä¼¼åº¦ï¼ˆã¤ã¾ã‚Šã€ã“ã‚Œã‚ˆã‚Šä½ã„é¡ä¼¼åº¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯è€ƒæ…®ã—ãªã„åŸºæº–é¡ä¼¼åº¦ï¼‰ã‚’è¿”ã™</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>float</span> <span style=color:#a6e22e>minCompetitiveSimilarity</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (kResultsCollected <span style=color:#f92672>==</span> <span style=color:#66d9ef>false</span>) {
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// kä»¶ã®çµæœãŒé›†ã¾ã£ã¦ã„ãªã„å ´åˆã€Float.NEGATIVE_INFINITYã‚’è¿”ã™ã“ã¨ã§ã€ç¾å­˜ã™ã‚‹ã™ã¹ã¦ã®é¡ä¼¼åº¦ãŒç«¶äº‰åŠ›ã‚’æŒã£ã¦ã„ã‚‹ã¨ã¿ãªã™</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> Float.<span style=color:#a6e22e>NEGATIVE_INFINITY</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// kä»¶é›†ã¾ã£ã¦ã„ã‚‹å ´åˆã€ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ã®ç«¶äº‰åŠ›ã®ã‚ã‚‹æœ€å°é¡ä¼¼åº¦ã¨`nonCompetitiveQueue`ã®æœ€é«˜é¡ä¼¼åº¦ï¼ˆã¾ãŸã¯`cachedGlobalMinSim`ï¼‰ã‚’æ¯”è¼ƒã—ã¦å¤§ãã„æ–¹ã‚’è¿”ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®ä¸¡æ–¹ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã®æœ€å°é™ã®ç«¶äº‰åŠ›ã®ã‚ã‚‹é¡ä¼¼åº¦ãŒç¢ºå®šã•ã‚Œã‚‹ã€‚</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>max</span>(
</span></span><span style=display:flex><span>        subCollector.<span style=color:#a6e22e>minCompetitiveSimilarity</span>(),
</span></span><span style=display:flex><span>        Math.<span style=color:#a6e22e>min</span>(nonCompetitiveQueue.<span style=color:#a6e22e>peek</span>(), cachedGlobalMinSim));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=ä»Šå›ã®å®Ÿè£…ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒå®Ÿé¨“>ä»Šå›ã®å®Ÿè£…ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒå®Ÿé¨“</h2><p>Recall ã¯ 1-10%ä¸‹ãŒã£ã¦ã„ã‚‹ãŒã€QPS ãŒæœ€å¤§ 3 å€ã«ãªã‚‹ã€‚ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã¯ã‚ã‚‹ãŒ OPS ã®å‘ä¸Šã«ä¾¡å€¤ãŒã‚ã‚‹ã®ã§ã€Recall ã®æ¯€æã¯ç„¡è¦–</p><p><a href=https://github.com/apache/lucene/pull/12962#issuecomment-1919701631>https://github.com/apache/lucene/pull/12962#issuecomment-1919701631</a></p><p><img src=/posts/2024-03-11-0120/images/knn-benchmarking.png alt></p><h2 id=ã¾ã¨ã‚>ã¾ã¨ã‚</h2><p><a href=https://github.com/apache/lucene/pull/12962>Speedup concurrent multi-segment HNSW graph search 2 by mayya-sharipova Â· Pull Request #12962 Â· apache/lucene</a></p><p>ã§è¤‡æ•°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã¦ã€ä¸¦è¡Œã—ã¦è¿‘ä¼¼è¿‘å‚æ¢ç´¢ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€recall ã¯å°‘ã—æ—¢å­˜ã—ã¦ã„ã‚‹ãŒã€QPS ã¯ Nightly Benchmarking ã§ 2 å€ã»ã©æ”¹å–„ã•ã‚ŒãŸã€‚</p></content>---<p>é–¢é€£ã—ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„è¨˜äº‹</p><ul><li><a href=/posts/2024-03-05-2323/>Community Over Code North America 2023 ã«ã¦ Lucene é–¢ä¿‚ã§æ°—ã«ãªã£ãŸç™ºè¡¨ã¾ã¨ã‚</a></li><li><a href=/posts/2024-01-12-2308/>æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³OSSå‹‰å¼·ä¼š: Lucene ã‚„ OpenSearch ãªã©æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³OSSã¸ã®è²¢çŒ®ã‚’å¿µé ­ã«ã—ãŸã‚ªãƒ³ãƒ©ã‚¤ãƒ³å‹‰å¼·ä¼šã‚’ç«‹ã¡ä¸Šã’ã¦ã¿ãŸ</a></li><li><a href=/posts/2023-04-17-2252/>Twitter ã®æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ ã‚’å­¦ã¶ - æ¦‚è¦ç·¨</a></li><li><a href=/posts/2023-03-26-2208/>ç¾åœ¨ Lucene ã® KNN ãƒ™ã‚¯ãƒˆãƒ«ã®æœ€å¤§æ¬¡å…ƒæ•°ã¯1024æ¬¡å…ƒ ã ãŒã€ãã‚Œã‚’2048æ¬¡å…ƒã«å¤‰æ›´ã§ããªã„ã‹ã¨ã„ã†è­°è«–</a></li><li><a href=/posts/2023-03-11-1727/>åˆå¿ƒè€…ã ã‘ã© Apache Lucene ã«è²¢çŒ®ã—ãŸã„å ´åˆã«ãŠã™ã™ã‚ã®ãƒã‚±ãƒƒãƒˆãƒ©ãƒ™ãƒ«</a></li></ul><br>ğŸ“® ğŸ“§ ğŸ: è¨˜äº‹ã¸ã®<a href="https://docs.google.com/forms/d/e/1FAIpQLScgZVDrjQiKLbQRovfs88oweCITzjtvt1PlgwL14JfWPOrpPQ/viewform?usp=pp_url&entry.838298670=https%3a%2f%2fshunyaueta.com%2fposts%2f2024-03-11-0120%2f">æ„Ÿæƒ³</a>ã®ãŠãŸã‚ˆã‚Šã‚’ãŠã¾ã¡ã—ã¦ã¾ã™ã€‚
ãŠæ°—è»½ã«ãŠé€ã‚Šãã ã•ã„ã€‚
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ãŒã‚ã‚Œã°ãƒ¡ãƒ¼ãƒ«ã§è¿”ä¿¡ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚
ã‚‚ã¡ã‚ã‚“ãŠè¿”äº‹ã‚’å¸Œæœ›ã›ãšã«å˜ãªã‚‹æ„Ÿæƒ³ã ã‘ã§ã‚‚å¤§æ­“è¿ã§ã™ã€‚<br><br>ã“ã®ã‚µã‚¤ãƒˆã®æ›´æ–°æƒ…å ±ã‚’<a href=/index.xml>RSS</a>ã§é…ä¿¡ã—ã¦ã„ã¾ã™ã€‚
ãŠå¥½ããªãƒ•ã‚£ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼ã§è³¼èª­ã—ã¦ã¿ã¦ãã ã•ã„ã€‚<br><br>ã“ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®é‹å–¶ã‚„è‘—è€…ã®æ´»å‹•ã‚’æ”¯æ´ã—ã¦ã„ãŸã ã‘ã‚‹æ–¹ã‚’å‹Ÿé›†ã—ã¦ã„ã¾ã™ã€‚
ã‚‚ã—ã‚ˆã‚ã—ã‘ã‚Œã°ã€<a href=https://www.buymeacoffee.com/hurutoriya>Buy Me a Coffee</a> ã‹ã‚‰ã‚µãƒãƒ¼ãƒˆ(æŠ•ã’éŠ­)ã—ã¦ã„ãŸã ã‘ã‚‹ã¨ã€è‘—è€…ã®æ´»å‹•ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã«ç¹‹ãŒã‚Šã¾ã™âœ¨<br><br><p><a href=https://shunyaueta.com/tags/lucene/>#lucene</a>
<a href=https://shunyaueta.com/tags/%E6%A4%9C%E7%B4%A2%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3oss%E5%8B%89%E5%BC%B7%E4%BC%9A/>#æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³OSSå‹‰å¼·ä¼š</a></p></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo Ê•â€¢á´¥â€¢Ê” Bear</a></footer></body></html>