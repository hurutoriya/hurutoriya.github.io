<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=theme-color content="dark"><title>Standard SQLで 列と列の組み合わせの数を集計したい | Shunya Ueta</title><link rel=stylesheet href=/sass/main.min.1a3290acca8b3fc92df85ea9200859476d6c80d59009c89a749300f3ce7a7a67.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-39994406-11','auto');ga('send','pageview');}</script><meta property="og:title" content="Standard SQLで 列と列の組み合わせの数を集計したい"><meta property="og:description" content="group by は集計作業において根幹となる処理ですが、少し手の混んだ集計をしたいときに毎回調べていることが多かったのでここに学んだことをまとめておく
今回やりたいことは
A列がαになっている行のB列の種類を集計したい
です。
はじめに 実際のデータを用意したほうが、理解が深まるので擬似的なテーブルを作成する。 テーブルのデータの概略として、何日にsender (送信者) が receiver (受信者) にいくら送金(price)したかを格納しているテーブルとする。
StandardSQLはWITHを使って簡単にモックテーブルを作れるのが良いところ。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96  #standardSQL WITH `transactions` AS ( SELECT 'A' AS sender, 'B' AS receiver, 600 AS price, '2020-01-01' AS day UNION ALL SELECT 'A', 'B', 1200, '2020-01-01' UNION ALL SELECT 'A', 'B', 600, '2020-01-01' UNION ALL SELECT 'A', 'C', 2000, '2020-01-01' UNION ALL SELECT 'A', 'D', 3000, '2020-01-01' UNION ALL SELECT 'A', 'D', 2000, '2020-01-01' UNION ALL SELECT 'B', 'C', 700, '2020-01-01' UNION ALL SELECT 'B', 'C', 300, '2020-01-01' UNION ALL SELECT 'B', 'D', 250, '2020-01-01' UNION ALL SELECT 'A', 'B', 400, '2020-01-02' UNION ALL SELECT 'A', 'B', 1000, '2020-01-02' UNION ALL SELECT 'A', 'B', 1200, '2020-01-02' UNION ALL SELECT 'A', 'B', 2000, '2020-01-02' UNION ALL SELECT 'B', 'C', 450, '2020-01-02' UNION ALL SELECT 'B', 'C', 500, '2020-01-02' ) SELECT * FROM transactions      sender receiver price day     A B 600 2020-01-01   A B 1200 2020-01-01   A B 1800 2020-01-01   A C 2000 2020-01-01   A D 3000 2020-01-01   A D 2000 2020-01-01   B C 700 2020-01-01   B C 300 2020-01-01   B D 250 2020-01-01   A B 400 2020-01-02   A B 1000 2020-01-02   A B 1200 2020-01-02   A B 2000 2020-01-02   B C 450 2020-01-02   B C 500 2020-01-02    列と列の組み合わせの数を集計する 日次ごとに送金者が何人に送ったかを集計したい、つまり(sender, receiver)のペアを考えて、sender を固定した上で何人に送金したいかを集計したとする。 上記のデータだと"><meta property="og:type" content="article"><meta property="og:url" content="https://shunyaueta.com/posts/2021-02-09/"><meta property="og:image" content="https://shunyaueta.com/ogp.jpg"><meta property="article:published_time" content="2021-02-09T23:27:37+09:00"><meta property="article:modified_time" content="2021-10-06T21:14:44+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://shunyaueta.com/ogp.jpg"><meta name=twitter:title content="Standard SQLで 列と列の組み合わせの数を集計したい"><meta name=twitter:description content="group by は集計作業において根幹となる処理ですが、少し手の混んだ集計をしたいときに毎回調べていることが多かったのでここに学んだことをまとめておく
今回やりたいことは
A列がαになっている行のB列の種類を集計したい
です。
はじめに 実際のデータを用意したほうが、理解が深まるので擬似的なテーブルを作成する。 テーブルのデータの概略として、何日にsender (送信者) が receiver (受信者) にいくら送金(price)したかを格納しているテーブルとする。
StandardSQLはWITHを使って簡単にモックテーブルを作れるのが良いところ。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96  #standardSQL WITH `transactions` AS ( SELECT 'A' AS sender, 'B' AS receiver, 600 AS price, '2020-01-01' AS day UNION ALL SELECT 'A', 'B', 1200, '2020-01-01' UNION ALL SELECT 'A', 'B', 600, '2020-01-01' UNION ALL SELECT 'A', 'C', 2000, '2020-01-01' UNION ALL SELECT 'A', 'D', 3000, '2020-01-01' UNION ALL SELECT 'A', 'D', 2000, '2020-01-01' UNION ALL SELECT 'B', 'C', 700, '2020-01-01' UNION ALL SELECT 'B', 'C', 300, '2020-01-01' UNION ALL SELECT 'B', 'D', 250, '2020-01-01' UNION ALL SELECT 'A', 'B', 400, '2020-01-02' UNION ALL SELECT 'A', 'B', 1000, '2020-01-02' UNION ALL SELECT 'A', 'B', 1200, '2020-01-02' UNION ALL SELECT 'A', 'B', 2000, '2020-01-02' UNION ALL SELECT 'B', 'C', 450, '2020-01-02' UNION ALL SELECT 'B', 'C', 500, '2020-01-02' ) SELECT * FROM transactions      sender receiver price day     A B 600 2020-01-01   A B 1200 2020-01-01   A B 1800 2020-01-01   A C 2000 2020-01-01   A D 3000 2020-01-01   A D 2000 2020-01-01   B C 700 2020-01-01   B C 300 2020-01-01   B D 250 2020-01-01   A B 400 2020-01-02   A B 1000 2020-01-02   A B 1200 2020-01-02   A B 2000 2020-01-02   B C 450 2020-01-02   B C 500 2020-01-02    列と列の組み合わせの数を集計する 日次ごとに送金者が何人に送ったかを集計したい、つまり(sender, receiver)のペアを考えて、sender を固定した上で何人に送金したいかを集計したとする。 上記のデータだと"></head><body class=dark><nav class=navbar><div class=container><div class=flex><div><a class=brand href=/><span class=emoji>🦅</span>
Shunya Ueta</a></div><div class=flex><a href=/articles/>All posts</a>
<button id=dark-mode-button></button></div></div></div></nav><main><div class=container><article><header class=article-header><div class=thumb><div><h1>Standard SQLで 列と列の組み合わせの数を集計したい</h1><div class=post-meta><div>By on <time>2021.02.09</time> (Last updated:<time>2021.10.06</time>)</div><div class=tags><a href=/tags/sql/>sql</a>
<a href=/tags/dataanalysis/>dataanalysis</a></div></div></div></div></header></article><div class=article-post><p>group by は集計作業において根幹となる処理ですが、少し手の混んだ集計をしたいときに毎回調べていることが多かったのでここに学んだことをまとめておく</p><p>今回やりたいことは</p><p>A列がαになっている行のB列の種類を集計したい</p><p>です。</p><h2 id=はじめに>はじめに</h2><p>実際のデータを用意したほうが、理解が深まるので擬似的なテーブルを作成する。
テーブルのデータの概略として、何日にsender (送信者) が receiver (受信者) にいくら送金(price)したかを格納しているテーブルとする。</p><p>StandardSQLはWITHを使って簡単にモックテーブルを作れるのが良いところ。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=o>#</span><span class=n>standardSQL</span>
<span class=k>WITH</span>
  <span class=o>`</span><span class=n>transactions</span><span class=o>`</span> <span class=k>AS</span> <span class=p>(</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span> <span class=k>AS</span> <span class=n>sender</span><span class=p>,</span>
    <span class=s1>&#39;B&#39;</span> <span class=k>AS</span> <span class=n>receiver</span><span class=p>,</span>
    <span class=mi>600</span> <span class=k>AS</span> <span class=n>price</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span> <span class=k>AS</span> <span class=k>day</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=mi>1200</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=mi>600</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;C&#39;</span><span class=p>,</span>
    <span class=mi>2000</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;D&#39;</span><span class=p>,</span>
    <span class=mi>3000</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;D&#39;</span><span class=p>,</span>
    <span class=mi>2000</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=s1>&#39;C&#39;</span><span class=p>,</span>
    <span class=mi>700</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=s1>&#39;C&#39;</span><span class=p>,</span>
    <span class=mi>300</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=s1>&#39;D&#39;</span><span class=p>,</span>
    <span class=mi>250</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=mi>400</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-02&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=mi>1000</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-02&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=mi>1200</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-02&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=mi>2000</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-02&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=s1>&#39;C&#39;</span><span class=p>,</span>
    <span class=mi>450</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-02&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=s1>&#39;C&#39;</span><span class=p>,</span>
    <span class=mi>500</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-02&#39;</span> <span class=p>)</span>
<span class=k>SELECT</span>
    <span class=o>*</span>
<span class=k>FROM</span>
  <span class=n>transactions</span>
</code></pre></td></tr></table></div></div><table><thead><tr><th>sender</th><th>receiver</th><th>price</th><th>day</th></tr></thead><tbody><tr><td>A</td><td>B</td><td>600</td><td>2020-01-01</td></tr><tr><td>A</td><td>B</td><td>1200</td><td>2020-01-01</td></tr><tr><td>A</td><td>B</td><td>1800</td><td>2020-01-01</td></tr><tr><td>A</td><td>C</td><td>2000</td><td>2020-01-01</td></tr><tr><td>A</td><td>D</td><td>3000</td><td>2020-01-01</td></tr><tr><td>A</td><td>D</td><td>2000</td><td>2020-01-01</td></tr><tr><td>B</td><td>C</td><td>700</td><td>2020-01-01</td></tr><tr><td>B</td><td>C</td><td>300</td><td>2020-01-01</td></tr><tr><td>B</td><td>D</td><td>250</td><td>2020-01-01</td></tr><tr><td>A</td><td>B</td><td>400</td><td>2020-01-02</td></tr><tr><td>A</td><td>B</td><td>1000</td><td>2020-01-02</td></tr><tr><td>A</td><td>B</td><td>1200</td><td>2020-01-02</td></tr><tr><td>A</td><td>B</td><td>2000</td><td>2020-01-02</td></tr><tr><td>B</td><td>C</td><td>450</td><td>2020-01-02</td></tr><tr><td>B</td><td>C</td><td>500</td><td>2020-01-02</td></tr></tbody></table><h2 id=列と列の組み合わせの数を集計する>列と列の組み合わせの数を集計する</h2><p>日次ごとに送金者が何人に送ったかを集計したい、つまり(sender, receiver)のペアを考えて、sender を固定した上で何人に送金したいかを集計したとする。
上記のデータだと</p><p>2020-01-01 では {(A,B), (A,C), (A,D)} の三通りになる。</p><p>愚直に思いつくのは</p><h3 id=group-by-を２つの列で行うパターン>group by を２つの列で行うパターン</h3><ul><li>day</li><li>sender</li></ul><p>を<code>group by</code> してCOUNT(distinct sender)で集計するアプローチがあるが、</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span>
  <span class=k>day</span><span class=p>,</span>
  <span class=n>sender</span><span class=p>,</span>
  <span class=k>COUNT</span><span class=p>(</span><span class=k>distinct</span>  <span class=n>receiver</span><span class=p>)</span> <span class=k>AS</span> <span class=n>receiver_uu</span>
<span class=k>FROM</span>
  <span class=n>transactions</span>
<span class=k>GROUP</span> <span class=k>BY</span>
  <span class=k>day</span><span class=p>,</span>
  <span class=n>sender</span>
</code></pre></td></tr></table></div></div><h4 id=結果>結果</h4><table><thead><tr><th>day</th><th>sender</th><th>receiver_uu</th></tr></thead><tbody><tr><td>2020-01-01</td><td>A</td><td>3</td></tr><tr><td>2020-01-01</td><td>B</td><td>2</td></tr><tr><td>2020-01-02</td><td>A</td><td>1</td></tr><tr><td>2020-01-02</td><td>B</td><td>1</td></tr></tbody></table><p><code>day</code>, <code>sender</code> の組み合わせとなっている。
このクエリを WITH でテーブルにして、Where でフィルターをかけると</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=n>receiver_uu</span> <span class=k>AS</span> <span class=p>(</span>
  <span class=k>SELECT</span>
    <span class=k>day</span><span class=p>,</span>
    <span class=n>sender</span><span class=p>,</span>
    <span class=k>COUNT</span><span class=p>(</span><span class=k>DISTINCT</span> <span class=n>receiver</span><span class=p>)</span> <span class=k>AS</span> <span class=n>receiver_uu</span>
  <span class=k>FROM</span>
    <span class=n>transactions</span>
  <span class=k>GROUP</span> <span class=k>BY</span>
    <span class=k>day</span><span class=p>,</span>
    <span class=n>sender</span><span class=p>)</span>
<span class=k>SELECT</span>
  <span class=o>*</span>
<span class=k>FROM</span>
  <span class=n>receiver_uu</span>
<span class=k>WHERE</span>
  <span class=n>sender</span> <span class=o>=</span> <span class=s1>&#39;A&#39;</span>
</code></pre></td></tr></table></div></div><table><thead><tr><th>day</th><th>sender</th><th>receiver_uu</th></tr></thead><tbody><tr><td>2020-01-01</td><td>A</td><td>3</td></tr><tr><td>2020-01-02</td><td>A</td><td>1</td></tr></tbody></table><p>の結果が得られる。</p><p>だが、<code>day</code>を基準に送信者、<code>A</code>と<code>B</code>の情報を1行にまとめたい場合はどうすべきだろうか?</p><h3 id=1行に2列のパターン数をまとめて集計する>1行に2列のパターン数をまとめて集計する</h3><p><code>A</code>と<code>B</code>が送り先の数を調べたいなどの目的がある際には、COUNT()を行う際にIF文で条件を集計することで上記を達成することができる。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span>
  <span class=k>day</span><span class=p>,</span>
  <span class=k>COUNT</span><span class=p>(</span><span class=k>DISTINCT</span>
    <span class=c1>-- 以下の結果の重複排除
</span><span class=c1></span>  <span class=k>IF</span>
    <span class=p>(</span><span class=n>sender</span><span class=o>=</span><span class=s1>&#39;A&#39;</span><span class=p>,</span>
      <span class=c1>-- sender がAだったときに
</span><span class=c1></span>      <span class=n>receiver</span><span class=p>,</span>
      <span class=c1>-- receiver を返す
</span><span class=c1></span>      <span class=k>NULL</span><span class=p>)</span>
    <span class=c1>-- それいがいはNULL
</span><span class=c1></span>    <span class=p>)</span> <span class=k>AS</span> <span class=n>from_A_receiver_uu</span><span class=p>,</span>
  <span class=k>COUNT</span><span class=p>(</span><span class=k>DISTINCT</span>
  <span class=k>IF</span>
    <span class=p>(</span><span class=n>sender</span><span class=o>=</span><span class=s1>&#39;B&#39;</span><span class=p>,</span>
      <span class=n>receiver</span><span class=p>,</span>
      <span class=k>NULL</span><span class=p>))</span> <span class=k>AS</span> <span class=n>from_B_receiver_uu</span>
<span class=k>FROM</span>
  <span class=n>transactions</span>
<span class=k>GROUP</span> <span class=k>BY</span>
  <span class=k>day</span>
</code></pre></td></tr></table></div></div><p>流れを説明すると</p><ol><li>day で日次を基準にした計算を行う</li><li>IF(sender='A&rsquo;, receiver, NULL) で、スキャン時に<code>A</code>が送信した場合はその同行の<code>reciver</code> を返し、<code>A</code>でなかった場合はNULLを返す</li><li>2の結果の重複を排除して、その行数をカウントする</li></ol><p>上記の処理のイメージ (<code>2020-01-01</code>の場合)</p><ol><li>COUNT(Distinct IF(sender='A&rsquo;,receiver, NULL))</li><li>COUNT(Distinct (B,B,B,C,D,D,NULL,NULL,NULL))</li><li>COUNT((B,C,D))</li><li>3</li></ol><p>となり、<code>A</code>が<code>2020-01-01</code>に送信した人数は3人となる。</p><h4 id=結果-1>結果</h4><table><thead><tr><th>day</th><th>from_A_receiver_uu</th><th>from_B_receiver_uu</th></tr></thead><tbody><tr><td>2020-01-01</td><td>3</td><td>2</td></tr><tr><td>2020-01-02</td><td>1</td><td>1</td></tr></tbody></table><p>今回は(A,B)の組み合わせでAを固定した際のパターン数を集計したが、Aの種類が大規模な場合はSELECT文をすべて書ききるの現実ではないが、A自体が有限で集計したい場合はよくある処理なのでメモとしてまとめた。
UUなどを計算したいときは必須の集計になると思います。</p><h4 id=ref>Ref</h4><ul><li><a href=https://stackoverflow.com/questions/52281618/syntax-to-count-the-number-of-unique-matching-values>Syntax to count the number of UNIQUE matching values</a></li><li><a href=https://chartio.com/resources/tutorials/how-countdistinct-field-works-in-google-bigquery/>How COUNT(DISTINCT [field]) Works in Google BigQuery</a></li></ul></div></div><div class=container><nav class="flex container suggested"><a rel=prev href=/posts/2021-02-08/ title="Previous post (older)"><span>Previous</span>
pip 実行時に sys.stderr.write(f"ERROR: {exc} ") とエラーが出てpipを実行できないときの対処方法</a>
<a rel=next href=/posts/2021-02-21/ title="Next post (newer)"><span>Next</span>
GKE でローリングアップデート後、ローカルからポートフォワードでリクエストを投げるとcurl: (52) Empty reply from server と返ってくるときの対処方法</a></nav></div></main></main><footer class="footer flex"><section class=container><nav class=footer-links><a href=/index.xml>RSS</a></nav></section><script async src=/js/features.min.a94f58a30ad2560de728e080d87f75c60cf806fd1b3d5f4815f1a1a02c0d1859.js></script></footer></body></html>