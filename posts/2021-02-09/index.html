<!doctype html><html><head><script data-ad-client=ca-pub-8604812913439531 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Shunya Ueta (a.k.a hurutoriya) personal website"><link rel="shortcut icon" href=https://shunyaueta.com/favicon.ico><link rel=stylesheet href=/css/style.min.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-39994406-11"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-39994406-11');</script><title>Standard SQLで 列と列の組み合わせの数を集計したい</title></head><body><header id=banner><h2><a href=https://shunyaueta.com/>Software Engineer as Data Scientist</a></h2><nav><ul><li><a href=/ title=posts>posts</a></li><li><a href=/about/ title=about>about</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Standard SQLで 列と列の組み合わせの数を集計したい</h1><time>2021-02-09</time></header><p>group by は集計作業において根幹となる処理ですが、少し手の混んだ集計をしたいときに毎回調べていることが多かったのでここに学んだことをまとめておく</p><p>今回やりたいことは</p><p>A列がαになっている行のB列の種類を集計したい</p><p>です。</p><h2 id=はじめに>はじめに</h2><p>実際のデータを用意したほうが、理解が深まるので擬似的なテーブルを作成する。
テーブルのデータの概略として、何日にsender (送信者) が receiver (受信者) にいくら送金(price)したかを格納しているテーブルとする。</p><p>StandardSQLはWITHを使って簡単にモックテーブルを作れるのが良いところ。</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=o>#</span><span class=n>standardSQL</span>
<span class=k>WITH</span>
  <span class=o>`</span><span class=n>transactions</span><span class=o>`</span> <span class=k>AS</span> <span class=p>(</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span> <span class=k>AS</span> <span class=n>sender</span><span class=p>,</span>
    <span class=s1>&#39;B&#39;</span> <span class=k>AS</span> <span class=n>receiver</span><span class=p>,</span>
    <span class=mi>600</span> <span class=k>AS</span> <span class=n>price</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span> <span class=k>AS</span> <span class=k>day</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=mi>1200</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=mi>600</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;C&#39;</span><span class=p>,</span>
    <span class=mi>2000</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;D&#39;</span><span class=p>,</span>
    <span class=mi>3000</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;D&#39;</span><span class=p>,</span>
    <span class=mi>2000</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=s1>&#39;C&#39;</span><span class=p>,</span>
    <span class=mi>700</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=s1>&#39;C&#39;</span><span class=p>,</span>
    <span class=mi>300</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=s1>&#39;D&#39;</span><span class=p>,</span>
    <span class=mi>250</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-01&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=mi>400</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-02&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=mi>1000</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-02&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=mi>1200</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-02&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;A&#39;</span><span class=p>,</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=mi>2000</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-02&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=s1>&#39;C&#39;</span><span class=p>,</span>
    <span class=mi>450</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-02&#39;</span>
  <span class=k>UNION</span> <span class=k>ALL</span>
  <span class=k>SELECT</span>
    <span class=s1>&#39;B&#39;</span><span class=p>,</span>
    <span class=s1>&#39;C&#39;</span><span class=p>,</span>
    <span class=mi>500</span><span class=p>,</span>
    <span class=s1>&#39;2020-01-02&#39;</span> <span class=p>)</span>
<span class=k>SELECT</span>
    <span class=o>*</span>
<span class=k>FROM</span>
  <span class=n>transactions</span>
</code></pre></div><table><thead><tr><th>sender</th><th>receiver</th><th>price</th><th>day</th></tr></thead><tbody><tr><td>A</td><td>B</td><td>600</td><td>2020-01-01</td></tr><tr><td>A</td><td>B</td><td>1200</td><td>2020-01-01</td></tr><tr><td>A</td><td>B</td><td>1800</td><td>2020-01-01</td></tr><tr><td>A</td><td>C</td><td>2000</td><td>2020-01-01</td></tr><tr><td>A</td><td>D</td><td>3000</td><td>2020-01-01</td></tr><tr><td>A</td><td>D</td><td>2000</td><td>2020-01-01</td></tr><tr><td>B</td><td>C</td><td>700</td><td>2020-01-01</td></tr><tr><td>B</td><td>C</td><td>300</td><td>2020-01-01</td></tr><tr><td>B</td><td>D</td><td>250</td><td>2020-01-01</td></tr><tr><td>A</td><td>B</td><td>400</td><td>2020-01-02</td></tr><tr><td>A</td><td>B</td><td>1000</td><td>2020-01-02</td></tr><tr><td>A</td><td>B</td><td>1200</td><td>2020-01-02</td></tr><tr><td>A</td><td>B</td><td>2000</td><td>2020-01-02</td></tr><tr><td>B</td><td>C</td><td>450</td><td>2020-01-02</td></tr><tr><td>B</td><td>C</td><td>500</td><td>2020-01-02</td></tr></tbody></table><h2 id=列と列の組み合わせの数を集計する>列と列の組み合わせの数を集計する</h2><p>日次ごとに送金者が何人に送ったかを集計したい、つまり(sender, receiver)のペアを考えて、sender を固定した上で何人に送金したいかを集計したとする。
上記のデータだと</p><p>2020-01-01 では {(A,B), (A,C), (A,D)} の三通りになる。</p><p>愚直に思いつくのは</p><h3 id=group-by-を２つの列で行うパターン>group by を２つの列で行うパターン</h3><ul><li>day</li><li>sender</li></ul><p>を<code>group by</code> してCOUNT(distinct sender)で集計するアプローチがあるが、</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span>
  <span class=k>day</span><span class=p>,</span>
  <span class=n>sender</span><span class=p>,</span>
  <span class=k>COUNT</span><span class=p>(</span><span class=k>distinct</span>  <span class=n>receiver</span><span class=p>)</span> <span class=k>AS</span> <span class=n>receiver_uu</span>
<span class=k>FROM</span>
  <span class=n>transactions</span>
<span class=k>GROUP</span> <span class=k>BY</span>
  <span class=k>day</span><span class=p>,</span>
  <span class=n>sender</span>
</code></pre></div><h4 id=結果>結果</h4><table><thead><tr><th>day</th><th>sender</th><th>receiver_uu</th></tr></thead><tbody><tr><td>2020-01-01</td><td>A</td><td>3</td></tr><tr><td>2020-01-01</td><td>B</td><td>2</td></tr><tr><td>2020-01-02</td><td>A</td><td>1</td></tr><tr><td>2020-01-02</td><td>B</td><td>1</td></tr></tbody></table><p><code>day</code>, <code>sender</code> の組み合わせとなっている。
このクエリを WITH でテーブルにして、Where でフィルターをかけると</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=n>receiver_uu</span> <span class=k>AS</span> <span class=p>(</span>
  <span class=k>SELECT</span>
    <span class=k>day</span><span class=p>,</span>
    <span class=n>sender</span><span class=p>,</span>
    <span class=k>COUNT</span><span class=p>(</span><span class=k>DISTINCT</span> <span class=n>receiver</span><span class=p>)</span> <span class=k>AS</span> <span class=n>receiver_uu</span>
  <span class=k>FROM</span>
    <span class=n>transactions</span>
  <span class=k>GROUP</span> <span class=k>BY</span>
    <span class=k>day</span><span class=p>,</span>
    <span class=n>sender</span><span class=p>)</span>
<span class=k>SELECT</span>
  <span class=o>*</span>
<span class=k>FROM</span>
  <span class=n>receiver_uu</span>
<span class=k>WHERE</span>
  <span class=n>sender</span> <span class=o>=</span> <span class=s1>&#39;A&#39;</span>
</code></pre></div><table><thead><tr><th>day</th><th>sender</th><th>receiver_uu</th></tr></thead><tbody><tr><td>2020-01-01</td><td>A</td><td>3</td></tr><tr><td>2020-01-02</td><td>A</td><td>1</td></tr></tbody></table><p>の結果が得られる。</p><p>だが、<code>day</code>を基準に送信者、<code>A</code>と<code>B</code>の情報を1行にまとめたい場合はどうすべきだろうか?</p><h3 id=1行に2列のパターン数をまとめて集計する>1行に2列のパターン数をまとめて集計する</h3><p><code>A</code>と<code>B</code>が送り先の数を調べたいなどの目的がある際には、COUNT()を行う際にIF文で条件を集計することで上記を達成することができる。</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span>
  <span class=k>day</span><span class=p>,</span>
  <span class=k>COUNT</span><span class=p>(</span><span class=k>DISTINCT</span>
    <span class=c1>-- 以下の結果の重複排除
</span><span class=c1></span>  <span class=k>IF</span>
    <span class=p>(</span><span class=n>sender</span><span class=o>=</span><span class=s1>&#39;A&#39;</span><span class=p>,</span>
      <span class=c1>-- sender がAだったときに
</span><span class=c1></span>      <span class=n>receiver</span><span class=p>,</span>
      <span class=c1>-- receiver を返す
</span><span class=c1></span>      <span class=k>NULL</span><span class=p>)</span>
    <span class=c1>-- それいがいはNULL
</span><span class=c1></span>    <span class=p>)</span> <span class=k>AS</span> <span class=n>from_A_receiver_uu</span><span class=p>,</span>
  <span class=k>COUNT</span><span class=p>(</span><span class=k>DISTINCT</span>
  <span class=k>IF</span>
    <span class=p>(</span><span class=n>sender</span><span class=o>=</span><span class=s1>&#39;B&#39;</span><span class=p>,</span>
      <span class=n>receiver</span><span class=p>,</span>
      <span class=k>NULL</span><span class=p>))</span> <span class=k>AS</span> <span class=n>from_B_receiver_uu</span>
<span class=k>FROM</span>
  <span class=n>transactions</span>
<span class=k>GROUP</span> <span class=k>BY</span>
  <span class=k>day</span>
</code></pre></div><p>流れを説明すると</p><ol><li>day で日次を基準にした計算を行う</li><li>IF(sender='A&rsquo;, receiver, NULL) で、スキャン時に<code>A</code>が送信した場合はその同行の<code>reciver</code> を返し、<code>A</code>でなかった場合はNULLを返す</li><li>2の結果の重複を排除して、その行数をカウントする</li></ol><p>上記の処理のイメージ (<code>2020-01-01</code>の場合)</p><ol><li>COUNT(Distinct IF(sender='A&rsquo;,receiver, NULL))</li><li>COUNT(Distinct (B,B,B,C,D,D,NULL,NULL,NULL))</li><li>COUNT((B,C,D))</li><li>3</li></ol><p>となり、<code>A</code>が<code>2020-01-01</code>に送信した人数は3人となる。</p><h4 id=結果-1>結果</h4><table><thead><tr><th>day</th><th>from_A_receiver_uu</th><th>from_B_receiver_uu</th></tr></thead><tbody><tr><td>2020-01-01</td><td>3</td><td>2</td></tr><tr><td>2020-01-02</td><td>1</td><td>1</td></tr></tbody></table><p>今回は(A,B)の組み合わせでAを固定した際のパターン数を集計したが、Aの種類が大規模な場合はSELECT文をすべて書ききるの現実ではないが、A自体が有限で集計したい場合はよくある処理なのでメモとしてまとめた。
UUなどを計算したいときは必須の集計になると思います。</p><h4 id=ref>Ref</h4><ul><li><a href=https://stackoverflow.com/questions/52281618/syntax-to-count-the-number-of-unique-matching-values>Syntax to count the number of UNIQUE matching values</a></li><li><a href=https://chartio.com/resources/tutorials/how-countdistinct-field-works-in-google-bigquery/>How COUNT(DISTINCT [field]) Works in Google BigQuery</a></li></ul></article></main><footer id=footer>Copyright © 2013-2021 Shunya Ueta</footer></body></html>