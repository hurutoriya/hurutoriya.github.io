<!doctype html><html lang=ja><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Community Over Code North America 2023 ã«ã¦ Lucene é–¢ä¿‚ã§æ°—ã«ãªã£ãŸç™ºè¡¨ã¾ã¨ã‚ | Shunya Ueta</title>
<meta name=title content="Community Over Code North America 2023 ã«ã¦ Lucene é–¢ä¿‚ã§æ°—ã«ãªã£ãŸç™ºè¡¨ã¾ã¨ã‚"><meta name=description content="ç‰¹ã« Uber æ¤œç´¢åŸºç›¤ã®è©±ã¨ã€Amazon ã® benchmarking, æ­£è¦è¡¨ç¾æ¤œç´¢ãŒæ¥½ã—ãã†
Lessons Learned from Benchmarking Amazonâ€™s E-commerce Search Engine The search engine on Amazonâ€™s retail website runs on Lucene. It makes billions of products available to customers in less than 1 second per query. At this scale, every wasted millisecond comes at a large cost, so performance tests have to be thorough. Last year, we took inventory of our benchmarks, quantified the noise and bias we were seeing, introduced measurements for the statistical significance of results, and addressed sources of inconsistency (e."><meta name=keywords content="lucene,search,"><meta property="og:title" content="Community Over Code North America 2023 ã«ã¦ Lucene é–¢ä¿‚ã§æ°—ã«ãªã£ãŸç™ºè¡¨ã¾ã¨ã‚"><meta property="og:description" content="ç‰¹ã« Uber æ¤œç´¢åŸºç›¤ã®è©±ã¨ã€Amazon ã® benchmarking, æ­£è¦è¡¨ç¾æ¤œç´¢ãŒæ¥½ã—ãã†
Lessons Learned from Benchmarking Amazonâ€™s E-commerce Search Engine The search engine on Amazonâ€™s retail website runs on Lucene. It makes billions of products available to customers in less than 1 second per query. At this scale, every wasted millisecond comes at a large cost, so performance tests have to be thorough. Last year, we took inventory of our benchmarks, quantified the noise and bias we were seeing, introduced measurements for the statistical significance of results, and addressed sources of inconsistency (e."><meta property="og:type" content="article"><meta property="og:url" content="https://shunyaueta.com/posts/2024-03-05-2323/"><meta property="og:image" content="https://shunyaueta.com/ogp.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-05T23:23:56+09:00"><meta property="article:modified_time" content="2024-03-05T23:23:56+09:00"><meta property="og:site_name" content="Shunya Ueta"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://shunyaueta.com/ogp.jpg"><meta name=twitter:title content="Community Over Code North America 2023 ã«ã¦ Lucene é–¢ä¿‚ã§æ°—ã«ãªã£ãŸç™ºè¡¨ã¾ã¨ã‚"><meta name=twitter:description content="ç‰¹ã« Uber æ¤œç´¢åŸºç›¤ã®è©±ã¨ã€Amazon ã® benchmarking, æ­£è¦è¡¨ç¾æ¤œç´¢ãŒæ¥½ã—ãã†
Lessons Learned from Benchmarking Amazonâ€™s E-commerce Search Engine The search engine on Amazonâ€™s retail website runs on Lucene. It makes billions of products available to customers in less than 1 second per query. At this scale, every wasted millisecond comes at a large cost, so performance tests have to be thorough. Last year, we took inventory of our benchmarks, quantified the noise and bias we were seeing, introduced measurements for the statistical significance of results, and addressed sources of inconsistency (e."><meta itemprop=name content="Community Over Code North America 2023 ã«ã¦ Lucene é–¢ä¿‚ã§æ°—ã«ãªã£ãŸç™ºè¡¨ã¾ã¨ã‚"><meta itemprop=description content="ç‰¹ã« Uber æ¤œç´¢åŸºç›¤ã®è©±ã¨ã€Amazon ã® benchmarking, æ­£è¦è¡¨ç¾æ¤œç´¢ãŒæ¥½ã—ãã†
Lessons Learned from Benchmarking Amazonâ€™s E-commerce Search Engine The search engine on Amazonâ€™s retail website runs on Lucene. It makes billions of products available to customers in less than 1 second per query. At this scale, every wasted millisecond comes at a large cost, so performance tests have to be thorough. Last year, we took inventory of our benchmarks, quantified the noise and bias we were seeing, introduced measurements for the statistical significance of results, and addressed sources of inconsistency (e."><meta itemprop=datePublished content="2024-03-05T23:23:56+09:00"><meta itemprop=dateModified content="2024-03-05T23:23:56+09:00"><meta itemprop=wordCount content="593"><meta itemprop=image content="https://shunyaueta.com/ogp.jpg"><meta itemprop=keywords content="lucene,search,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px;overflow-x:auto}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-JMJRQJT0Q3"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JMJRQJT0Q3")</script></head><body><header><a href=/ class=title><h2>Shunya Ueta</h2></a><nav><a href=/about/>è‘—è€…ã«ã¤ã„ã¦</a>
<a href=/index.xml>RSS</a></nav></header><main><h1>Community Over Code North America 2023 ã«ã¦ Lucene é–¢ä¿‚ã§æ°—ã«ãªã£ãŸç™ºè¡¨ã¾ã¨ã‚</h1><p><i><time datetime=2024-03-05 pubdate>2024-03-05</time></i></p><content><p>ç‰¹ã« Uber æ¤œç´¢åŸºç›¤ã®è©±ã¨ã€Amazon ã® benchmarking, æ­£è¦è¡¨ç¾æ¤œç´¢ãŒæ¥½ã—ãã†</p><h2 id=lessons-learned-from-benchmarking-amazons-e-commerce-search-engine>Lessons Learned from Benchmarking Amazonâ€™s E-commerce Search Engine</h2><blockquote><p>The search engine on Amazonâ€™s retail website runs on Lucene. It makes billions of products available to customers in less than 1 second per query. At this scale, every wasted millisecond comes at a large cost, so performance tests have to be thorough. Last year, we took inventory of our benchmarks, quantified the noise and bias we were seeing, introduced measurements for the statistical significance of results, and addressed sources of inconsistency (e.g.: caching, index geometry). We arenâ€™t done, but this is a step in the right direction â€“ benchmarks that are accurate, precise, and quick enough to remain useful. This talk will tell that story and help you move in the same direction. (<a href=https://communityovercode.org/wp-content/uploads/2023/10/sun_performance_vodita-stefan-vodita.pptx>Slides</a>)</p></blockquote><p>Amazon ã®æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚­ãƒ³ã‚°ã«ã¤ã„ã¦ã®ç™ºè¡¨</p><h2 id=search-at-uber-over-apache-lucene>Search at Uber over Apache Lucene</h2><blockquote><p>In this talk, weâ€™ll give an overview of the Search platform at Uber, and share how we built a scalable and high-performance platform over Apache Lucene. Weâ€™ll highlight several business-critical use cases at Uber powered-by the search platform such as UberEats Discovery and Maps search. We will discuss the unique challenges from these use cases such as strong data freshness and geospatial search requirements. Next, weâ€™ll present the overall architecture of the search platform, built on top of Apache Lucene, and explain how it addresses the challenges via a Base/Snapshot/Live (BSL) fashion of index structure. Lastly, weâ€™ll share several ongoing interesting efforts that leverage new features from Lucene such as HNSW for vector search. (<a href=https://communityovercode.org/wp-content/uploads/2023/10/sat_search_search-at-uber-over-apache-lucene-yupeng-fu.pdf>Slides</a>)</p></blockquote><p>Uber ã§ Apache Lucene ã‚’ä½¿ã£ã¦ã©ã®ã‚ˆã†ã«æ¤œç´¢åŸºç›¤ã‚’ä½œæˆã—ã¦ã„ã‚‹ã‹</p><h2 id=introducing-multi-valued-vector-fields-in-apache-lucene>Introducing Multi-valued Vector Fields in Apache Lucene</h2><blockquote><p>Since the introduction of native vector-based search in Apache Lucene happened, many features have been developed, but the support for multiple vectors in a dedicated KNN vector field remained to explore. Having the possibility of indexing (and searching) multiple values per field unlocks the possibility of working with long textual documents, splitting them into paragraphs, and encoding each paragraph as a separate vector: a scenario that is often encountered by many businesses. This talk explores the challenges, the technical design and the implementation activities that happened during the work for this contribution to the Apache Lucene project. The audience is expected to get an understanding of how multi-valued fields can work in a vector-based search use case and how this feature has been implemented.</p></blockquote><p>Lucene ã®è¤‡æ•°ã®å€¤ã‚’æŒã¤ãƒ™ã‚¯ãƒˆãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç´¹ä»‹
è¤‡æ•°ã«åˆ†å‰²ã™ã‚‹ã“ã¨ã§ã€é•·ã™ãã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã¦ã‚‚åˆ†å‰²ã—ã¦ãƒ™ã‚¯ãƒˆãƒ«ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§æ‰±ã†ã“ã¨ãŒå¯èƒ½ã«ãªã£ãŸ</p><h2 id=fighting-adversarial-regular-expressions-in-apache-lucene>Fighting Adversarial Regular Expressions in Apache Lucene</h2><blockquote><p>Regular expressions are a compact and powerful approach for matching strings and are well supported in Lucene using RegexpQuery. However, such queries can be surprisingly costly, leading to a possible denial of service (ReDoS) vulnerability in search services built on Lucene.<br>This talk will first briefly introduce how Lucene executes RegexpQuery using a pre-determinized finite state automaton or DFA matching approach. This yields fast query execution, but Lucene must guard against the determinization pre-step taking too much work and reject the query, preventing such costly regular expressions from being used in Lucene at all. Next Iâ€™ll describe a recent Lucene bug that led to an adversarial ReDoS query impacting an OpenSearch user [1] and how we fixed and optimized it. Iâ€™ll present the ongoing development efforts to execute the RegexQuery directly using a non-deterministic finite state automaton (NFA) instead, guided by the method described in Russ Coxâ€™s paper [2]. Finally Iâ€™ll walk through the pros and cons of these two execution methods for Luceneâ€™s RegexpQuery so that future Lucene users can understand and reduce the risk and impact of ReDoS attacks in their search applications.<br>[1]Â <a href=https://github.com/opensearch-project/OpenSearch/issues/687>https://github.com/opensearch-project/OpenSearch/issues/687</a><br>[2]Â <a href=https://swtch.com/~rsc/regexp/regexp1.html>https://swtch.com/~rsc/regexp/regexp1.html</a>Â (<a href=https://communityovercode.org/wp-content/uploads/2023/10/sat_search_patrickzhai-patrick-zhai.pdf>Slides</a>)</p></blockquote><p>Lucene ã§ã®æ­£è¦è¡¨ç¾æ¤œç´¢ã®æ”¹å–„ã¨ NFA ã‚’ä½¿ã£ãŸ æ­£è¦è¡¨ç¾ã‚¯ã‚¨ãƒªã®å®Ÿè£…ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç´¹ä»‹</p></content>---<p>é–¢é€£ã—ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„è¨˜äº‹</p><ul><li><a href=/posts/2023-04-17-2252/>Twitter ã®æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ ã‚’å­¦ã¶ - æ¦‚è¦ç·¨</a></li><li><a href=/posts/2023-03-26-2208/>ç¾åœ¨ Lucene ã® KNN ãƒ™ã‚¯ãƒˆãƒ«ã®æœ€å¤§æ¬¡å…ƒæ•°ã¯1024æ¬¡å…ƒ ã ãŒã€ãã‚Œã‚’2048æ¬¡å…ƒã«å¤‰æ›´ã§ããªã„ã‹ã¨ã„ã†è­°è«–</a></li><li><a href=/posts/2023-03-11-1727/>åˆå¿ƒè€…ã ã‘ã© Apache Lucene ã«è²¢çŒ®ã—ãŸã„å ´åˆã«ãŠã™ã™ã‚ã®ãƒã‚±ãƒƒãƒˆãƒ©ãƒ™ãƒ«</a></li><li><a href=/posts/2021-11-26/>AmazonãŒeã‚³ãƒãƒ¼ã‚¹æ¤œç´¢ã‚’ Lucene ã«ã‚ˆã‚Šã€ã©ã†ã‚¹ã‚±ãƒ¼ãƒ«ã•ã›ã¦ã„ã‚‹ã‹ at Berlin Buzzwords 2019</a></li><li><a href=/posts/2024-02-22-0032/>é‹ç”¨ã‚³ã‚¹ãƒˆã‚’ä½ãæŠ‘ãˆã¤ã¤å…¨æ–‡æ¤œç´¢æ©Ÿèƒ½ã‚’å®Ÿç¾ã—ãŸã„: SQLite3 ã§å…¨æ–‡æ¤œç´¢ã‚’å®Ÿç¾ã™ã‚‹ fts5 ã€ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã‚’å®Ÿç¾ã™ã‚‹ sqlite-vss</a></li></ul><br>ğŸ“® ğŸ“§ ğŸ: è¨˜äº‹ã¸ã®<a href="https://docs.google.com/forms/d/e/1FAIpQLScgZVDrjQiKLbQRovfs88oweCITzjtvt1PlgwL14JfWPOrpPQ/viewform?usp=pp_url&entry.838298670=https%3a%2f%2fshunyaueta.com%2fposts%2f2024-03-05-2323%2f">æ„Ÿæƒ³</a>ã®ãŠãŸã‚ˆã‚Šã‚’ãŠã¾ã¡ã—ã¦ã¾ã™ã€‚
ãŠæ°—è»½ã«ãŠé€ã‚Šãã ã•ã„ã€‚
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ãŒã‚ã‚Œã°ãƒ¡ãƒ¼ãƒ«ã§è¿”ä¿¡ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚
ã‚‚ã¡ã‚ã‚“ãŠè¿”äº‹ã‚’å¸Œæœ›ã›ãšã«å˜ãªã‚‹æ„Ÿæƒ³ã ã‘ã§ã‚‚å¤§æ­“è¿ã§ã™ã€‚<br><br>ã“ã®ã‚µã‚¤ãƒˆã®æ›´æ–°æƒ…å ±ã‚’<a href=/index.xml>RSS</a>ã§é…ä¿¡ã—ã¦ã„ã¾ã™ã€‚
ãŠå¥½ããªãƒ•ã‚£ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼ã§è³¼èª­ã—ã¦ã¿ã¦ãã ã•ã„ã€‚<br><br>ã“ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®é‹å–¶ã‚„è‘—è€…ã®æ´»å‹•ã‚’æ”¯æ´ã—ã¦ã„ãŸã ã‘ã‚‹æ–¹ã‚’å‹Ÿé›†ã—ã¦ã„ã¾ã™ã€‚
ã‚‚ã—ã‚ˆã‚ã—ã‘ã‚Œã°ã€<a href=https://www.buymeacoffee.com/hurutoriya>Buy Me a Coffee</a> ã‹ã‚‰ã‚µãƒãƒ¼ãƒˆ(æŠ•ã’éŠ­)ã—ã¦ã„ãŸã ã‘ã‚‹ã¨ã€è‘—è€…ã®æ´»å‹•ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã«ç¹‹ãŒã‚Šã¾ã™âœ¨<br>Amazonã§<a href=https://www.amazon.jp/hz/wishlist/ls/1Z8LPJGBMH1QK>ã»ã—ã„ã‚‚ã®ãƒªã‚¹ãƒˆ</a>ã‚‚å…¬é–‹ã—ã¦ã„ã‚‹ã®ã§ã€ã“ã¡ã‚‰ã‹ã‚‰ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãŸã ã‘ã‚‹ã¨åŠ±ã¿ã«ãªã‚Šã¾ã™ã€‚<br><p><a href=https://shunyaueta.com/tags/lucene/>#lucene</a>
<a href=https://shunyaueta.com/tags/search/>#search</a></p></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo Ê•â€¢á´¥â€¢Ê” Bear</a></footer></body></html>