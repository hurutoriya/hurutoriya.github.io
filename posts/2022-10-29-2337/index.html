<!doctype html><html lang=ja><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Elasticsearch 8.4 から利用可能な従来の検索機能と近似近傍探索を組み合わせたハイブリッド検索を試す | Shunya Ueta</title>
<meta name=title content="Elasticsearch 8.4 から利用可能な従来の検索機能と近似近傍探索を組み合わせたハイブリッド検索を試す"><meta name=description content="表題の通り、Elasticsearch 8.4 から待望の近似近傍探索と従来の検索を組み合わたハイブリッド検索が可能になったらしいので、試してみました。
Elascticsearch 8 で導入された近似近傍探索について Elasticsearch 公式の記事1がわかりやすく近似近傍探索について語られています。 また、日本語では@pakio さんの紹介記事2も非常にわかりやすいので、そちらも御覧ください。
嬉しいけど物足りない点 公式の資料3や@pakio さんの資料でも触れられていますが、
You can’t currently use the Query DSL to filter documents for an approximate kNN search. If you need to filter the documents, consider using exact kNN instead. Elasticsearch の Query DSL との併用不可というのが物足りない点でした。
端的に説明すると Elasticsearch 8 で利用可能になった近似近傍探索は、あくまでベクトル間のみの近似近傍探索のみできるのであって、従来の Elasticsearch の検索機能(term や filter)と近似近傍探索を組み合わせて検索できないということです。
Vespa の開発者の Jo さんも同様の点4について触れていました。
The most surprising part of the announcement is that they won&rsquo;t allow combining the nearest neighbor search with standard query terms and filters."><meta name=keywords content="elasticsearch,search,"><meta property="og:title" content="Elasticsearch 8.4 から利用可能な従来の検索機能と近似近傍探索を組み合わせたハイブリッド検索を試す"><meta property="og:description" content="表題の通り、Elasticsearch 8.4 から待望の近似近傍探索と従来の検索を組み合わたハイブリッド検索が可能になったらしいので、試してみました。
Elascticsearch 8 で導入された近似近傍探索について Elasticsearch 公式の記事1がわかりやすく近似近傍探索について語られています。 また、日本語では@pakio さんの紹介記事2も非常にわかりやすいので、そちらも御覧ください。
嬉しいけど物足りない点 公式の資料3や@pakio さんの資料でも触れられていますが、
You can’t currently use the Query DSL to filter documents for an approximate kNN search. If you need to filter the documents, consider using exact kNN instead. Elasticsearch の Query DSL との併用不可というのが物足りない点でした。
端的に説明すると Elasticsearch 8 で利用可能になった近似近傍探索は、あくまでベクトル間のみの近似近傍探索のみできるのであって、従来の Elasticsearch の検索機能(term や filter)と近似近傍探索を組み合わせて検索できないということです。
Vespa の開発者の Jo さんも同様の点4について触れていました。
The most surprising part of the announcement is that they won&rsquo;t allow combining the nearest neighbor search with standard query terms and filters."><meta property="og:type" content="article"><meta property="og:url" content="https://shunyaueta.com/posts/2022-10-29-2337/"><meta property="og:image" content="https://shunyaueta.com/ogp.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-29T23:37:35+09:00"><meta property="article:modified_time" content="2022-10-29T23:37:35+09:00"><meta property="og:site_name" content="Shunya Ueta"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://shunyaueta.com/ogp.jpg"><meta name=twitter:title content="Elasticsearch 8.4 から利用可能な従来の検索機能と近似近傍探索を組み合わせたハイブリッド検索を試す"><meta name=twitter:description content="表題の通り、Elasticsearch 8.4 から待望の近似近傍探索と従来の検索を組み合わたハイブリッド検索が可能になったらしいので、試してみました。
Elascticsearch 8 で導入された近似近傍探索について Elasticsearch 公式の記事1がわかりやすく近似近傍探索について語られています。 また、日本語では@pakio さんの紹介記事2も非常にわかりやすいので、そちらも御覧ください。
嬉しいけど物足りない点 公式の資料3や@pakio さんの資料でも触れられていますが、
You can’t currently use the Query DSL to filter documents for an approximate kNN search. If you need to filter the documents, consider using exact kNN instead. Elasticsearch の Query DSL との併用不可というのが物足りない点でした。
端的に説明すると Elasticsearch 8 で利用可能になった近似近傍探索は、あくまでベクトル間のみの近似近傍探索のみできるのであって、従来の Elasticsearch の検索機能(term や filter)と近似近傍探索を組み合わせて検索できないということです。
Vespa の開発者の Jo さんも同様の点4について触れていました。
The most surprising part of the announcement is that they won&rsquo;t allow combining the nearest neighbor search with standard query terms and filters."><meta itemprop=name content="Elasticsearch 8.4 から利用可能な従来の検索機能と近似近傍探索を組み合わせたハイブリッド検索を試す"><meta itemprop=description content="表題の通り、Elasticsearch 8.4 から待望の近似近傍探索と従来の検索を組み合わたハイブリッド検索が可能になったらしいので、試してみました。
Elascticsearch 8 で導入された近似近傍探索について Elasticsearch 公式の記事1がわかりやすく近似近傍探索について語られています。 また、日本語では@pakio さんの紹介記事2も非常にわかりやすいので、そちらも御覧ください。
嬉しいけど物足りない点 公式の資料3や@pakio さんの資料でも触れられていますが、
You can’t currently use the Query DSL to filter documents for an approximate kNN search. If you need to filter the documents, consider using exact kNN instead. Elasticsearch の Query DSL との併用不可というのが物足りない点でした。
端的に説明すると Elasticsearch 8 で利用可能になった近似近傍探索は、あくまでベクトル間のみの近似近傍探索のみできるのであって、従来の Elasticsearch の検索機能(term や filter)と近似近傍探索を組み合わせて検索できないということです。
Vespa の開発者の Jo さんも同様の点4について触れていました。
The most surprising part of the announcement is that they won&rsquo;t allow combining the nearest neighbor search with standard query terms and filters."><meta itemprop=datePublished content="2022-10-29T23:37:35+09:00"><meta itemprop=dateModified content="2022-10-29T23:37:35+09:00"><meta itemprop=wordCount content="1015"><meta itemprop=image content="https://shunyaueta.com/ogp.jpg"><meta itemprop=keywords content="elasticsearch,search,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px;overflow-x:auto}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-JMJRQJT0Q3"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JMJRQJT0Q3")</script></head><body><header><a href=/ class=title><h2>Shunya Ueta</h2></a><nav><a href=/about/>著者について</a>
<a href=/index.xml>RSS</a></nav></header><main><h1>Elasticsearch 8.4 から利用可能な従来の検索機能と近似近傍探索を組み合わせたハイブリッド検索を試す</h1><p><i><time datetime=2022-10-29 pubdate>2022-10-29</time></i></p><content><p>表題の通り、Elasticsearch 8.4 から待望の近似近傍探索と従来の検索を組み合わたハイブリッド検索が可能になったらしいので、試してみました。</p><h2 id=elascticsearch-8-で導入された近似近傍探索について>Elascticsearch 8 で導入された近似近傍探索について</h2><p>Elasticsearch 公式の記事<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>がわかりやすく近似近傍探索について語られています。
また、日本語では@pakio さんの紹介記事<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>も非常にわかりやすいので、そちらも御覧ください。</p><h3 id=嬉しいけど物足りない点>嬉しいけど物足りない点</h3><p>公式の資料<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>や@pakio さんの資料でも触れられていますが、</p><blockquote><ul><li>You can’t currently use the Query DSL to filter documents for an approximate kNN search. If you need to filter the documents, consider using exact kNN instead.</li></ul></blockquote><p>Elasticsearch の Query DSL との併用不可というのが物足りない点でした。</p><p>端的に説明すると Elasticsearch 8 で利用可能になった近似近傍探索は、あくまでベクトル間のみの近似近傍探索のみできるのであって、従来の Elasticsearch の検索機能(term や filter)と近似近傍探索を組み合わせて検索できないということです。</p><p>Vespa の開発者の Jo さんも同様の点<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>について触れていました。</p><blockquote><p>The most surprising part of the announcement is that they won&rsquo;t allow combining the nearest neighbor search with standard query terms and filters. I think that will be disappointing for many who have been waiting for this feature. That concludes this thread, thoughts 👇🧵 5/5</p></blockquote><p>なぜならベクトルだけの素朴な近似近傍探索なら、正直ベクトル検索エンジンの<a href=https://qdrant.tech/>Qdrant</a>、<a href=https://milvus.io/>Milvus</a> 、<a href=https://github.com/vdaas/vald>Vald</a>でも事足ります。
検索エンジンの Elasticsearch に求められるのは、従来のフィルタリング機能と近似近傍探索を組み合わせたり、term による検索と近似近傍探索を組み合わせなど素朴な近似近傍探索では実現できない点を補える事ができれば近似近傍探索の実用可能性がグンと広がるので、ちょっと物足りないねというのが正直な感想でした。</p><p>それを実現するための関連するチケット<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>などはあったのでいつか実現してほしいなと思っていましたが、Linkedin の投稿で Elasticsearch のエンジニアの方が遂に実現できたよ!!と紹介しており<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup> 、早速試してみたいと思います。</p><p>2022/10/30 追記: <a href=https://www.elastic.co/guide/en/elasticsearch/reference/8.2/release-notes-8.2.0.html>Elasticsearch version 8.2.0 | Elasticsearch Guide [8.2] | Elastic</a> のリリースで</p><blockquote><p>Integrate filtering support for ANN #84734 (issue: #81788)</p></blockquote><p>と書かれており、ANN でのフィルタリングサポートは Elasticsearch 8.2 からサポートされていたみたいです。
なので正確には Elasticsearch 8.4 からは検索クエリが使えるようになったということですね。</p><h2 id=ハイブリッド検索>ハイブリッド検索</h2><p>Elasticsearch の公式ドキュメントはこちら<sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup></p><p>このドキュメントを基に、</p><ul><li>従来の検索機能</li><li>近似近傍探索のみによる検索結果</li><li>上記ふたつを組み合わせた検索結果</li></ul><p>を一画面で表示できる Web アプリを作ったので結果を比較してみたいと思います。</p><p>データやインデキシング自体は前回作成した、<a href=/posts/2022-10-23-2344/>Elasticsearch の近似近傍探索を使って、ドラえもんのひみつ道具検索エンジンを作ってみた</a>を基に今回もコードは全て公開しています。release tag は<code>v0.2</code> にしています。</p><p><a href=https://github.com/hurutoriya/doraemon-himitsu-dogu-search/releases/tag/v0.2.0>https://github.com/hurutoriya/doraemon-himitsu-dogu-search/releases/tag/v0.2.0</a></p><p>前回からの変更点を主に書いていきます。</p><h3 id=日本語検索の設定>日本語検索の設定</h3><p>Docker ファイルで日本語用の analyzer である<code>kuromoji</code>を追加し</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> docker.elastic.co/elasticsearch/elasticsearch:8.4.3</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># set the specific password for Elasticsearch</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> echo <span style=color:#e6db74>&#34;elastic&#34;</span> | bin/elasticsearch-keystore add <span style=color:#e6db74>&#34;bootstrap.password&#34;</span> -xf<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> bin/elasticsearch-plugin install analysis-kuromoji<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> bin/elasticsearch-plugin install analysis-icu<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Elasticsearch の mapping は zozo さんの記事<sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup>を参考にして以下のように書いてみました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;settings&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;analysis&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;analyzer&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;custome_ja_analyzer&#34;</span>: {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;custom&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;char_filter&#34;</span>: [<span style=color:#e6db74>&#34;icu_normalizer&#34;</span>],
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;tokenizer&#34;</span>: <span style=color:#e6db74>&#34;kuromoji_tokenizer&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;filter&#34;</span>: [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;kuromoji_baseform&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;kuromoji_part_of_speech&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;ja_stop&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;kuromoji_number&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;kuromoji_stemmer&#34;</span>
</span></span><span style=display:flex><span>          ]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;mappings&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;vector&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;dense_vector&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;dims&#34;</span>: <span style=color:#ae81ff>768</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;index&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;similarity&#34;</span>: <span style=color:#e6db74>&#34;l2_norm&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;text&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;analyzer&#34;</span>: <span style=color:#e6db74>&#34;custome_ja_analyzer&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;yomi&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;text&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;analyzer&#34;</span>: <span style=color:#e6db74>&#34;custome_ja_analyzer&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;description&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;text&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;analyzer&#34;</span>: <span style=color:#e6db74>&#34;custome_ja_analyzer&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>kuromoji のおかげで前処理を行わなくても、日本語で解析ができるようになります。</p><p>実際に起動してインデックスを構築した、Elasticsearch が動く Docker にリクエストを投げてみると、analyzer によって処理がされます。
検索時にはこれらの tokens が転置インデックス上で検索されます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl --cacert http_ca.crt -u elastic:elastic -X POST <span style=color:#e6db74>&#34;https://localhost:9200/himitsu_dogu/_analyze?pretty&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;{&#34;analyzer&#34;: &#34;custome_ja_analyzer&#34;,&#34;text&#34;:&#34;ドラえもんのひみつ道具はどこでもドア以外にもたくさん存在する&#34;}&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;tokens&#34;</span> : <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;token&#34;</span> : <span style=color:#e6db74>&#34;ドラえもん&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;start_offset&#34;</span> : 0,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;end_offset&#34;</span> : 5,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;type&#34;</span> : <span style=color:#e6db74>&#34;word&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;position&#34;</span> : <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;token&#34;</span> : <span style=color:#e6db74>&#34;ひむ&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;start_offset&#34;</span> : 6,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;end_offset&#34;</span> : 8,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;type&#34;</span> : <span style=color:#e6db74>&#34;word&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;position&#34;</span> : <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;token&#34;</span> : <span style=color:#e6db74>&#34;道具&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;start_offset&#34;</span> : 9,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;end_offset&#34;</span> : 11,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;type&#34;</span> : <span style=color:#e6db74>&#34;word&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;position&#34;</span> : <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;token&#34;</span> : <span style=color:#e6db74>&#34;どこ&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;start_offset&#34;</span> : 12,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;end_offset&#34;</span> : 14,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;type&#34;</span> : <span style=color:#e6db74>&#34;word&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;position&#34;</span> : <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;token&#34;</span> : <span style=color:#e6db74>&#34;ドア&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;start_offset&#34;</span> : 16,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;end_offset&#34;</span> : 18,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;type&#34;</span> : <span style=color:#e6db74>&#34;word&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;position&#34;</span> : <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;token&#34;</span> : <span style=color:#e6db74>&#34;以外&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;start_offset&#34;</span> : 18,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;end_offset&#34;</span> : 20,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;type&#34;</span> : <span style=color:#e6db74>&#34;word&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;position&#34;</span> : <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;token&#34;</span> : <span style=color:#e6db74>&#34;たくさん&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;start_offset&#34;</span> : 22,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;end_offset&#34;</span> : 26,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;type&#34;</span> : <span style=color:#e6db74>&#34;word&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;position&#34;</span> : <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;token&#34;</span> : <span style=color:#e6db74>&#34;存在&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;start_offset&#34;</span> : 26,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;end_offset&#34;</span> : 28,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;type&#34;</span> : <span style=color:#e6db74>&#34;word&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;position&#34;</span> : <span style=color:#ae81ff>13</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>実際に簡単な multi match query(複数フィールドでの一致検索)の結果はこちら</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl --cacert http_ca.crt -u elastic:elastic -X POST <span style=color:#e6db74>&#34;https://localhost:9200/himitsu_dogu/_search?pretty&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;{&#34;size&#34;: 1, &#34;query&#34;: {&#34;multi_match&#34; : {&#34;query&#34;:&#34;どこでもドア&#34;, &#34;fields&#34;: [ &#34;name&#34;, &#34;description&#34; ] }}}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;took&#34;</span> : 2,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;timed_out&#34;</span> : false,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;_shards&#34;</span> : <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;total&#34;</span> : 1,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;successful&#34;</span> : 1,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;skipped&#34;</span> : 0,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;failed&#34;</span> : <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;hits&#34;</span> : <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;total&#34;</span> : <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;value&#34;</span> : 44,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;relation&#34;</span> : <span style=color:#e6db74>&#34;eq&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;max_score&#34;</span> : 11.774845,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;hits&#34;</span> : <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;_index&#34;</span> : <span style=color:#e6db74>&#34;himitsu_dogu&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;_id&#34;</span> : <span style=color:#e6db74>&#34;816&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;_score&#34;</span> : 11.774845,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;_source&#34;</span> : <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;id&#34;</span> : 816,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;name&#34;</span> : <span style=color:#e6db74>&#34;どこでもドア&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;yomi&#34;</span> : <span style=color:#e6db74>&#34;どこでもどあ&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;description&#34;</span> : <span style=color:#e6db74>&#34;このドアを開けるだけで、行きたいところへ、どこへでも行くことができる。&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;vector&#34;</span> : <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>            -0.23546676337718964,
</span></span><span style=display:flex><span>            ...
</span></span><span style=display:flex><span>            -0.37538981437683105
</span></span><span style=display:flex><span>          <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>これで、Elasticsearch で日本語検索が問題なく出来ていることが確認できたので、ハイブリッド検索についての説明に</p><h3 id=結果比較>結果比較</h3><h4 id=比較対象>比較対象</h4><p><code>multi match query</code>, <code>ANN</code>, <code>multi match</code> + <code>ANN</code> の三種類のクエリで検索結果を定性的に比較します。
Python 上ではクエリは以下のような形式で書いてみました。<code>TOP_K</code>は 10 で、<code>keyword</code>は入力クエリです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>multimatch_query: dict <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;size&#34;</span>: TOP_K,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;query&#34;</span>: {<span style=color:#e6db74>&#34;multi_match&#34;</span>: {<span style=color:#e6db74>&#34;query&#34;</span>: keyword, <span style=color:#e6db74>&#34;fields&#34;</span>: [<span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#e6db74>&#34;description&#34;</span>]}},
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>ann_query: dict <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;knn&#34;</span>: {
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;vector&#34;</span>,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;query_vector&#34;</span>: sentence_embeddings[<span style=color:#ae81ff>0</span>],
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;k&#34;</span>: TOP_K,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;num_candidates&#34;</span>: <span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e># NOTE: score = match score + ANN score</span>
</span></span><span style=display:flex><span>hybrid_query: dict <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;size&#34;</span>: TOP_K,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;query&#34;</span>: {<span style=color:#e6db74>&#34;multi_match&#34;</span>: {<span style=color:#e6db74>&#34;query&#34;</span>:keyword, <span style=color:#e6db74>&#34;fields&#34;</span>: [<span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#e6db74>&#34;description&#34;</span>]}},
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;knn&#34;</span>: {
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;field&#34;</span>: <span style=color:#e6db74>&#34;vector&#34;</span>,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;query_vector&#34;</span>: sentence_embeddings[<span style=color:#ae81ff>0</span>],
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;k&#34;</span>: TOP_K,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;num_candidates&#34;</span>: <span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>multimatch_query</code>: ひみつ道具の名前と説明文の複数フィールドでマッチするドキュメントを検索する</li><li><code>ann_query</code>: ひみつ道具の名前と説明文を空白区切りで結合された文章を<code>JapaneseSententsBERT</code> でベクトル化し、近似近傍探索を行う</li><li><code>hybrid_query</code>: 上記２つのクエリのスコアを足し合わせた結果(<code>match score</code> + <code>ANN score</code>)を検索結果として返す。<ul><li>公式ドキュメントでは、<code>boost</code>を使うことで係数を書けて調整する方法も紹介されています。</li></ul></li></ul><p>実際にデモアプリの Streamlit 上では、上記３つのクエリの検索結果が side by side で比較できるようにしてみました。
これで、各検索手法で結果がどう異なっているか一目瞭然ですね。</p><p><img src=/posts/2022-10-29-2337/images/1.png alt="streamlit side by side result"></p><p>Streamlit で得られた結果を表として以下にまとめました。</p><h4 id=クエリ-ai>クエリ: <code>AI</code></h4><table><thead><tr><th><code>multi mach</code></th><th>スコア</th><th>ひみつ道具の名前</th><th>説明</th><th><code>ANN</code></th><th>スコア</th><th>ひみつ道具の名前</th><th>説明</th><th><code>hybrid(match score + ANN score</code></th><th>スコア</th><th>ひみつ道具の名前</th><th>説明</th></tr></thead><tbody><tr><td>1</td><td>5.3606</td><td>エーアイアイ</td><td>高性能（せいのう）の AI（エーアイ／人工知能）が搭載（とうさい）されているサル型ロボット。一から教えてあげると、なんでも自分で考えて行動する。</td><td>1</td><td>0.0027</td><td>なんでもデリバリーバックパック</td><td>デリバリー（配達）用のひみつ道具。中は四次元になっているため、いくらでも配達品を入れることができ、ゆれてもこわれることなく運べる。大きなポケットには、目的地まで自動運転してくれ、ひとこぎで１０メートル進む自転車が入っている。運転しながら食べたり飲んだりできる装置（そうち）も付いており、雨がふれば自動でカサもさしてくれる。</td><td>1</td><td>5.3606</td><td>エーアイアイ</td><td>高性能（せいのう）の AI（エーアイ／人工知能）が搭載（とうさい）されているサル型ロボット。一から教えてあげると、なんでも自分で考えて行動する。</td></tr><tr><td></td><td></td><td></td><td></td><td>2</td><td>0.0027</td><td>なりきりケイドロセット</td><td>本格的なおにごっこが楽しめる未来の遊び道具。通信もできる警察（けいさつ）手帳型のバッジや『強力におい追跡鼻（ついせきばな）』、身につけると体力が三割増しになる『泥棒風呂敷（どろぼうふろしき）』、『牢屋（ろうや）シール』などが入っている。</td><td>2</td><td>0.0027</td><td>なんでもデリバリーバックパック</td><td>デリバリー（配達）用のひみつ道具。中は四次元になっているため、いくらでも配達品を入れることができ、ゆれてもこわれることなく運べる。大きなポケットには、目的地まで自動運転してくれ、ひとこぎで１０メートル進む自転車が入っている。運転しながら食べたり飲んだりできる装置（そうち）も付いており、雨がふれば自動でカサもさしてくれる。</td></tr><tr><td></td><td></td><td></td><td></td><td>3</td><td>0.0026</td><td>地下工事マシン</td><td>この機械に設計図を描いた設計紙を入れ、コンクリートボンベを乗せてバルブを開くと、その設計図通りの空間を地下に作ってくれる。</td><td>3</td><td>0.0027</td><td>なりきりケイドロセット</td><td>本格的なおにごっこが楽しめる未来の遊び道具。通信もできる警察（けいさつ）手帳型のバッジや『強力におい追跡鼻（ついせきばな）』、身につけると体力が三割増しになる『泥棒風呂敷（どろぼうふろしき）』、『牢屋（ろうや）シール』などが入っている。</td></tr><tr><td></td><td></td><td></td><td></td><td>4</td><td>0.0026</td><td>ミチサキステッキ</td><td>どちらの道を進めばいいか迷ったときに使う道具。正しい道の方向に倒れて、道を教えてくれる。</td><td>4</td><td>0.0026</td><td>地下工事マシン</td><td>この機械に設計図を描いた設計紙を入れ、コンクリートボンベを乗せてバルブを開くと、その設計図通りの空間を地下に作ってくれる。</td></tr><tr><td></td><td></td><td></td><td></td><td>5</td><td>0.0026</td><td>ウラオモテックス</td><td>これを体に貼ると、裏でコソコソやっていたことや心の中で思っていることを、みんなの前で大っぴらにやってしまう。</td><td>5</td><td>0.0026</td><td>ミチサキステッキ</td><td>どちらの道を進めばいいか迷ったときに使う道具。正しい道の方向に倒れて、道を教えてくれる。</td></tr><tr><td></td><td></td><td></td><td></td><td>6</td><td>0.0026</td><td>かべ景色きりかえ機</td><td>かべを通して、どこの景色でも見ることができる。実際（じっさい）にうつし出した場所とつながるので、かべから出入りもできるようになる。</td><td>6</td><td>0.0026</td><td>ウラオモテックス</td><td>これを体に貼ると、裏でコソコソやっていたことや心の中で思っていることを、みんなの前で大っぴらにやってしまう。</td></tr><tr><td></td><td></td><td></td><td></td><td>7</td><td>0.0026</td><td>クロマキーセット</td><td>グリーンバックやブルーバックを背景（はいけい）にして、セットのカメラで撮影（さつえい）すると、映（うつ）したものを実際（じっさい）の景色にはめこむことができる。</td><td>7</td><td>0.0026</td><td>かべ景色きりかえ機</td><td>かべを通して、どこの景色でも見ることができる。実際（じっさい）にうつし出した場所とつながるので、かべから出入りもできるようになる。</td></tr><tr><td></td><td></td><td></td><td></td><td>8</td><td>0.0026</td><td>断層ビジョン</td><td>地中や機械の内部、人間の体の中など、外から見えないところを画面に映し出し、調べることができる。映し出したところに付属の旗を立てると、実際のその場所にも旗が立ち、目印になる。</td><td>8</td><td>0.0026</td><td>クロマキーセット</td><td>グリーンバックやブルーバックを背景（はいけい）にして、セットのカメラで撮影（さつえい）すると、映（うつ）したものを実際（じっさい）の景色にはめこむことができる。</td></tr><tr><td></td><td></td><td></td><td></td><td>9</td><td>0.0026</td><td>ゆっくり反射ぞうきん</td><td>このぞうきんで鏡やガラスを拭くと過去が映る。拭けば拭くほど、映る時間が過去に戻っていく。</td><td>9</td><td>0.0026</td><td>断層ビジョン</td><td>地中や機械の内部、人間の体の中など、外から見えないところを画面に映し出し、調べることができる。映し出したところに付属の旗を立てると、実際のその場所にも旗が立ち、目印になる。</td></tr><tr><td></td><td></td><td></td><td></td><td>10</td><td>0.0026</td><td>とうしめがね</td><td>ムシめがねのようだが、これをつかってモノを見ると、中のようすがすけて見える。</td><td>10</td><td>0.0026</td><td>ゆっくり反射ぞうきん</td><td>このぞうきんで鏡やガラスを拭くと過去が映る。拭けば拭くほど、映る時間が過去に戻っていく。</td></tr></tbody></table><p><code>ANN</code>では検索対象になっていなかった秘密道具である「エーアイアイ」を<code>multi match</code>クエリでは検索できており、ハイブリッド検索によって<code>multi match</code>と<code>ANN</code>がお互いを補うあうことで、主観的な評価ですが、検索結果になっていることが分かります。</p><h4 id=クエリ-ガリバー>クエリ: <code>ガリバー</code></h4><table><thead><tr><th><code>multi match</code></th><th>スコア</th><th>ひみつ道具の名前</th><th>説明</th><th><code>ANN</code></th><th>スコア</th><th>ひみつ道具の名前</th><th>説明</th><th><code>hybrid(match score + ANN score</code></th><th>スコア</th><th>ひみつ道具の名前</th><th>説明</th></tr></thead><tbody><tr><td>1</td><td>6.9183</td><td>ガリバートンネル</td><td>大きな入り口から入って、小さな出口から出ると、からだが小さくなるトンネル。逆にくぐりぬけると、もとに戻る。</td><td>1</td><td>0.0029</td><td>ガリバーロープ</td><td>巨大なものをかんたんにしばりつけることができるロープ。</td><td>1</td><td>6.9211</td><td>ガリバーロープ</td><td>巨大なものをかんたんにしばりつけることができるロープ。</td></tr><tr><td>2</td><td>6.9183</td><td>ガリバーロープ</td><td>巨大なものをかんたんにしばりつけることができるロープ。</td><td>2</td><td>0.0027</td><td>なりきりケイドロセット</td><td>本格的なおにごっこが楽しめる未来の遊び道具。通信もできる警察（けいさつ）手帳型のバッジや『強力におい追跡鼻（ついせきばな）』、身につけると体力が三割増しになる『泥棒風呂敷（どろぼうふろしき）』、『牢屋（ろうや）シール』などが入っている。</td><td>2</td><td>6.9183</td><td>ガリバートンネル</td><td>大きな入り口から入って、小さな出口から出ると、からだが小さくなるトンネル。逆にくぐりぬけると、もとに戻る。</td></tr><tr><td>3</td><td>5.8304</td><td>箱庭シリーズ 湖</td><td>大自然のミニチュアシリーズのひとつ。スモールライトやガリバートンネルで小さくなれば、この中で遊ぶことができる。</td><td>3</td><td>0.0027</td><td>スーパーダンごっこふろしき</td><td>未来の子どもたちがスーパーヒーローごっこで使うオモチャのふろしき。これを身につけると、低空ながら飛ぶことができ、空気銃の弾（たま）もはね返し、ものを透（す）かして見ることもできる。</td><td>3</td><td>5.8304</td><td>箱庭シリーズ 湖</td><td>大自然のミニチュアシリーズのひとつ。スモールライトやガリバートンネルで小さくなれば、この中で遊ぶことができる。</td></tr><tr><td>4</td><td>4.6887</td><td>ミニハウス</td><td>エネルギーのムダをはぶくために作られた、ミニハウス。乾電池一本でクーラーや冷蔵庫などの家電製品をすべて動かすことができる。ガリバートンネルで小さくなって使う。</td><td>4</td><td>0.0026</td><td>ゴキブリトレとれビッグ</td><td>ゴキブリをとる道具を、人間用に大きくしたもの。入ったら最後、ねんちゃくシートにつかまってしまう。</td><td>4</td><td>4.6887</td><td>ミニハウス</td><td>エネルギーのムダをはぶくために作られた、ミニハウス。乾電池一本でクーラーや冷蔵庫などの家電製品をすべて動かすことができる。ガリバートンネルで小さくなって使う。</td></tr><tr><td>5</td><td>4.5612</td><td>ムシムシ操縦ハンドル</td><td>このハンドルを自分が乗りたい虫に向けて、真ん中のボタンを押すと、その虫の背中にハンドルがくっつき、背中に乗って操縦することができる。ただし、ガリバートンネルなどで身体を小さくしてから使う。</td><td>5</td><td>0.0026</td><td>実景ひきよせ額縁</td><td>額縁の横にあるダイヤルを回すと、海でも雪山でもジャングルでも、実際にある景色をひきよせることができる。額縁のガラスを外してくぐれば、その景色の場所に行くこともできる。</td><td>5</td><td>4.5612</td><td>ムシムシ操縦ハンドル</td><td>このハンドルを自分が乗りたい虫に向けて、真ん中のボタンを押すと、その虫の背中にハンドルがくっつき、背中に乗って操縦することができる。ただし、ガリバートンネルなどで身体を小さくしてから使う。</td></tr><tr><td></td><td></td><td></td><td></td><td>6</td><td>0.0026</td><td>ぼんのうボウシ</td><td>これを頭にかぶると、その人の煩悩（ぼんのう）が雲のようなものに映像（えいぞう）となってうかび上がり、釣鐘（つりがね）のかたちにまとまる。それを撞木（しゅもく）型のハンマーでたたくと、それらの煩悩が追い払（はら）われる。</td><td>6</td><td>0.0027</td><td>なりきりケイドロセット</td><td>本格的なおにごっこが楽しめる未来の遊び道具。通信もできる警察（けいさつ）手帳型のバッジや『強力におい追跡鼻（ついせきばな）』、身につけると体力が三割増しになる『泥棒風呂敷（どろぼうふろしき）』、『牢屋（ろうや）シール』などが入っている。</td></tr><tr><td></td><td></td><td></td><td></td><td>7</td><td>0.0025</td><td>ねがい七夕ロケット</td><td>専用（せんよう）の短冊（たんざく）に願いごとを書いて笹（ささ）につけ、笹ごとロケットで宇宙（うちゅう）に飛ばすと、一年間その願いごとをかなえてくれる。短冊に書いたことと反対のことがかなう「うら七夕ロケット」もある。 【うら七夕ロケット】 専用（せんよう）の短冊（たんざく）に願いごとを書いて笹（ささ）につけ、笹ごとロケットで宇宙（うちゅう）に飛ばすと、一年間、短冊に書いたことと反対のことがかなう。</td><td>7</td><td>0.0027</td><td>スーパーダンごっこふろしき</td><td>未来の子どもたちがスーパーヒーローごっこで使うオモチャのふろしき。これを身につけると、低空ながら飛ぶことができ、空気銃の弾（たま）もはね返し、ものを透（す）かして見ることもできる。</td></tr><tr><td></td><td></td><td></td><td></td><td>8</td><td>0.0025</td><td>フエルミラー</td><td>増やしたいものをこのカガミにうつすと、本物になって出てくる。</td><td>8</td><td>0.0026</td><td>ゴキブリトレとれビッグ</td><td>ゴキブリをとる道具を、人間用に大きくしたもの。入ったら最後、ねんちゃくシートにつかまってしまう。</td></tr><tr><td></td><td></td><td></td><td></td><td>9</td><td>0.0025</td><td>ふわふわぐすり</td><td>これを口に入れると、体の中にガスができて、空気より軽くなるため、空を歩いたり、飛んだりすることができる。</td><td>9</td><td>0.0026</td><td>実景ひきよせ額縁</td><td>額縁の横にあるダイヤルを回すと、海でも雪山でもジャングルでも、実際にある景色をひきよせることができる。額縁のガラスを外してくぐれば、その景色の場所に行くこともできる。</td></tr><tr><td></td><td></td><td></td><td></td><td>10</td><td>0.0025</td><td>乗りものぐつ</td><td>これに両足を入れてボタンを押すと、車やジェット機、潜水艦（せんすいかん）など、いろいろな乗りものになる。</td><td>10</td><td>0.0026</td><td>ぼんのうボウシ</td><td>これを頭にかぶると、その人の煩悩（ぼんのう）が雲のようなものに映像（えいぞう）となってうかび上がり、釣鐘（つりがね）のかたちにまとまる。それを撞木（しゅもく）型のハンマーでたたくと、それらの煩悩が追い払（はら）われる。</td></tr></tbody></table><p><code>multi match</code>クエリでは、「ガリバー」とう単語が全てマッチし検索結果としては申し分ありません。
<code>ANN</code>は「ガリバー」というクエリによって、「ガリバーロープ」はヒットしていますが「ガリバートンネル」はなぜか出てきていません。
ハイブリッド検索によって、上位 5 個は<code>multi match</code>クエリによる適合率(precision)が高いひみつ道具がランク付けされ、その後 ANN の結果が混ざってきています。正直「ガリバー」という単語から想起するようなひみつ道具とはあまり感じませんが、特徴ベクトルの閾値などで上手く枝刈りさえしておけば、質は担保しつつ多様性のある結果が確保できそうです。</p><p>実際はこんなに単純な <code>multi match</code>計算ではなく、BM25 で計算されたスコアを導入したりなど工夫すべき点は多々ありますが、ハイブリッド検索の可能性を感じることができました。</p><p>特徴ベクトルのチューニングや、既存のクエリとの組み合わせるためのチューニングなどやることは増えそうですが、これは夢が広がりますね。
実際にはスコアを組み合わせたりするのもそうですが、ANN の結果にフィルタリングするほうが実務的には簡単に役立つことが多そうな気がしました。</p><p>たとえば、特定のカテゴリ内で ANN するだけでも、 「この商品に見た目が似ている商品はこちらです」を提示する際に画像としては似ているが商品としては全く違う商品(iPhone と iPhone ケースなど)を分けるのも簡単にできちゃいますしね。</p><h2 id=まとめ>まとめ</h2><p>このハイブリッド検索によって近似近傍探索のスコアと従来の検索結果のスコアをかけあわせたり、フィルタリングしたりなど真の意味で近似近傍探索が Elasticsearch で活用可能になったのではないのでしょうか？</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://www.elastic.co/jp/blog/introducing-approximate-nearest-neighbor-search-in-elasticsearch-8-0>Introducing approximate nearest neighbor search in Elasticsearch 8.0 | Elastic Blog</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://speakerdeck.com/pakio/how-knn-search-changed-in-the-elasticsearch-8-dot-0>8.0 からの kNN はどう変わったのか / How kNN search changed in the Elasticsearch 8.0 - Speaker Deck</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://www.elastic.co/guide/en/elasticsearch/reference/8.0/knn-search.html#approximate-knn-limitations>k-nearest neighbor (kNN) search | Elasticsearch Guide [8.0] | Elastic</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://twitter.com/jobergum/status/1491366596665016321>https://twitter.com/jobergum/status/1491366596665016321</a> Jo さんの皮肉な検索エンジン批評は自分の中で名物になっている&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><ul><li><a href=https://issues.apache.org/jira/browse/LUCENE-10318>[LUCENE-10318] Reuse HNSW graphs when merging segments? - ASF JIRA</a></li><li><a href=https://issues.apache.org/jira/browse/LUCENE-10382>[LUCENE-10382] Allow KnnVectorQuery to operate over a subset of liveDocs - ASF JIRA</a></li><li><a href=https://issues.apache.org/jira/browse/LUCENE-10592>[LUCENE-10592] Should we build HNSW graph on the fly during indexing - ASF JIRA</a></li></ul>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></li><li id=fn:6><p><a href=https://www.linkedin.com/posts/mayya-sharipova-a40a0256_k-nearest-neighbor-knn-search-edit-activity-6970855618479865857-oLqB/>Elasticsearch 8.4 introduces a hybrid search by Mayya Sharipova</a> Elasticsearch 8.4 introduces a hybrid search: ability to combine results from knn search with traditional search features (queries, aggs etc) and all this under a single familiar _search API.&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7><p><a href=https://www.elastic.co/guide/en/elasticsearch/reference/8.4/knn-search.html#_combine_approximate_knn_with_other_features>https://www.elastic.co/guide/en/elasticsearch/reference/8.4/knn-search.html#_combine_approximate_knn_with_other_features</a>&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:8><p><a href=https://techblog.zozo.com/entry/elasticsearch-mapping-config-for-japanese-search>Elasticsearch で日本語検索を扱うためのマッピング定義 ZOZO TECH BLOG</a>&#160;<a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></content>---<p>関連しているかもしれない記事</p><ul><li><a href=/posts/2022-10-23-2344/>Elasticsearchの近似近傍探索を使って、ドラえもんのひみつ道具検索エンジンを作ってみた</a></li><li><a href=/posts/2022-03-04/>デスクトップのGoogle 検索の検索フォームUIがかなり変化していた</a></li><li><a href=/posts/2022-03-03/>Amazon の製品検索で使われるロバストなキャッシュ手法の論文「ROSE: Robust Caches for Amazon Product Search」</a></li><li><a href=/posts/2022-03-01/>Web 検索とデータマイニングのトップカンファレンス WSDM2022 で気になった研究</a></li><li><a href=/posts/2022-01-16/>Search Engineering Newsletter vol.00</a></li></ul><br>📮 📧 🐏: 記事への<a href="https://docs.google.com/forms/d/e/1FAIpQLScgZVDrjQiKLbQRovfs88oweCITzjtvt1PlgwL14JfWPOrpPQ/viewform?usp=pp_url&entry.838298670=https%3a%2f%2fshunyaueta.com%2fposts%2f2022-10-29-2337%2f">感想</a>のおたよりをおまちしてます。
お気軽にお送りください。
メールアドレス入力があればメールで返信させていただきます。
もちろんお返事を希望せずに単なる感想だけでも大歓迎です。<br><br>このサイトの更新情報を<a href=/index.xml>RSS</a>で配信しています。
お好きなフィードリーダーで購読してみてください。<br><br>このウェブサイトの運営や著者の活動を支援していただける方を募集しています。
もしよろしければ、<a href=https://www.buymeacoffee.com/hurutoriya>Buy Me a Coffee</a> からサポート(投げ銭)していただけると、著者の活動のモチベーションに繋がります✨<br>Amazonで<a href=https://www.amazon.jp/hz/wishlist/ls/1Z8LPJGBMH1QK>ほしいものリスト</a>も公開しているので、こちらからもサポートしていただけると励みになります。<br><p><a href=https://shunyaueta.com/tags/elasticsearch/>#elasticsearch</a>
<a href=https://shunyaueta.com/tags/search/>#search</a></p></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>