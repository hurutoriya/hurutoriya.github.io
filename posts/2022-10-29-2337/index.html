<!doctype html><html lang=ja dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Elasticsearch 8.4 から利用可能な従来の検索機能と近似近傍探索を組み合わせたハイブリッド検索を試す | 🦅 hurutoriya</title><meta name=keywords content="Elasticsearch,search"><meta name=description content="表題の通り、Elasticsearch 8.4 から待望の近似近傍探索と従来の検索を組み合わたハイブリッド検索が可能になったらしいので、試してみました。
Elascticsearch 8 で導入された近似近傍探索について Elasticsearch 公式の記事1がわかりやすく近似近傍探索について語られています。 また、日本語では@pakio さんの紹介記事2も非常にわかりやすいので、そちらも御覧ください。
嬉しいけど物足りない点 公式の資料3や@pakio さんの資料でも触れられていますが、
  You can’t currently use the Query DSL to filter documents for an approximate kNN search. If you need to filter the documents, consider using exact kNN instead.   Elasticsearch の Query DSL との併用不可というのが物足りない点でした。
端的に説明すると Elasticsearch 8 で利用可能になった近似近傍探索は、あくまでベクトル間のみの近似近傍探索のみできるのであって、従来の Elasticsearch の検索機能(term や filter)と近似近傍探索を組み合わせて検索できないということです。
Vespa の開発者の Jo さんも同様の点4について触れていました。
 The most surprising part of the announcement is that they won&rsquo;t allow combining the nearest neighbor search with standard query terms and filters."><meta name=author content="Shunya Ueta"><link rel=canonical href=https://shunyaueta.com/posts/2022-10-29-2337/><link crossorigin=anonymous href=/assets/css/stylesheet.abc7c82c3d415a6df50430738d1cbcc4c76fea558bc5a0c830d3babf78167a35.css integrity="sha256-q8fILD1BWm31BDBzjRy8xMdv6lWLxaDIMNO6v3gWejU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad();></script><link rel=icon href=https://shunyaueta.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://shunyaueta.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://shunyaueta.com/favicon-32x32.png><link rel=apple-touch-icon href=https://shunyaueta.com/apple-touch-icon.png><link rel=mask-icon href=https://shunyaueta.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme: rgb(29, 30, 32);--entry: rgb(46, 46, 51);--primary: rgb(218, 218, 219);--secondary: rgb(155, 156, 157);--tertiary: rgb(65, 66, 68);--content: rgb(196, 196, 197);--hljs-bg: rgb(46, 46, 51);--code-bg: rgb(55, 56, 62);--border: rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-JMJRQJT0Q3"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-JMJRQJT0Q3');</script><meta property="og:title" content="Elasticsearch 8.4 から利用可能な従来の検索機能と近似近傍探索を組み合わせたハイブリッド検索を試す"><meta property="og:description" content="表題の通り、Elasticsearch 8.4 から待望の近似近傍探索と従来の検索を組み合わたハイブリッド検索が可能になったらしいので、試してみました。
Elascticsearch 8 で導入された近似近傍探索について Elasticsearch 公式の記事1がわかりやすく近似近傍探索について語られています。 また、日本語では@pakio さんの紹介記事2も非常にわかりやすいので、そちらも御覧ください。
嬉しいけど物足りない点 公式の資料3や@pakio さんの資料でも触れられていますが、
  You can’t currently use the Query DSL to filter documents for an approximate kNN search. If you need to filter the documents, consider using exact kNN instead.   Elasticsearch の Query DSL との併用不可というのが物足りない点でした。
端的に説明すると Elasticsearch 8 で利用可能になった近似近傍探索は、あくまでベクトル間のみの近似近傍探索のみできるのであって、従来の Elasticsearch の検索機能(term や filter)と近似近傍探索を組み合わせて検索できないということです。
Vespa の開発者の Jo さんも同様の点4について触れていました。
 The most surprising part of the announcement is that they won&rsquo;t allow combining the nearest neighbor search with standard query terms and filters."><meta property="og:type" content="article"><meta property="og:url" content="https://shunyaueta.com/posts/2022-10-29-2337/"><meta property="og:image" content="https://shunyaueta.com/posts/2022-10-29-2337/images/1.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-29T23:37:35+09:00"><meta property="article:modified_time" content="2022-11-21T10:35:16+09:00"><meta property="og:site_name" content="Shunya Ueta"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://shunyaueta.com/posts/2022-10-29-2337/images/1.png"><meta name=twitter:title content="Elasticsearch 8.4 から利用可能な従来の検索機能と近似近傍探索を組み合わせたハイブリッド検索を試す"><meta name=twitter:description content="表題の通り、Elasticsearch 8.4 から待望の近似近傍探索と従来の検索を組み合わたハイブリッド検索が可能になったらしいので、試してみました。
Elascticsearch 8 で導入された近似近傍探索について Elasticsearch 公式の記事1がわかりやすく近似近傍探索について語られています。 また、日本語では@pakio さんの紹介記事2も非常にわかりやすいので、そちらも御覧ください。
嬉しいけど物足りない点 公式の資料3や@pakio さんの資料でも触れられていますが、
  You can’t currently use the Query DSL to filter documents for an approximate kNN search. If you need to filter the documents, consider using exact kNN instead.   Elasticsearch の Query DSL との併用不可というのが物足りない点でした。
端的に説明すると Elasticsearch 8 で利用可能になった近似近傍探索は、あくまでベクトル間のみの近似近傍探索のみできるのであって、従来の Elasticsearch の検索機能(term や filter)と近似近傍探索を組み合わせて検索できないということです。
Vespa の開発者の Jo さんも同様の点4について触れていました。
 The most surprising part of the announcement is that they won&rsquo;t allow combining the nearest neighbor search with standard query terms and filters."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Elasticsearch 8.4 から利用可能な従来の検索機能と近似近傍探索を組み合わせたハイブリッド検索を試す","item":"https://shunyaueta.com/posts/2022-10-29-2337/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Elasticsearch 8.4 から利用可能な従来の検索機能と近似近傍探索を組み合わせたハイブリッド検索を試す","name":"Elasticsearch 8.4 から利用可能な従来の検索機能と近似近傍探索を組み合わせたハイブリッド検索を試す","description":"表題の通り、Elasticsearch 8.4 から待望の近似近傍探索と従来の検索を組み合わたハイブリッド検索が可能になったらしいので、試してみました。\nElascticsearch 8 で導入された近似近傍探索について Elasticsearch 公式の記事1がわかりやすく近似近傍探索について語られています。 また、日本語では@pakio さんの紹介記事2も非常にわかりやすいので、そちらも御覧ください。\n嬉しいけど物足りない点 公式の資料3や@pakio さんの資料でも触れられていますが、\n  You can’t currently use the Query DSL to filter documents for an approximate kNN search. If you need to filter the documents, consider using exact kNN instead.   Elasticsearch の Query DSL との併用不可というのが物足りない点でした。\n端的に説明すると Elasticsearch 8 で利用可能になった近似近傍探索は、あくまでベクトル間のみの近似近傍探索のみできるのであって、従来の Elasticsearch の検索機能(term や filter)と近似近傍探索を組み合わせて検索できないということです。\nVespa の開発者の Jo さんも同様の点4について触れていました。\n The most surprising part of the announcement is that they won\u0026rsquo;t allow combining the nearest neighbor search with standard query terms and filters.","keywords":["Elasticsearch","search"],"articleBody":"表題の通り、Elasticsearch 8.4 から待望の近似近傍探索と従来の検索を組み合わたハイブリッド検索が可能になったらしいので、試してみました。\nElascticsearch 8 で導入された近似近傍探索について Elasticsearch 公式の記事1がわかりやすく近似近傍探索について語られています。 また、日本語では@pakio さんの紹介記事2も非常にわかりやすいので、そちらも御覧ください。\n嬉しいけど物足りない点 公式の資料3や@pakio さんの資料でも触れられていますが、\n  You can’t currently use the Query DSL to filter documents for an approximate kNN search. If you need to filter the documents, consider using exact kNN instead.   Elasticsearch の Query DSL との併用不可というのが物足りない点でした。\n端的に説明すると Elasticsearch 8 で利用可能になった近似近傍探索は、あくまでベクトル間のみの近似近傍探索のみできるのであって、従来の Elasticsearch の検索機能(term や filter)と近似近傍探索を組み合わせて検索できないということです。\nVespa の開発者の Jo さんも同様の点4について触れていました。\n The most surprising part of the announcement is that they won’t allow combining the nearest neighbor search with standard query terms and filters. I think that will be disappointing for many who have been waiting for this feature. That concludes this thread, thoughts 👇🧵 5/5\n なぜならベクトルだけの素朴な近似近傍探索なら、正直ベクトル検索エンジンのQdrant、Milvus 、Valdでも事足ります。 検索エンジンの Elasticsearch に求められるのは、従来のフィルタリング機能と近似近傍探索を組み合わせたり、term による検索と近似近傍探索を組み合わせなど素朴な近似近傍探索では実現できない点を補える事ができれば近似近傍探索の実用可能性がグンと広がるので、ちょっと物足りないねというのが正直な感想でした。\nそれを実現するための関連するチケット5などはあったのでいつか実現してほしいなと思っていましたが、Linkedin の投稿で Elasticsearch のエンジニアの方が遂に実現できたよ!!と紹介しており6 、早速試してみたいと思います。\n2022/10/30 追記: Elasticsearch version 8.2.0 | Elasticsearch Guide [8.2] | Elastic のリリースで\n Integrate filtering support for ANN #84734 (issue: #81788)\n と書かれており、ANN でのフィルタリングサポートは Elasticsearch 8.2 からサポートされていたみたいです。 なので正確には Elasticsearch 8.4 からは検索クエリが使えるようになったということですね。\nハイブリッド検索 Elasticsearch の公式ドキュメントはこちら7\nこのドキュメントを基に、\n 従来の検索機能 近似近傍探索のみによる検索結果 上記ふたつを組み合わせた検索結果  を一画面で表示できる Web アプリを作ったので結果を比較してみたいと思います。\nデータやインデキシング自体は前回作成した、Elasticsearch の近似近傍探索を使って、ドラえもんのひみつ道具検索エンジンを作ってみたを基に今回もコードは全て公開しています。release tag はv0.2 にしています。\nhttps://github.com/hurutoriya/doraemon-himitsu-dogu-search/releases/tag/v0.2.0\n前回からの変更点を主に書いていきます。\n日本語検索の設定 Docker ファイルで日本語用の analyzer であるkuromojiを追加し\n1 2 3 4 5  FROMdocker.elastic.co/elasticsearch/elasticsearch:8.4.3# set the specific password for ElasticsearchRUN echo \"elastic\" | bin/elasticsearch-keystore add \"bootstrap.password\" -xfRUN bin/elasticsearch-plugin install analysis-kuromojiRUN bin/elasticsearch-plugin install analysis-icu  Elasticsearch の mapping は zozo さんの記事8を参考にして以下のように書いてみました。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42  { \"settings\": { \"analysis\": { \"analyzer\": { \"custome_ja_analyzer\": { \"type\": \"custom\", \"char_filter\": [\"icu_normalizer\"], \"tokenizer\": \"kuromoji_tokenizer\", \"filter\": [ \"kuromoji_baseform\", \"kuromoji_part_of_speech\", \"ja_stop\", \"kuromoji_number\", \"kuromoji_stemmer\" ] } } } }, \"mappings\": { \"properties\": { \"vector\": { \"type\": \"dense_vector\", \"dims\": 768, \"index\": true, \"similarity\": \"l2_norm\" }, \"name\": { \"type\": \"text\", \"analyzer\": \"custome_ja_analyzer\" }, \"yomi\": { \"type\": \"text\", \"analyzer\": \"custome_ja_analyzer\" }, \"description\": { \"type\": \"text\", \"analyzer\": \"custome_ja_analyzer\" } } } }   kuromoji のおかげで前処理を行わなくても、日本語で解析ができるようになります。\n実際に起動してインデックスを構築した、Elasticsearch が動く Docker にリクエストを投げてみると、analyzer によって処理がされます。 検索時にはこれらの tokens が転置インデックス上で検索されます。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61  curl --cacert http_ca.crt -u elastic:elastic -X POST \"https://localhost:9200/himitsu_dogu/_analyze?pretty\" -H 'Content-Type: application/json' -d'{\"analyzer\": \"custome_ja_analyzer\",\"text\":\"ドラえもんのひみつ道具はどこでもドア以外にもたくさん存在する\"}' { \"tokens\" : [ { \"token\" : \"ドラえもん\", \"start_offset\" : 0, \"end_offset\" : 5, \"type\" : \"word\", \"position\" : 0 }, { \"token\" : \"ひむ\", \"start_offset\" : 6, \"end_offset\" : 8, \"type\" : \"word\", \"position\" : 2 }, { \"token\" : \"道具\", \"start_offset\" : 9, \"end_offset\" : 11, \"type\" : \"word\", \"position\" : 4 }, { \"token\" : \"どこ\", \"start_offset\" : 12, \"end_offset\" : 14, \"type\" : \"word\", \"position\" : 6 }, { \"token\" : \"ドア\", \"start_offset\" : 16, \"end_offset\" : 18, \"type\" : \"word\", \"position\" : 8 }, { \"token\" : \"以外\", \"start_offset\" : 18, \"end_offset\" : 20, \"type\" : \"word\", \"position\" : 9 }, { \"token\" : \"たくさん\", \"start_offset\" : 22, \"end_offset\" : 26, \"type\" : \"word\", \"position\" : 12 }, { \"token\" : \"存在\", \"start_offset\" : 26, \"end_offset\" : 28, \"type\" : \"word\", \"position\" : 13 } ] }   実際に簡単な multi match query(複数フィールドでの一致検索)の結果はこちら\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  $ curl --cacert http_ca.crt -u elastic:elastic -X POST \"https://localhost:9200/himitsu_dogu/_search?pretty\" -H 'Content-Type: application/json' -d'{\"size\": 1, \"query\": {\"multi_match\" : {\"query\":\"どこでもドア\", \"fields\": [ \"name\", \"description\" ] }}}' { \"took\" : 2, \"timed_out\" : false, \"_shards\" : { \"total\" : 1, \"successful\" : 1, \"skipped\" : 0, \"failed\" : 0 }, \"hits\" : { \"total\" : { \"value\" : 44, \"relation\" : \"eq\" }, \"max_score\" : 11.774845, \"hits\" : [ { \"_index\" : \"himitsu_dogu\", \"_id\" : \"816\", \"_score\" : 11.774845, \"_source\" : { \"id\" : 816, \"name\" : \"どこでもドア\", \"yomi\" : \"どこでもどあ\", \"description\" : \"このドアを開けるだけで、行きたいところへ、どこへでも行くことができる。\", \"vector\" : [ -0.23546676337718964, ... -0.37538981437683105 ] } } ] } }   これで、Elasticsearch で日本語検索が問題なく出来ていることが確認できたので、ハイブリッド検索についての説明に\n結果比較 比較対象 multi match query, ANN, multi match + ANN の三種類のクエリで検索結果を定性的に比較します。 Python 上ではクエリは以下のような形式で書いてみました。TOP_Kは 10 で、keywordは入力クエリです。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  multimatch_query: dict = { \"size\": TOP_K, \"query\": {\"multi_match\": {\"query\": keyword, \"fields\": [\"name\", \"description\"]}}, } ann_query: dict = { \"knn\": { \"field\": \"vector\", \"query_vector\": sentence_embeddings[0], \"k\": TOP_K, \"num_candidates\": 100, } } # NOTE: score = match score + ANN score hybrid_query: dict = { \"size\": TOP_K, \"query\": {\"multi_match\": {\"query\":keyword, \"fields\": [\"name\", \"description\"]}}, \"knn\": { \"field\": \"vector\", \"query_vector\": sentence_embeddings[0], \"k\": TOP_K, \"num_candidates\": 100, }, }    multimatch_query: ひみつ道具の名前と説明文の複数フィールドでマッチするドキュメントを検索する ann_query: ひみつ道具の名前と説明文を空白区切りで結合された文章をJapaneseSententsBERT でベクトル化し、近似近傍探索を行う hybrid_query: 上記２つのクエリのスコアを足し合わせた結果(match score + ANN score)を検索結果として返す。  公式ドキュメントでは、boostを使うことで係数を書けて調整する方法も紹介されています。    実際にデモアプリの Streamlit 上では、上記３つのクエリの検索結果が side by side で比較できるようにしてみました。 これで、各検索手法で結果がどう異なっているか一目瞭然ですね。\nStreamlit で得られた結果を表として以下にまとめました。\nクエリ: AI    multi mach スコア ひみつ道具の名前 説明 ANN スコア ひみつ道具の名前 説明 hybrid(match score + ANN score スコア ひみつ道具の名前 説明     1 5.3606 エーアイアイ 高性能（せいのう）の AI（エーアイ／人工知能）が搭載（とうさい）されているサル型ロボット。一から教えてあげると、なんでも自分で考えて行動する。 1 0.0027 なんでもデリバリーバックパック デリバリー（配達）用のひみつ道具。中は四次元になっているため、いくらでも配達品を入れることができ、ゆれてもこわれることなく運べる。大きなポケットには、目的地まで自動運転してくれ、ひとこぎで１０メートル進む自転車が入っている。運転しながら食べたり飲んだりできる装置（そうち）も付いており、雨がふれば自動でカサもさしてくれる。 1 5.3606 エーアイアイ 高性能（せいのう）の AI（エーアイ／人工知能）が搭載（とうさい）されているサル型ロボット。一から教えてあげると、なんでも自分で考えて行動する。       2 0.0027 なりきりケイドロセット 本格的なおにごっこが楽しめる未来の遊び道具。通信もできる警察（けいさつ）手帳型のバッジや『強力におい追跡鼻（ついせきばな）』、身につけると体力が三割増しになる『泥棒風呂敷（どろぼうふろしき）』、『牢屋（ろうや）シール』などが入っている。 2 0.0027 なんでもデリバリーバックパック デリバリー（配達）用のひみつ道具。中は四次元になっているため、いくらでも配達品を入れることができ、ゆれてもこわれることなく運べる。大きなポケットには、目的地まで自動運転してくれ、ひとこぎで１０メートル進む自転車が入っている。運転しながら食べたり飲んだりできる装置（そうち）も付いており、雨がふれば自動でカサもさしてくれる。       3 0.0026 地下工事マシン この機械に設計図を描いた設計紙を入れ、コンクリートボンベを乗せてバルブを開くと、その設計図通りの空間を地下に作ってくれる。 3 0.0027 なりきりケイドロセット 本格的なおにごっこが楽しめる未来の遊び道具。通信もできる警察（けいさつ）手帳型のバッジや『強力におい追跡鼻（ついせきばな）』、身につけると体力が三割増しになる『泥棒風呂敷（どろぼうふろしき）』、『牢屋（ろうや）シール』などが入っている。       4 0.0026 ミチサキステッキ どちらの道を進めばいいか迷ったときに使う道具。正しい道の方向に倒れて、道を教えてくれる。 4 0.0026 地下工事マシン この機械に設計図を描いた設計紙を入れ、コンクリートボンベを乗せてバルブを開くと、その設計図通りの空間を地下に作ってくれる。       5 0.0026 ウラオモテックス これを体に貼ると、裏でコソコソやっていたことや心の中で思っていることを、みんなの前で大っぴらにやってしまう。 5 0.0026 ミチサキステッキ どちらの道を進めばいいか迷ったときに使う道具。正しい道の方向に倒れて、道を教えてくれる。       6 0.0026 かべ景色きりかえ機 かべを通して、どこの景色でも見ることができる。実際（じっさい）にうつし出した場所とつながるので、かべから出入りもできるようになる。 6 0.0026 ウラオモテックス これを体に貼ると、裏でコソコソやっていたことや心の中で思っていることを、みんなの前で大っぴらにやってしまう。       7 0.0026 クロマキーセット グリーンバックやブルーバックを背景（はいけい）にして、セットのカメラで撮影（さつえい）すると、映（うつ）したものを実際（じっさい）の景色にはめこむことができる。 7 0.0026 かべ景色きりかえ機 かべを通して、どこの景色でも見ることができる。実際（じっさい）にうつし出した場所とつながるので、かべから出入りもできるようになる。       8 0.0026 断層ビジョン 地中や機械の内部、人間の体の中など、外から見えないところを画面に映し出し、調べることができる。映し出したところに付属の旗を立てると、実際のその場所にも旗が立ち、目印になる。 8 0.0026 クロマキーセット グリーンバックやブルーバックを背景（はいけい）にして、セットのカメラで撮影（さつえい）すると、映（うつ）したものを実際（じっさい）の景色にはめこむことができる。       9 0.0026 ゆっくり反射ぞうきん このぞうきんで鏡やガラスを拭くと過去が映る。拭けば拭くほど、映る時間が過去に戻っていく。 9 0.0026 断層ビジョン 地中や機械の内部、人間の体の中など、外から見えないところを画面に映し出し、調べることができる。映し出したところに付属の旗を立てると、実際のその場所にも旗が立ち、目印になる。       10 0.0026 とうしめがね ムシめがねのようだが、これをつかってモノを見ると、中のようすがすけて見える。 10 0.0026 ゆっくり反射ぞうきん このぞうきんで鏡やガラスを拭くと過去が映る。拭けば拭くほど、映る時間が過去に戻っていく。    ANNでは検索対象になっていなかった秘密道具である「エーアイアイ」をmulti matchクエリでは検索できており、ハイブリッド検索によってmulti matchとANNがお互いを補うあうことで、主観的な評価ですが、検索結果になっていることが分かります。\nクエリ: ガリバー    multi match スコア ひみつ道具の名前 説明 ANN スコア ひみつ道具の名前 説明 hybrid(match score + ANN score スコア ひみつ道具の名前 説明     1 6.9183 ガリバートンネル 大きな入り口から入って、小さな出口から出ると、からだが小さくなるトンネル。逆にくぐりぬけると、もとに戻る。 1 0.0029 ガリバーロープ 巨大なものをかんたんにしばりつけることができるロープ。 1 6.9211 ガリバーロープ 巨大なものをかんたんにしばりつけることができるロープ。   2 6.9183 ガリバーロープ 巨大なものをかんたんにしばりつけることができるロープ。 2 0.0027 なりきりケイドロセット 本格的なおにごっこが楽しめる未来の遊び道具。通信もできる警察（けいさつ）手帳型のバッジや『強力におい追跡鼻（ついせきばな）』、身につけると体力が三割増しになる『泥棒風呂敷（どろぼうふろしき）』、『牢屋（ろうや）シール』などが入っている。 2 6.9183 ガリバートンネル 大きな入り口から入って、小さな出口から出ると、からだが小さくなるトンネル。逆にくぐりぬけると、もとに戻る。   3 5.8304 箱庭シリーズ 湖 大自然のミニチュアシリーズのひとつ。スモールライトやガリバートンネルで小さくなれば、この中で遊ぶことができる。 3 0.0027 スーパーダンごっこふろしき 未来の子どもたちがスーパーヒーローごっこで使うオモチャのふろしき。これを身につけると、低空ながら飛ぶことができ、空気銃の弾（たま）もはね返し、ものを透（す）かして見ることもできる。 3 5.8304 箱庭シリーズ 湖 大自然のミニチュアシリーズのひとつ。スモールライトやガリバートンネルで小さくなれば、この中で遊ぶことができる。   4 4.6887 ミニハウス エネルギーのムダをはぶくために作られた、ミニハウス。乾電池一本でクーラーや冷蔵庫などの家電製品をすべて動かすことができる。ガリバートンネルで小さくなって使う。 4 0.0026 ゴキブリトレとれビッグ ゴキブリをとる道具を、人間用に大きくしたもの。入ったら最後、ねんちゃくシートにつかまってしまう。 4 4.6887 ミニハウス エネルギーのムダをはぶくために作られた、ミニハウス。乾電池一本でクーラーや冷蔵庫などの家電製品をすべて動かすことができる。ガリバートンネルで小さくなって使う。   5 4.5612 ムシムシ操縦ハンドル このハンドルを自分が乗りたい虫に向けて、真ん中のボタンを押すと、その虫の背中にハンドルがくっつき、背中に乗って操縦することができる。ただし、ガリバートンネルなどで身体を小さくしてから使う。 5 0.0026 実景ひきよせ額縁 額縁の横にあるダイヤルを回すと、海でも雪山でもジャングルでも、実際にある景色をひきよせることができる。額縁のガラスを外してくぐれば、その景色の場所に行くこともできる。 5 4.5612 ムシムシ操縦ハンドル このハンドルを自分が乗りたい虫に向けて、真ん中のボタンを押すと、その虫の背中にハンドルがくっつき、背中に乗って操縦することができる。ただし、ガリバートンネルなどで身体を小さくしてから使う。       6 0.0026 ぼんのうボウシ これを頭にかぶると、その人の煩悩（ぼんのう）が雲のようなものに映像（えいぞう）となってうかび上がり、釣鐘（つりがね）のかたちにまとまる。それを撞木（しゅもく）型のハンマーでたたくと、それらの煩悩が追い払（はら）われる。 6 0.0027 なりきりケイドロセット 本格的なおにごっこが楽しめる未来の遊び道具。通信もできる警察（けいさつ）手帳型のバッジや『強力におい追跡鼻（ついせきばな）』、身につけると体力が三割増しになる『泥棒風呂敷（どろぼうふろしき）』、『牢屋（ろうや）シール』などが入っている。       7 0.0025 ねがい七夕ロケット 専用（せんよう）の短冊（たんざく）に願いごとを書いて笹（ささ）につけ、笹ごとロケットで宇宙（うちゅう）に飛ばすと、一年間その願いごとをかなえてくれる。短冊に書いたことと反対のことがかなう「うら七夕ロケット」もある。 【うら七夕ロケット】 専用（せんよう）の短冊（たんざく）に願いごとを書いて笹（ささ）につけ、笹ごとロケットで宇宙（うちゅう）に飛ばすと、一年間、短冊に書いたことと反対のことがかなう。 7 0.0027 スーパーダンごっこふろしき 未来の子どもたちがスーパーヒーローごっこで使うオモチャのふろしき。これを身につけると、低空ながら飛ぶことができ、空気銃の弾（たま）もはね返し、ものを透（す）かして見ることもできる。       8 0.0025 フエルミラー 増やしたいものをこのカガミにうつすと、本物になって出てくる。 8 0.0026 ゴキブリトレとれビッグ ゴキブリをとる道具を、人間用に大きくしたもの。入ったら最後、ねんちゃくシートにつかまってしまう。       9 0.0025 ふわふわぐすり これを口に入れると、体の中にガスができて、空気より軽くなるため、空を歩いたり、飛んだりすることができる。 9 0.0026 実景ひきよせ額縁 額縁の横にあるダイヤルを回すと、海でも雪山でもジャングルでも、実際にある景色をひきよせることができる。額縁のガラスを外してくぐれば、その景色の場所に行くこともできる。       10 0.0025 乗りものぐつ これに両足を入れてボタンを押すと、車やジェット機、潜水艦（せんすいかん）など、いろいろな乗りものになる。 10 0.0026 ぼんのうボウシ これを頭にかぶると、その人の煩悩（ぼんのう）が雲のようなものに映像（えいぞう）となってうかび上がり、釣鐘（つりがね）のかたちにまとまる。それを撞木（しゅもく）型のハンマーでたたくと、それらの煩悩が追い払（はら）われる。    multi matchクエリでは、「ガリバー」とう単語が全てマッチし検索結果としては申し分ありません。 ANNは「ガリバー」というクエリによって、「ガリバーロープ」はヒットしていますが「ガリバートンネル」はなぜか出てきていません。 ハイブリッド検索によって、上位 5 個はmulti matchクエリによる適合率(precision)が高いひみつ道具がランク付けされ、その後 ANN の結果が混ざってきています。正直「ガリバー」という単語から想起するようなひみつ道具とはあまり感じませんが、特徴ベクトルの閾値などで上手く枝刈りさえしておけば、質は担保しつつ多様性のある結果が確保できそうです。\n実際はこんなに単純な multi match計算ではなく、BM25 で計算されたスコアを導入したりなど工夫すべき点は多々ありますが、ハイブリッド検索の可能性を感じることができました。\n特徴ベクトルのチューニングや、既存のクエリとの組み合わせるためのチューニングなどやることは増えそうですが、これは夢が広がりますね。 実際にはスコアを組み合わせたりするのもそうですが、ANN の結果にフィルタリングするほうが実務的には簡単に役立つことが多そうな気がしました。\nたとえば、特定のカテゴリ内で ANN するだけでも、 「この商品に見た目が似ている商品はこちらです」を提示する際に画像としては似ているが商品としては全く違う商品(iPhone と iPhone ケースなど)を分けるのも簡単にできちゃいますしね。\nまとめ このハイブリッド検索によって近似近傍探索のスコアと従来の検索結果のスコアをかけあわせたり、フィルタリングしたりなど真の意味で近似近傍探索が Elasticsearch で活用可能になったのではないのでしょうか？\n  Introducing approximate nearest neighbor search in Elasticsearch 8.0 | Elastic Blog ↩︎\n 8.0 からの kNN はどう変わったのか / How kNN search changed in the Elasticsearch 8.0 - Speaker Deck ↩︎\n k-nearest neighbor (kNN) search | Elasticsearch Guide [8.0] | Elastic ↩︎\n https://twitter.com/jobergum/status/1491366596665016321 Jo さんの皮肉な検索エンジン批評は自分の中で名物になっている ↩︎\n  [LUCENE-10318] Reuse HNSW graphs when merging segments? - ASF JIRA [LUCENE-10382] Allow KnnVectorQuery to operate over a subset of liveDocs - ASF JIRA [LUCENE-10592] Should we build HNSW graph on the fly during indexing - ASF JIRA  ↩︎ Elasticsearch 8.4 introduces a hybrid search by Mayya Sharipova Elasticsearch 8.4 introduces a hybrid search: ability to combine results from knn search with traditional search features (queries, aggs etc) and all this under a single familiar _search API. ↩︎\n https://www.elastic.co/guide/en/elasticsearch/reference/8.4/knn-search.html#_combine_approximate_knn_with_other_features ↩︎\n Elasticsearch で日本語検索を扱うためのマッピング定義 ZOZO TECH BLOG ↩︎\n   ","wordCount":"1185","inLanguage":"ja","image":"https://shunyaueta.com/posts/2022-10-29-2337/images/1.png","datePublished":"2022-10-29T23:37:35+09:00","dateModified":"2022-11-21T10:35:16+09:00","author":{"@type":"Person","name":"Shunya Ueta"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://shunyaueta.com/posts/2022-10-29-2337/"},"publisher":{"@type":"Organization","name":"🦅 hurutoriya","logo":{"@type":"ImageObject","url":"https://shunyaueta.com/favicon.ico"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><header class=header><nav class=nav><div class=logo><a href=https://shunyaueta.com/ accesskey=h title="🦅 hurutoriya (Alt + H)">🦅 hurutoriya</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://shunyaueta.com/archives title=Archive><span>Archive</span></a></li><li><a href=https://shunyaueta.com/about title=About><span>About</span></a></li><li><a href=https://shunyaueta.com/tags/newsletter/ title=Newsletter><span>Newsletter</span></a></li><li><a href=https://shunyaueta.com/index.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Elasticsearch 8.4 から利用可能な従来の検索機能と近似近傍探索を組み合わせたハイブリッド検索を試す</h1><div class=post-meta><span title="2022-10-29 23:37:35 +0900 +0900">October 29, 2022</span>&nbsp;·&nbsp;Shunya Ueta</div></header><figure class=entry-cover><img loading=lazy src=https://shunyaueta.com/posts/2022-10-29-2337/images/1.png alt=従来の検索結果、近似近傍探索、ハイブリッド検索の比較><p>従来の検索結果、近似近傍探索、ハイブリッド検索の比較</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目次</span></summary><div class=inner><ul><li><a href=#elascticsearch-8-%e3%81%a7%e5%b0%8e%e5%85%a5%e3%81%95%e3%82%8c%e3%81%9f%e8%bf%91%e4%bc%bc%e8%bf%91%e5%82%8d%e6%8e%a2%e7%b4%a2%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6 aria-label="Elascticsearch 8 で導入された近似近傍探索について">Elascticsearch 8 で導入された近似近傍探索について</a><ul><li><a href=#%e5%ac%89%e3%81%97%e3%81%84%e3%81%91%e3%81%a9%e7%89%a9%e8%b6%b3%e3%82%8a%e3%81%aa%e3%81%84%e7%82%b9 aria-label=嬉しいけど物足りない点>嬉しいけど物足りない点</a></li></ul></li><li><a href=#%e3%83%8f%e3%82%a4%e3%83%96%e3%83%aa%e3%83%83%e3%83%89%e6%a4%9c%e7%b4%a2 aria-label=ハイブリッド検索>ハイブリッド検索</a><ul><li><a href=#%e6%97%a5%e6%9c%ac%e8%aa%9e%e6%a4%9c%e7%b4%a2%e3%81%ae%e8%a8%ad%e5%ae%9a aria-label=日本語検索の設定>日本語検索の設定</a></li><li><a href=#%e7%b5%90%e6%9e%9c%e6%af%94%e8%bc%83 aria-label=結果比較>結果比較</a><ul><li><a href=#%e6%af%94%e8%bc%83%e5%af%be%e8%b1%a1 aria-label=比較対象>比較対象</a></li><li><a href=#%e3%82%af%e3%82%a8%e3%83%aa-ai aria-label="クエリ: AI">クエリ: <code>AI</code></a></li><li><a href=#%e3%82%af%e3%82%a8%e3%83%aa-%e3%82%ac%e3%83%aa%e3%83%90%e3%83%bc aria-label="クエリ: ガリバー">クエリ: <code>ガリバー</code></a></li></ul></li></ul></li><li><a href=#%e3%81%be%e3%81%a8%e3%82%81 aria-label=まとめ>まとめ</a></li></ul></div></details></div><div class=post-content><p>表題の通り、Elasticsearch 8.4 から待望の近似近傍探索と従来の検索を組み合わたハイブリッド検索が可能になったらしいので、試してみました。</p><h2 id=elascticsearch-8-で導入された近似近傍探索について>Elascticsearch 8 で導入された近似近傍探索について<a hidden class=anchor aria-hidden=true href=#elascticsearch-8-で導入された近似近傍探索について>#</a></h2><p>Elasticsearch 公式の記事<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>がわかりやすく近似近傍探索について語られています。
また、日本語では@pakio さんの紹介記事<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>も非常にわかりやすいので、そちらも御覧ください。</p><h3 id=嬉しいけど物足りない点>嬉しいけど物足りない点<a hidden class=anchor aria-hidden=true href=#嬉しいけど物足りない点>#</a></h3><p>公式の資料<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>や@pakio さんの資料でも触れられていますが、</p><blockquote><ul><li>You can’t currently use the Query DSL to filter documents for an approximate kNN search. If you need to filter the documents, consider using exact kNN instead.</li></ul></blockquote><p>Elasticsearch の Query DSL との併用不可というのが物足りない点でした。</p><p>端的に説明すると Elasticsearch 8 で利用可能になった近似近傍探索は、あくまでベクトル間のみの近似近傍探索のみできるのであって、従来の Elasticsearch の検索機能(term や filter)と近似近傍探索を組み合わせて検索できないということです。</p><p>Vespa の開発者の Jo さんも同様の点<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>について触れていました。</p><blockquote><p>The most surprising part of the announcement is that they won&rsquo;t allow combining the nearest neighbor search with standard query terms and filters. I think that will be disappointing for many who have been waiting for this feature. That concludes this thread, thoughts 👇🧵 5/5</p></blockquote><p>なぜならベクトルだけの素朴な近似近傍探索なら、正直ベクトル検索エンジンの<a href=https://qdrant.tech/>Qdrant</a>、<a href=https://milvus.io/>Milvus</a> 、<a href=https://github.com/vdaas/vald>Vald</a>でも事足ります。
検索エンジンの Elasticsearch に求められるのは、従来のフィルタリング機能と近似近傍探索を組み合わせたり、term による検索と近似近傍探索を組み合わせなど素朴な近似近傍探索では実現できない点を補える事ができれば近似近傍探索の実用可能性がグンと広がるので、ちょっと物足りないねというのが正直な感想でした。</p><p>それを実現するための関連するチケット<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>などはあったのでいつか実現してほしいなと思っていましたが、Linkedin の投稿で Elasticsearch のエンジニアの方が遂に実現できたよ!!と紹介しており<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup> 、早速試してみたいと思います。</p><p>2022/10/30 追記: <a href=https://www.elastic.co/guide/en/elasticsearch/reference/8.2/release-notes-8.2.0.html>Elasticsearch version 8.2.0 | Elasticsearch Guide [8.2] | Elastic</a> のリリースで</p><blockquote><p>Integrate filtering support for ANN #84734 (issue: #81788)</p></blockquote><p>と書かれており、ANN でのフィルタリングサポートは Elasticsearch 8.2 からサポートされていたみたいです。
なので正確には Elasticsearch 8.4 からは検索クエリが使えるようになったということですね。</p><h2 id=ハイブリッド検索>ハイブリッド検索<a hidden class=anchor aria-hidden=true href=#ハイブリッド検索>#</a></h2><p>Elasticsearch の公式ドキュメントはこちら<sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup></p><p>このドキュメントを基に、</p><ul><li>従来の検索機能</li><li>近似近傍探索のみによる検索結果</li><li>上記ふたつを組み合わせた検索結果</li></ul><p>を一画面で表示できる Web アプリを作ったので結果を比較してみたいと思います。</p><p>データやインデキシング自体は前回作成した、<a href=/posts/2022-10-23-2344/>Elasticsearch の近似近傍探索を使って、ドラえもんのひみつ道具検索エンジンを作ってみた</a>を基に今回もコードは全て公開しています。release tag は<code>v0.2</code> にしています。</p><p><a href=https://github.com/hurutoriya/doraemon-himitsu-dogu-search/releases/tag/v0.2.0>https://github.com/hurutoriya/doraemon-himitsu-dogu-search/releases/tag/v0.2.0</a></p><p>前回からの変更点を主に書いていきます。</p><h3 id=日本語検索の設定>日本語検索の設定<a hidden class=anchor aria-hidden=true href=#日本語検索の設定>#</a></h3><p>Docker ファイルで日本語用の analyzer である<code>kuromoji</code>を追加し</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-docker data-lang=docker><span class=k>FROM</span><span class=s> docker.elastic.co/elasticsearch/elasticsearch:8.4.3</span><span class=err>
</span><span class=err></span><span class=c># set the specific password for Elasticsearch</span><span class=err>
</span><span class=err></span><span class=k>RUN</span> <span class=nb>echo</span> <span class=s2>&#34;elastic&#34;</span> <span class=p>|</span> bin/elasticsearch-keystore add <span class=s2>&#34;bootstrap.password&#34;</span> -xf<span class=err>
</span><span class=err></span><span class=k>RUN</span> bin/elasticsearch-plugin install analysis-kuromoji<span class=err>
</span><span class=err></span><span class=k>RUN</span> bin/elasticsearch-plugin install analysis-icu<span class=err>
</span></code></pre></td></tr></table></div></div><p>Elasticsearch の mapping は zozo さんの記事<sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup>を参考にして以下のように書いてみました。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;settings&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;analysis&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;analyzer&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;custome_ja_analyzer&#34;</span><span class=p>:</span> <span class=p>{</span>
          <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;custom&#34;</span><span class=p>,</span>
          <span class=nt>&#34;char_filter&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;icu_normalizer&#34;</span><span class=p>],</span>
          <span class=nt>&#34;tokenizer&#34;</span><span class=p>:</span> <span class=s2>&#34;kuromoji_tokenizer&#34;</span><span class=p>,</span>
          <span class=nt>&#34;filter&#34;</span><span class=p>:</span> <span class=p>[</span>
            <span class=s2>&#34;kuromoji_baseform&#34;</span><span class=p>,</span>
            <span class=s2>&#34;kuromoji_part_of_speech&#34;</span><span class=p>,</span>
            <span class=s2>&#34;ja_stop&#34;</span><span class=p>,</span>
            <span class=s2>&#34;kuromoji_number&#34;</span><span class=p>,</span>
            <span class=s2>&#34;kuromoji_stemmer&#34;</span>
          <span class=p>]</span>
        <span class=p>}</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>},</span>
  <span class=nt>&#34;mappings&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;vector&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;dense_vector&#34;</span><span class=p>,</span>
        <span class=nt>&#34;dims&#34;</span><span class=p>:</span> <span class=mi>768</span><span class=p>,</span>
        <span class=nt>&#34;index&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
        <span class=nt>&#34;similarity&#34;</span><span class=p>:</span> <span class=s2>&#34;l2_norm&#34;</span>
      <span class=p>},</span>
      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span>
        <span class=nt>&#34;analyzer&#34;</span><span class=p>:</span> <span class=s2>&#34;custome_ja_analyzer&#34;</span>
      <span class=p>},</span>
      <span class=nt>&#34;yomi&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span>
        <span class=nt>&#34;analyzer&#34;</span><span class=p>:</span> <span class=s2>&#34;custome_ja_analyzer&#34;</span>
      <span class=p>},</span>
      <span class=nt>&#34;description&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span>
        <span class=nt>&#34;analyzer&#34;</span><span class=p>:</span> <span class=s2>&#34;custome_ja_analyzer&#34;</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>kuromoji のおかげで前処理を行わなくても、日本語で解析ができるようになります。</p><p>実際に起動してインデックスを構築した、Elasticsearch が動く Docker にリクエストを投げてみると、analyzer によって処理がされます。
検索時にはこれらの tokens が転置インデックス上で検索されます。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>curl --cacert http_ca.crt -u elastic:elastic -X POST <span class=s2>&#34;https://localhost:9200/himitsu_dogu/_analyze?pretty&#34;</span> -H <span class=s1>&#39;Content-Type: application/json&#39;</span> -d<span class=s1>&#39;{&#34;analyzer&#34;: &#34;custome_ja_analyzer&#34;,&#34;text&#34;:&#34;ドラえもんのひみつ道具はどこでもドア以外にもたくさん存在する&#34;}&#39;</span>
<span class=o>{</span>
  <span class=s2>&#34;tokens&#34;</span> : <span class=o>[</span>
    <span class=o>{</span>
      <span class=s2>&#34;token&#34;</span> : <span class=s2>&#34;ドラえもん&#34;</span>,
      <span class=s2>&#34;start_offset&#34;</span> : 0,
      <span class=s2>&#34;end_offset&#34;</span> : 5,
      <span class=s2>&#34;type&#34;</span> : <span class=s2>&#34;word&#34;</span>,
      <span class=s2>&#34;position&#34;</span> : <span class=m>0</span>
    <span class=o>}</span>,
    <span class=o>{</span>
      <span class=s2>&#34;token&#34;</span> : <span class=s2>&#34;ひむ&#34;</span>,
      <span class=s2>&#34;start_offset&#34;</span> : 6,
      <span class=s2>&#34;end_offset&#34;</span> : 8,
      <span class=s2>&#34;type&#34;</span> : <span class=s2>&#34;word&#34;</span>,
      <span class=s2>&#34;position&#34;</span> : <span class=m>2</span>
    <span class=o>}</span>,
    <span class=o>{</span>
      <span class=s2>&#34;token&#34;</span> : <span class=s2>&#34;道具&#34;</span>,
      <span class=s2>&#34;start_offset&#34;</span> : 9,
      <span class=s2>&#34;end_offset&#34;</span> : 11,
      <span class=s2>&#34;type&#34;</span> : <span class=s2>&#34;word&#34;</span>,
      <span class=s2>&#34;position&#34;</span> : <span class=m>4</span>
    <span class=o>}</span>,
    <span class=o>{</span>
      <span class=s2>&#34;token&#34;</span> : <span class=s2>&#34;どこ&#34;</span>,
      <span class=s2>&#34;start_offset&#34;</span> : 12,
      <span class=s2>&#34;end_offset&#34;</span> : 14,
      <span class=s2>&#34;type&#34;</span> : <span class=s2>&#34;word&#34;</span>,
      <span class=s2>&#34;position&#34;</span> : <span class=m>6</span>
    <span class=o>}</span>,
    <span class=o>{</span>
      <span class=s2>&#34;token&#34;</span> : <span class=s2>&#34;ドア&#34;</span>,
      <span class=s2>&#34;start_offset&#34;</span> : 16,
      <span class=s2>&#34;end_offset&#34;</span> : 18,
      <span class=s2>&#34;type&#34;</span> : <span class=s2>&#34;word&#34;</span>,
      <span class=s2>&#34;position&#34;</span> : <span class=m>8</span>
    <span class=o>}</span>,
    <span class=o>{</span>
      <span class=s2>&#34;token&#34;</span> : <span class=s2>&#34;以外&#34;</span>,
      <span class=s2>&#34;start_offset&#34;</span> : 18,
      <span class=s2>&#34;end_offset&#34;</span> : 20,
      <span class=s2>&#34;type&#34;</span> : <span class=s2>&#34;word&#34;</span>,
      <span class=s2>&#34;position&#34;</span> : <span class=m>9</span>
    <span class=o>}</span>,
    <span class=o>{</span>
      <span class=s2>&#34;token&#34;</span> : <span class=s2>&#34;たくさん&#34;</span>,
      <span class=s2>&#34;start_offset&#34;</span> : 22,
      <span class=s2>&#34;end_offset&#34;</span> : 26,
      <span class=s2>&#34;type&#34;</span> : <span class=s2>&#34;word&#34;</span>,
      <span class=s2>&#34;position&#34;</span> : <span class=m>12</span>
    <span class=o>}</span>,
    <span class=o>{</span>
      <span class=s2>&#34;token&#34;</span> : <span class=s2>&#34;存在&#34;</span>,
      <span class=s2>&#34;start_offset&#34;</span> : 26,
      <span class=s2>&#34;end_offset&#34;</span> : 28,
      <span class=s2>&#34;type&#34;</span> : <span class=s2>&#34;word&#34;</span>,
      <span class=s2>&#34;position&#34;</span> : <span class=m>13</span>
    <span class=o>}</span>
  <span class=o>]</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>実際に簡単な multi match query(複数フィールドでの一致検索)の結果はこちら</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ curl --cacert http_ca.crt -u elastic:elastic -X POST <span class=s2>&#34;https://localhost:9200/himitsu_dogu/_search?pretty&#34;</span> -H <span class=s1>&#39;Content-Type: application/json&#39;</span> -d<span class=s1>&#39;{&#34;size&#34;: 1, &#34;query&#34;: {&#34;multi_match&#34; : {&#34;query&#34;:&#34;どこでもドア&#34;, &#34;fields&#34;: [ &#34;name&#34;, &#34;description&#34; ] }}}&#39;</span>

<span class=o>{</span>
  <span class=s2>&#34;took&#34;</span> : 2,
  <span class=s2>&#34;timed_out&#34;</span> : false,
  <span class=s2>&#34;_shards&#34;</span> : <span class=o>{</span>
    <span class=s2>&#34;total&#34;</span> : 1,
    <span class=s2>&#34;successful&#34;</span> : 1,
    <span class=s2>&#34;skipped&#34;</span> : 0,
    <span class=s2>&#34;failed&#34;</span> : <span class=m>0</span>
  <span class=o>}</span>,
  <span class=s2>&#34;hits&#34;</span> : <span class=o>{</span>
    <span class=s2>&#34;total&#34;</span> : <span class=o>{</span>
      <span class=s2>&#34;value&#34;</span> : 44,
      <span class=s2>&#34;relation&#34;</span> : <span class=s2>&#34;eq&#34;</span>
    <span class=o>}</span>,
    <span class=s2>&#34;max_score&#34;</span> : 11.774845,
    <span class=s2>&#34;hits&#34;</span> : <span class=o>[</span>
      <span class=o>{</span>
        <span class=s2>&#34;_index&#34;</span> : <span class=s2>&#34;himitsu_dogu&#34;</span>,
        <span class=s2>&#34;_id&#34;</span> : <span class=s2>&#34;816&#34;</span>,
        <span class=s2>&#34;_score&#34;</span> : 11.774845,
        <span class=s2>&#34;_source&#34;</span> : <span class=o>{</span>
          <span class=s2>&#34;id&#34;</span> : 816,
          <span class=s2>&#34;name&#34;</span> : <span class=s2>&#34;どこでもドア&#34;</span>,
          <span class=s2>&#34;yomi&#34;</span> : <span class=s2>&#34;どこでもどあ&#34;</span>,
          <span class=s2>&#34;description&#34;</span> : <span class=s2>&#34;このドアを開けるだけで、行きたいところへ、どこへでも行くことができる。&#34;</span>,
          <span class=s2>&#34;vector&#34;</span> : <span class=o>[</span>
            -0.23546676337718964,
            ...
            -0.37538981437683105
          <span class=o>]</span>
        <span class=o>}</span>
      <span class=o>}</span>
    <span class=o>]</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>これで、Elasticsearch で日本語検索が問題なく出来ていることが確認できたので、ハイブリッド検索についての説明に</p><h3 id=結果比較>結果比較<a hidden class=anchor aria-hidden=true href=#結果比較>#</a></h3><h4 id=比較対象>比較対象<a hidden class=anchor aria-hidden=true href=#比較対象>#</a></h4><p><code>multi match query</code>, <code>ANN</code>, <code>multi match</code> + <code>ANN</code> の三種類のクエリで検索結果を定性的に比較します。
Python 上ではクエリは以下のような形式で書いてみました。<code>TOP_K</code>は 10 で、<code>keyword</code>は入力クエリです。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>multimatch_query</span><span class=p>:</span> <span class=nb>dict</span> <span class=o>=</span> <span class=p>{</span>
		<span class=s2>&#34;size&#34;</span><span class=p>:</span> <span class=n>TOP_K</span><span class=p>,</span>
		<span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;multi_match&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=n>keyword</span><span class=p>,</span> <span class=s2>&#34;fields&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>,</span> <span class=s2>&#34;description&#34;</span><span class=p>]}},</span>
<span class=p>}</span>
<span class=n>ann_query</span><span class=p>:</span> <span class=nb>dict</span> <span class=o>=</span> <span class=p>{</span>
		<span class=s2>&#34;knn&#34;</span><span class=p>:</span> <span class=p>{</span>
				<span class=s2>&#34;field&#34;</span><span class=p>:</span> <span class=s2>&#34;vector&#34;</span><span class=p>,</span>
				<span class=s2>&#34;query_vector&#34;</span><span class=p>:</span> <span class=n>sentence_embeddings</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
				<span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=n>TOP_K</span><span class=p>,</span>
				<span class=s2>&#34;num_candidates&#34;</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>
		<span class=p>}</span>
<span class=p>}</span>
<span class=c1># NOTE: score = match score + ANN score</span>
<span class=n>hybrid_query</span><span class=p>:</span> <span class=nb>dict</span> <span class=o>=</span> <span class=p>{</span>
		<span class=s2>&#34;size&#34;</span><span class=p>:</span> <span class=n>TOP_K</span><span class=p>,</span>
		<span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;multi_match&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;query&#34;</span><span class=p>:</span><span class=n>keyword</span><span class=p>,</span> <span class=s2>&#34;fields&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>,</span> <span class=s2>&#34;description&#34;</span><span class=p>]}},</span>
		<span class=s2>&#34;knn&#34;</span><span class=p>:</span> <span class=p>{</span>
				<span class=s2>&#34;field&#34;</span><span class=p>:</span> <span class=s2>&#34;vector&#34;</span><span class=p>,</span>
				<span class=s2>&#34;query_vector&#34;</span><span class=p>:</span> <span class=n>sentence_embeddings</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
				<span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=n>TOP_K</span><span class=p>,</span>
				<span class=s2>&#34;num_candidates&#34;</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>
		<span class=p>},</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><ul><li><code>multimatch_query</code>: ひみつ道具の名前と説明文の複数フィールドでマッチするドキュメントを検索する</li><li><code>ann_query</code>: ひみつ道具の名前と説明文を空白区切りで結合された文章を<code>JapaneseSententsBERT</code> でベクトル化し、近似近傍探索を行う</li><li><code>hybrid_query</code>: 上記２つのクエリのスコアを足し合わせた結果(<code>match score</code> + <code>ANN score</code>)を検索結果として返す。<ul><li>公式ドキュメントでは、<code>boost</code>を使うことで係数を書けて調整する方法も紹介されています。</li></ul></li></ul><p>実際にデモアプリの Streamlit 上では、上記３つのクエリの検索結果が side by side で比較できるようにしてみました。
これで、各検索手法で結果がどう異なっているか一目瞭然ですね。</p><p><img loading=lazy src=/posts/2022-10-29-2337/images/1.png alt="streamlit side by side result"></p><p>Streamlit で得られた結果を表として以下にまとめました。</p><h4 id=クエリ-ai>クエリ: <code>AI</code><a hidden class=anchor aria-hidden=true href=#クエリ-ai>#</a></h4><table><thead><tr><th><code>multi mach</code></th><th>スコア</th><th>ひみつ道具の名前</th><th>説明</th><th><code>ANN</code></th><th>スコア</th><th>ひみつ道具の名前</th><th>説明</th><th><code>hybrid(match score + ANN score</code></th><th>スコア</th><th>ひみつ道具の名前</th><th>説明</th></tr></thead><tbody><tr><td>1</td><td>5.3606</td><td>エーアイアイ</td><td>高性能（せいのう）の AI（エーアイ／人工知能）が搭載（とうさい）されているサル型ロボット。一から教えてあげると、なんでも自分で考えて行動する。</td><td>1</td><td>0.0027</td><td>なんでもデリバリーバックパック</td><td>デリバリー（配達）用のひみつ道具。中は四次元になっているため、いくらでも配達品を入れることができ、ゆれてもこわれることなく運べる。大きなポケットには、目的地まで自動運転してくれ、ひとこぎで１０メートル進む自転車が入っている。運転しながら食べたり飲んだりできる装置（そうち）も付いており、雨がふれば自動でカサもさしてくれる。</td><td>1</td><td>5.3606</td><td>エーアイアイ</td><td>高性能（せいのう）の AI（エーアイ／人工知能）が搭載（とうさい）されているサル型ロボット。一から教えてあげると、なんでも自分で考えて行動する。</td></tr><tr><td></td><td></td><td></td><td></td><td>2</td><td>0.0027</td><td>なりきりケイドロセット</td><td>本格的なおにごっこが楽しめる未来の遊び道具。通信もできる警察（けいさつ）手帳型のバッジや『強力におい追跡鼻（ついせきばな）』、身につけると体力が三割増しになる『泥棒風呂敷（どろぼうふろしき）』、『牢屋（ろうや）シール』などが入っている。</td><td>2</td><td>0.0027</td><td>なんでもデリバリーバックパック</td><td>デリバリー（配達）用のひみつ道具。中は四次元になっているため、いくらでも配達品を入れることができ、ゆれてもこわれることなく運べる。大きなポケットには、目的地まで自動運転してくれ、ひとこぎで１０メートル進む自転車が入っている。運転しながら食べたり飲んだりできる装置（そうち）も付いており、雨がふれば自動でカサもさしてくれる。</td></tr><tr><td></td><td></td><td></td><td></td><td>3</td><td>0.0026</td><td>地下工事マシン</td><td>この機械に設計図を描いた設計紙を入れ、コンクリートボンベを乗せてバルブを開くと、その設計図通りの空間を地下に作ってくれる。</td><td>3</td><td>0.0027</td><td>なりきりケイドロセット</td><td>本格的なおにごっこが楽しめる未来の遊び道具。通信もできる警察（けいさつ）手帳型のバッジや『強力におい追跡鼻（ついせきばな）』、身につけると体力が三割増しになる『泥棒風呂敷（どろぼうふろしき）』、『牢屋（ろうや）シール』などが入っている。</td></tr><tr><td></td><td></td><td></td><td></td><td>4</td><td>0.0026</td><td>ミチサキステッキ</td><td>どちらの道を進めばいいか迷ったときに使う道具。正しい道の方向に倒れて、道を教えてくれる。</td><td>4</td><td>0.0026</td><td>地下工事マシン</td><td>この機械に設計図を描いた設計紙を入れ、コンクリートボンベを乗せてバルブを開くと、その設計図通りの空間を地下に作ってくれる。</td></tr><tr><td></td><td></td><td></td><td></td><td>5</td><td>0.0026</td><td>ウラオモテックス</td><td>これを体に貼ると、裏でコソコソやっていたことや心の中で思っていることを、みんなの前で大っぴらにやってしまう。</td><td>5</td><td>0.0026</td><td>ミチサキステッキ</td><td>どちらの道を進めばいいか迷ったときに使う道具。正しい道の方向に倒れて、道を教えてくれる。</td></tr><tr><td></td><td></td><td></td><td></td><td>6</td><td>0.0026</td><td>かべ景色きりかえ機</td><td>かべを通して、どこの景色でも見ることができる。実際（じっさい）にうつし出した場所とつながるので、かべから出入りもできるようになる。</td><td>6</td><td>0.0026</td><td>ウラオモテックス</td><td>これを体に貼ると、裏でコソコソやっていたことや心の中で思っていることを、みんなの前で大っぴらにやってしまう。</td></tr><tr><td></td><td></td><td></td><td></td><td>7</td><td>0.0026</td><td>クロマキーセット</td><td>グリーンバックやブルーバックを背景（はいけい）にして、セットのカメラで撮影（さつえい）すると、映（うつ）したものを実際（じっさい）の景色にはめこむことができる。</td><td>7</td><td>0.0026</td><td>かべ景色きりかえ機</td><td>かべを通して、どこの景色でも見ることができる。実際（じっさい）にうつし出した場所とつながるので、かべから出入りもできるようになる。</td></tr><tr><td></td><td></td><td></td><td></td><td>8</td><td>0.0026</td><td>断層ビジョン</td><td>地中や機械の内部、人間の体の中など、外から見えないところを画面に映し出し、調べることができる。映し出したところに付属の旗を立てると、実際のその場所にも旗が立ち、目印になる。</td><td>8</td><td>0.0026</td><td>クロマキーセット</td><td>グリーンバックやブルーバックを背景（はいけい）にして、セットのカメラで撮影（さつえい）すると、映（うつ）したものを実際（じっさい）の景色にはめこむことができる。</td></tr><tr><td></td><td></td><td></td><td></td><td>9</td><td>0.0026</td><td>ゆっくり反射ぞうきん</td><td>このぞうきんで鏡やガラスを拭くと過去が映る。拭けば拭くほど、映る時間が過去に戻っていく。</td><td>9</td><td>0.0026</td><td>断層ビジョン</td><td>地中や機械の内部、人間の体の中など、外から見えないところを画面に映し出し、調べることができる。映し出したところに付属の旗を立てると、実際のその場所にも旗が立ち、目印になる。</td></tr><tr><td></td><td></td><td></td><td></td><td>10</td><td>0.0026</td><td>とうしめがね</td><td>ムシめがねのようだが、これをつかってモノを見ると、中のようすがすけて見える。</td><td>10</td><td>0.0026</td><td>ゆっくり反射ぞうきん</td><td>このぞうきんで鏡やガラスを拭くと過去が映る。拭けば拭くほど、映る時間が過去に戻っていく。</td></tr></tbody></table><p><code>ANN</code>では検索対象になっていなかった秘密道具である「エーアイアイ」を<code>multi match</code>クエリでは検索できており、ハイブリッド検索によって<code>multi match</code>と<code>ANN</code>がお互いを補うあうことで、主観的な評価ですが、検索結果になっていることが分かります。</p><h4 id=クエリ-ガリバー>クエリ: <code>ガリバー</code><a hidden class=anchor aria-hidden=true href=#クエリ-ガリバー>#</a></h4><table><thead><tr><th><code>multi match</code></th><th>スコア</th><th>ひみつ道具の名前</th><th>説明</th><th><code>ANN</code></th><th>スコア</th><th>ひみつ道具の名前</th><th>説明</th><th><code>hybrid(match score + ANN score</code></th><th>スコア</th><th>ひみつ道具の名前</th><th>説明</th></tr></thead><tbody><tr><td>1</td><td>6.9183</td><td>ガリバートンネル</td><td>大きな入り口から入って、小さな出口から出ると、からだが小さくなるトンネル。逆にくぐりぬけると、もとに戻る。</td><td>1</td><td>0.0029</td><td>ガリバーロープ</td><td>巨大なものをかんたんにしばりつけることができるロープ。</td><td>1</td><td>6.9211</td><td>ガリバーロープ</td><td>巨大なものをかんたんにしばりつけることができるロープ。</td></tr><tr><td>2</td><td>6.9183</td><td>ガリバーロープ</td><td>巨大なものをかんたんにしばりつけることができるロープ。</td><td>2</td><td>0.0027</td><td>なりきりケイドロセット</td><td>本格的なおにごっこが楽しめる未来の遊び道具。通信もできる警察（けいさつ）手帳型のバッジや『強力におい追跡鼻（ついせきばな）』、身につけると体力が三割増しになる『泥棒風呂敷（どろぼうふろしき）』、『牢屋（ろうや）シール』などが入っている。</td><td>2</td><td>6.9183</td><td>ガリバートンネル</td><td>大きな入り口から入って、小さな出口から出ると、からだが小さくなるトンネル。逆にくぐりぬけると、もとに戻る。</td></tr><tr><td>3</td><td>5.8304</td><td>箱庭シリーズ 湖</td><td>大自然のミニチュアシリーズのひとつ。スモールライトやガリバートンネルで小さくなれば、この中で遊ぶことができる。</td><td>3</td><td>0.0027</td><td>スーパーダンごっこふろしき</td><td>未来の子どもたちがスーパーヒーローごっこで使うオモチャのふろしき。これを身につけると、低空ながら飛ぶことができ、空気銃の弾（たま）もはね返し、ものを透（す）かして見ることもできる。</td><td>3</td><td>5.8304</td><td>箱庭シリーズ 湖</td><td>大自然のミニチュアシリーズのひとつ。スモールライトやガリバートンネルで小さくなれば、この中で遊ぶことができる。</td></tr><tr><td>4</td><td>4.6887</td><td>ミニハウス</td><td>エネルギーのムダをはぶくために作られた、ミニハウス。乾電池一本でクーラーや冷蔵庫などの家電製品をすべて動かすことができる。ガリバートンネルで小さくなって使う。</td><td>4</td><td>0.0026</td><td>ゴキブリトレとれビッグ</td><td>ゴキブリをとる道具を、人間用に大きくしたもの。入ったら最後、ねんちゃくシートにつかまってしまう。</td><td>4</td><td>4.6887</td><td>ミニハウス</td><td>エネルギーのムダをはぶくために作られた、ミニハウス。乾電池一本でクーラーや冷蔵庫などの家電製品をすべて動かすことができる。ガリバートンネルで小さくなって使う。</td></tr><tr><td>5</td><td>4.5612</td><td>ムシムシ操縦ハンドル</td><td>このハンドルを自分が乗りたい虫に向けて、真ん中のボタンを押すと、その虫の背中にハンドルがくっつき、背中に乗って操縦することができる。ただし、ガリバートンネルなどで身体を小さくしてから使う。</td><td>5</td><td>0.0026</td><td>実景ひきよせ額縁</td><td>額縁の横にあるダイヤルを回すと、海でも雪山でもジャングルでも、実際にある景色をひきよせることができる。額縁のガラスを外してくぐれば、その景色の場所に行くこともできる。</td><td>5</td><td>4.5612</td><td>ムシムシ操縦ハンドル</td><td>このハンドルを自分が乗りたい虫に向けて、真ん中のボタンを押すと、その虫の背中にハンドルがくっつき、背中に乗って操縦することができる。ただし、ガリバートンネルなどで身体を小さくしてから使う。</td></tr><tr><td></td><td></td><td></td><td></td><td>6</td><td>0.0026</td><td>ぼんのうボウシ</td><td>これを頭にかぶると、その人の煩悩（ぼんのう）が雲のようなものに映像（えいぞう）となってうかび上がり、釣鐘（つりがね）のかたちにまとまる。それを撞木（しゅもく）型のハンマーでたたくと、それらの煩悩が追い払（はら）われる。</td><td>6</td><td>0.0027</td><td>なりきりケイドロセット</td><td>本格的なおにごっこが楽しめる未来の遊び道具。通信もできる警察（けいさつ）手帳型のバッジや『強力におい追跡鼻（ついせきばな）』、身につけると体力が三割増しになる『泥棒風呂敷（どろぼうふろしき）』、『牢屋（ろうや）シール』などが入っている。</td></tr><tr><td></td><td></td><td></td><td></td><td>7</td><td>0.0025</td><td>ねがい七夕ロケット</td><td>専用（せんよう）の短冊（たんざく）に願いごとを書いて笹（ささ）につけ、笹ごとロケットで宇宙（うちゅう）に飛ばすと、一年間その願いごとをかなえてくれる。短冊に書いたことと反対のことがかなう「うら七夕ロケット」もある。 【うら七夕ロケット】 専用（せんよう）の短冊（たんざく）に願いごとを書いて笹（ささ）につけ、笹ごとロケットで宇宙（うちゅう）に飛ばすと、一年間、短冊に書いたことと反対のことがかなう。</td><td>7</td><td>0.0027</td><td>スーパーダンごっこふろしき</td><td>未来の子どもたちがスーパーヒーローごっこで使うオモチャのふろしき。これを身につけると、低空ながら飛ぶことができ、空気銃の弾（たま）もはね返し、ものを透（す）かして見ることもできる。</td></tr><tr><td></td><td></td><td></td><td></td><td>8</td><td>0.0025</td><td>フエルミラー</td><td>増やしたいものをこのカガミにうつすと、本物になって出てくる。</td><td>8</td><td>0.0026</td><td>ゴキブリトレとれビッグ</td><td>ゴキブリをとる道具を、人間用に大きくしたもの。入ったら最後、ねんちゃくシートにつかまってしまう。</td></tr><tr><td></td><td></td><td></td><td></td><td>9</td><td>0.0025</td><td>ふわふわぐすり</td><td>これを口に入れると、体の中にガスができて、空気より軽くなるため、空を歩いたり、飛んだりすることができる。</td><td>9</td><td>0.0026</td><td>実景ひきよせ額縁</td><td>額縁の横にあるダイヤルを回すと、海でも雪山でもジャングルでも、実際にある景色をひきよせることができる。額縁のガラスを外してくぐれば、その景色の場所に行くこともできる。</td></tr><tr><td></td><td></td><td></td><td></td><td>10</td><td>0.0025</td><td>乗りものぐつ</td><td>これに両足を入れてボタンを押すと、車やジェット機、潜水艦（せんすいかん）など、いろいろな乗りものになる。</td><td>10</td><td>0.0026</td><td>ぼんのうボウシ</td><td>これを頭にかぶると、その人の煩悩（ぼんのう）が雲のようなものに映像（えいぞう）となってうかび上がり、釣鐘（つりがね）のかたちにまとまる。それを撞木（しゅもく）型のハンマーでたたくと、それらの煩悩が追い払（はら）われる。</td></tr></tbody></table><p><code>multi match</code>クエリでは、「ガリバー」とう単語が全てマッチし検索結果としては申し分ありません。
<code>ANN</code>は「ガリバー」というクエリによって、「ガリバーロープ」はヒットしていますが「ガリバートンネル」はなぜか出てきていません。
ハイブリッド検索によって、上位 5 個は<code>multi match</code>クエリによる適合率(precision)が高いひみつ道具がランク付けされ、その後 ANN の結果が混ざってきています。正直「ガリバー」という単語から想起するようなひみつ道具とはあまり感じませんが、特徴ベクトルの閾値などで上手く枝刈りさえしておけば、質は担保しつつ多様性のある結果が確保できそうです。</p><p>実際はこんなに単純な <code>multi match</code>計算ではなく、BM25 で計算されたスコアを導入したりなど工夫すべき点は多々ありますが、ハイブリッド検索の可能性を感じることができました。</p><p>特徴ベクトルのチューニングや、既存のクエリとの組み合わせるためのチューニングなどやることは増えそうですが、これは夢が広がりますね。
実際にはスコアを組み合わせたりするのもそうですが、ANN の結果にフィルタリングするほうが実務的には簡単に役立つことが多そうな気がしました。</p><p>たとえば、特定のカテゴリ内で ANN するだけでも、 「この商品に見た目が似ている商品はこちらです」を提示する際に画像としては似ているが商品としては全く違う商品(iPhone と iPhone ケースなど)を分けるのも簡単にできちゃいますしね。</p><h2 id=まとめ>まとめ<a hidden class=anchor aria-hidden=true href=#まとめ>#</a></h2><p>このハイブリッド検索によって近似近傍探索のスコアと従来の検索結果のスコアをかけあわせたり、フィルタリングしたりなど真の意味で近似近傍探索が Elasticsearch で活用可能になったのではないのでしょうか？</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://www.elastic.co/jp/blog/introducing-approximate-nearest-neighbor-search-in-elasticsearch-8-0>Introducing approximate nearest neighbor search in Elasticsearch 8.0 | Elastic Blog</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=https://speakerdeck.com/pakio/how-knn-search-changed-in-the-elasticsearch-8-dot-0>8.0 からの kNN はどう変わったのか / How kNN search changed in the Elasticsearch 8.0 - Speaker Deck</a> <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p><a href=https://www.elastic.co/guide/en/elasticsearch/reference/8.0/knn-search.html#approximate-knn-limitations>k-nearest neighbor (kNN) search | Elasticsearch Guide [8.0] | Elastic</a> <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p><a href=https://twitter.com/jobergum/status/1491366596665016321>https://twitter.com/jobergum/status/1491366596665016321</a> Jo さんの皮肉な検索エンジン批評は自分の中で名物になっている <a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5 role=doc-endnote><ul><li><a href=https://issues.apache.org/jira/browse/LUCENE-10318>[LUCENE-10318] Reuse HNSW graphs when merging segments? - ASF JIRA</a></li><li><a href=https://issues.apache.org/jira/browse/LUCENE-10382>[LUCENE-10382] Allow KnnVectorQuery to operate over a subset of liveDocs - ASF JIRA</a></li><li><a href=https://issues.apache.org/jira/browse/LUCENE-10592>[LUCENE-10592] Should we build HNSW graph on the fly during indexing - ASF JIRA</a></li></ul><a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></li><li id=fn:6 role=doc-endnote><p><a href=https://www.linkedin.com/posts/mayya-sharipova-a40a0256_k-nearest-neighbor-knn-search-edit-activity-6970855618479865857-oLqB/>Elasticsearch 8.4 introduces a hybrid search by Mayya Sharipova</a> Elasticsearch 8.4 introduces a hybrid search: ability to combine results from knn search with traditional search features (queries, aggs etc) and all this under a single familiar _search API. <a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7 role=doc-endnote><p><a href=https://www.elastic.co/guide/en/elasticsearch/reference/8.4/knn-search.html#_combine_approximate_knn_with_other_features>https://www.elastic.co/guide/en/elasticsearch/reference/8.4/knn-search.html#_combine_approximate_knn_with_other_features</a> <a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:8 role=doc-endnote><p><a href=https://techblog.zozo.com/entry/elasticsearch-mapping-config-for-japanese-search>Elasticsearch で日本語検索を扱うためのマッピング定義 ZOZO TECH BLOG</a> <a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section><h2>See Also</h2><ul><li><a href=/posts/2022-10-23-2344/>Elasticsearchの近似近傍探索を使って、ドラえもんのひみつ道具検索エンジンを作ってみた</a></li><li><a href=/posts/2022-09-08-1722/>Search Engineering Newsletter vol.10</a></li><li><a href=/posts/2022-08-24-2314/>Search Engineering Newsletter vol.09</a></li><li><a href=/posts/2022-07-15-1045/>Search Engineering Newsletter vol.08</a></li><li><a href=/posts/2022-06-10-1135/>Search Engineering Newsletter vol.07</a></li></ul><h2>Support</h2>記事をお読みくださりありがとうございます。このウェブサイトの運営を支援していただける方を募集しています。
もしよろしければ、下のボタンからサポート(投げ銭)していただけると、ブログ執筆、情報発信のモチベーションに繋がります✨
<a href=https://www.buymeacoffee.com/hurutoriya><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&emoji=☕&slug=hurutoriya&button_colour=FFDD00&font_colour=000000&font_family=Inter&outline_colour=000000&coffee_colour=ffffff"></a></div><footer class=post-footer><ul class=post-tags><li><a href=https://shunyaueta.com/tags/search/>search</a></li><li><a href=https://shunyaueta.com/tags/elasticsearch/>Elasticsearch</a></li></ul><nav class=paginav><a class=prev href=https://shunyaueta.com/posts/2022-10-30-2257/><span class=title>« 前のページ</span><br><span>Search Engineering Newsletter vol.11</span></a>
<a class=next href=https://shunyaueta.com/posts/2022-10-23-2344/><span class=title>次のページ »</span><br><span>Elasticsearchの近似近傍探索を使って、ドラえもんのひみつ道具検索エンジンを作ってみた</span></a></nav></footer><script src=https://giscus.app/client.js data-repo=hurutoriya/hurutoriya.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk2MDgyNTY1Nw==" data-category=Comments data-category-id=DIC_kwDOA6AgOc4CAQTX data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-theme=dark data-lang=ja crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://shunyaueta.com/>🦅 hurutoriya</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z" /></svg></a><script>let menu=document.getElementById('menu')
if(menu){menu.scrollLeft=localStorage.getItem("menu-scroll-position");menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft);}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.pushState(null,null,`#${id}`);}});});</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script><script>document.querySelectorAll('pre > code').forEach((codeblock)=>{const container=codeblock.parentNode.parentNode;const copybutton=document.createElement('button');copybutton.classList.add('copy-code');copybutton.innerHTML='コピー';function copyingDone(){copybutton.innerHTML='コピーされました!';setTimeout(()=>{copybutton.innerHTML='コピー';},2000);}
copybutton.addEventListener('click',(cb)=>{if('clipboard'in navigator){navigator.clipboard.writeText(codeblock.textContent);copyingDone();return;}
const range=document.createRange();range.selectNodeContents(codeblock);const selection=window.getSelection();selection.removeAllRanges();selection.addRange(range);try{document.execCommand('copy');copyingDone();}catch(e){};selection.removeRange(range);});if(container.classList.contains("highlight")){container.appendChild(copybutton);}else if(container.parentNode.firstChild==container){}else if(codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"){codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);}else{codeblock.parentNode.appendChild(copybutton);}});</script></body></html>